<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- どのマッパーインターフェースと対応するかを指定する -->
<!-- @reamsid_L DBE-0170-010 wangkun -->

<mapper namespace="jp.co.ndensan.reams.db.dbe.persistence.db.mapper.relate.shinsakaitoroku.IShinsakaiTorokuMapper">
    <select resultOrdered="true" id="get審査会登録" resultMap="resultMap_ShinsakaiTorokuRelateEntity" 
            parameterType="jp.co.ndensan.reams.db.dbz.definition.mybatisprm.yokaigoninteitasklist.YokaigoNinteiTaskListParameter" fetchSize="500">
        SELECT
            CASE WHEN 
            DbT5123."ninteiShinsakaiWariateYoteiYMD" <![CDATA[<]]> #{処理日}
            THEN TRUE
            ELSE FALSE
            END AS delay,
            DbT5101."shinseishoKanriNo",
            DbT5101."shoKisaiHokenshaNo",
            DbT5101."hihokenshaNo",
            DbT5101."hihokenshaName",
            DbT5101."ninteiShinseiShinseijiKubunCode",
            DbT5101."ninteiShinseiHoreiKubunCode",
            DbT5101."ninteiShinseiYMD",
            DbT5101."shinsakaiYusenWaritsukeKubunCode",
            DbT7051."shichosonMeisho",
            DbT5105."ninteichosaKanryoYMD",
            DbT5105."ikenshoTorokuKanryoYMD",
            DbT5105."maskingKanryoYMD",
            DbT5105."ninteiShinsakaiKanryoYMD",
            DbT5105."ninteiShinsakaiWariateKanryoYMD",
        <if test="状態区分 != 1" >
            DbT5501."shinsakaiKaisaiYoteiYMD",
            DbT5501."shinsakaiKaishiYoteiTime",
            DbT5501."shinsakaiKaisaiNo",
            DbT5501."gogitaiNo",
            DbT5502."shinsakaiWariateYMD",
            DbT5502."shinsakaiOrder",
            DbT5591."gogitaiMei",
        </if>
        <if test="状態区分 == 1" >
            NULL AS "shinsakaiKaisaiYoteiYMD",
            NULL AS "shinsakaiKaishiYoteiTime",
            NULL AS "shinsakaiKaisaiNo",
            NULL AS "gogitaiNo",
            NULL AS "shinsakaiWariateYMD",
            NULL AS "shinsakaiOrder",
            NULL AS "gogitaiMei",
        </if>
            DbT5105.*
        FROM
            rgdb."DbT5101NinteiShinseiJoho" DbT5101
            INNER  JOIN  rgdb."DbT7051KoseiShichosonMaster" DbT7051
                ON  DbT7051."shoKisaiHokenshaNo" = DbT5101."shoKisaiHokenshaNo"
            INNER  JOIN  rgdb."DbT5105NinteiKanryoJoho" DbT5105
                ON  DbT5105."shinseishoKanriNo" = DbT5101."shinseishoKanriNo"
        <if test="状態区分 != 1" >
            <if test="状態区分 == 2" >
                INNER   JOIN  rgdb."DbT5502ShinsakaiWariateJoho" DbT5502
            </if>
            <if test="状態区分 == 3" >
                LEFT   JOIN  rgdb."DbT5502ShinsakaiWariateJoho" DbT5502
            </if>
                ON  DbT5502."shinseishoKanriNo" = DbT5101."shinseishoKanriNo"
                AND (DbT5502."hanteiKekkaCode" IS NULL
                OR DbT5502."hanteiKekkaCode" = '')
            LEFT   JOIN  rgdb."DbT5501ShinsakaiKaisaiYoteiJoho" DbT5501
                ON  DbT5501."shinsakaiKaisaiNo" = DbT5502."shinsakaiKaisaiNo"
            LEFT   JOIN  rgdb."DbT5591GogitaiJoho" DbT5591
                ON DbT5591."gogitaiNo" = DbT5501."gogitaiNo"
                AND DbT5591."gogitaiYukoKikanKaishiYMD" <![CDATA[<=]]>  DbT5501."shinsakaiKaisaiYoteiYMD"
                AND DbT5591."gogitaiYukoKikanShuryoYMD" <![CDATA[>=]]>  DbT5501."shinsakaiKaisaiYoteiYMD"
        </if>
            LEFT JOIN rgdb."DbT5123NinteiKeikakuJoho" DbT5123
            ON DbT5101."shinseishoKanriNo" = DbT5123."shinseishoKanriNo"
        WHERE
                (DbT5105."ninteiShinseiJohoTorokuKanryoYMD" IS NOT NULL
            AND DbT5105."ninteiShinseiJohoTorokuKanryoYMD" <![CDATA[<>]]> '')
            AND (DbT5105."ninteichosaIraiKanryoYMD" IS NOT NULL
            AND DbT5105."ninteichosaIraiKanryoYMD" <![CDATA[<>]]> '')
            AND (DbT5105."ninteichosaKanryoYMD" IS NOT NULL
            AND DbT5105."ninteichosaKanryoYMD" <![CDATA[<>]]> '')
            AND (DbT5105."ikenshoSakuseiIraiKanryoYMD" IS NOT NULL
            AND DbT5105."ikenshoSakuseiIraiKanryoYMD" <![CDATA[<>]]> '')
            AND (DbT5105."ikenshoTorokuKanryoYMD" IS NOT NULL
            AND DbT5105."ikenshoTorokuKanryoYMD" <![CDATA[<>]]> '')
            AND (DbT5105."ichijiHanteiKanryoYMD" IS NOT NULL
            AND DbT5105."ichijiHanteiKanryoYMD" <![CDATA[<>]]> '')
        <if test="isItijiHannteiAto">
            AND (DbT5105."maskingKanryoYMD" IS NOT NULL
            AND DbT5105."maskingKanryoYMD" <![CDATA[<>]]> '')
        </if>
            AND (DbT5105."ninteiShinsakaiWariateKanryoYMD" IS NULL
            OR DbT5105."ninteiShinsakaiWariateKanryoYMD" = '')
            AND (DbT5105."ninteiShinsakaiKanryoYMD" IS NULL
            OR  DbT5105."ninteiShinsakaiKanryoYMD" = '')
            AND (DbT5105."centerSoshinYMD" IS NULL
            OR  DbT5105."centerSoshinYMD" = '')
            AND DbT5101."shoriJotaiKubun" in (#{通常},#{延期})
            AND DbT5101."logicalDeletedFlag" = FALSE
        <if test="状態区分 == 1" >
            AND NOT EXISTS(
            SELECT
            *
            FROM
            rgdb."DbT5502ShinsakaiWariateJoho" AS DbT5502
            WHERE
            (
            DbT5502."hanteiKekkaCode" = '01'
            OR DbT5502."hanteiKekkaCode" IS NULL
            OR DbT5502."hanteiKekkaCode" = ''
            )
            AND
            DbT5105."shinseishoKanriNo" = DbT5502."shinseishoKanriNo"
            )
        </if>
        <if test="状態区分 == 2" >
            AND (DbT5502."shinsakaiWariateYMD" is NOT NULL
            AND  DbT5502."shinsakaiWariateYMD" <![CDATA[<>]]> '')
        </if>
        <if test="状態区分 == 3" >
            AND NOT EXISTS(
            SELECT
            *
            FROM
            rgdb."DbT5502ShinsakaiWariateJoho" AS DbT5502
            WHERE
            DbT5502."hanteiKekkaCode" = '01'
            AND
            DbT5105."shinseishoKanriNo" = DbT5502."shinseishoKanriNo"
            )
        </if>
        ORDER BY  DbT5101."hihokenshaKana",
                  DbT5101."ninteiShinseiYMD",
                  DbT5101."shoKisaiHokenshaNo"
    </select>
    <resultMap id="resultMap_ShinsakaiTorokuRelateEntity" type="jp.co.ndensan.reams.db.dbe.entity.db.relate.shinsakaitoroku.ShinsakaiTorokuRelateEntity" autoMapping="true">
    <result property="delay" column="delay" />
    <result property="shinseishoKanriNo"  column="shinseishoKanriNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ShinseishoKanriNoTypeHandler"/>
    <result property="shoKisaiHokenshaNo"  column="shoKisaiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ShoKisaiHokenshaNoTypeHandler"/>
    <result property="hihokenshaNo"  column="hihokenshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    <result property="hihokenshaName"  column="hihokenshaName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.AtenaMeishoTypeHandler"/>
    <result property="shinseijiKubunCode"  column="ninteiShinseiShinseijiKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.CodeTypeHandler"/>
    <result property="ninteiShinseiHoreiKubunCode"  column="ninteiShinseiHoreiKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.CodeTypeHandler"/>
    <result property="ninteiShinseiYMD"  column="ninteiShinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="yusenWaritsukeKubunCode"  column="shinsakaiYusenWaritsukeKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.CodeTypeHandler"/>
    <result property="shichosonMeisho"  column="shichosonMeisho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    <result property="ninteichosaKanryoYMD"  column="ninteichosaKanryoYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="ikenshoTorokuKanryoYMD"  column="ikenshoTorokuKanryoYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="maskingKanryoYMD"  column="maskingKanryoYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="ninteiShinsakaiKanryoYMD"  column="ninteiShinsakaiKanryoYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="kaiWariateKanryoYMD"  column="ninteiShinsakaiWariateKanryoYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="shinsakaiKaishiYoteiTime"  column="shinsakaiKaishiYoteiTime" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    <result property="shinsakaiKaisaiYoteiYMD"  column="shinsakaiKaisaiYoteiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="shinsakaiKaisaiNo"  column="shinsakaiKaisaiNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    <result property="gogitaiNo"  column="gogitaiNo" />
    <result property="shinsakaiWariateYMD"  column="shinsakaiWariateYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    <result property="shinsakaiOrder"  column="shinsakaiOrder" />
    <result property="gogitaiMei"  column="gogitaiMei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    <association property="要介護認定完了情報Entity" resultMap="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT5105NinteiKanryoJohoMapper.ResultMap_DbT5105NinteiKanryoJohoEntity"/>
   </resultMap>

    <resultMap id="resultMap_ShinsakaiKaisaiRelateEntity" type="jp.co.ndensan.reams.db.dbe.entity.db.relate.shinsakaikaisai.ShinsakaiKaisaiRelateEntity" autoMapping="true">
        <result property="shinsakaiKaisaiYoteiYMD" column="shinsakaiKaisaiYoteiJoho_shinsakaiKaisaiYoteiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shinsakaiKaishiYoteiTime" column="shinsakaiKaisaiYoteiJoho_shinsakaiKaishiYoteiTime" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="合議体名称" column="合議体名称" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="gogitaiMei" column="gogitaiJoho_gogitaiMei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="種類" column="種類" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shinsakaiKaisaiBashoName" column="shinsakaiKaisaiBashoJoho_shinsakaiKaisaiBashoName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shinsakaiWariateZumiNinzu" column="shinsakaiKaisaiYoteiJoho_shinsakaiWariateZumiNinzu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="shinsakaiYoteiTeiin" column="shinsakaiKaisaiYoteiJoho_shinsakaiYoteiTeiin" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="gogitaiDummyFlag" column="gogitaiJoho_gogitaiDummyFlag"/>
        <result property="合議体番号" column="gogitaiJoho_gogitaiNo"/>
        <result property="最大審査順" column="wariateJoho_shinsakaiOrder"/>    
    </resultMap>
    
    <select resultOrdered="true" id="get審査会一覧"
            resultMap="resultMap_ShinsakaiKaisaiRelateEntity"
            parameterType="jp.co.ndensan.reams.db.dbz.definition.core.shinsakaikaisai.ShinsakaiKaisaiParameter" fetchSize="500">
        SELECT
                shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiYMD" AS "shinsakaiKaisaiYoteiJoho_shinsakaiKaisaiYoteiYMD",
                shinsakaiKaisaiYoteiJoho."shinsakaiKaishiYoteiTime" AS "shinsakaiKaisaiYoteiJoho_shinsakaiKaishiYoteiTime",
                gogitaiJoho."gogitaiNo" AS gogitaiJoho_gogitaiNo,
                '第'||shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiNo"||'回審査会' AS 合議体名称,
                gogitaiJoho."gogitaiMei" AS "gogitaiJoho_gogitaiMei",
                CASE WHEN gogitaiJoho."gogitaiSeishinkaSonzaiFlag" = True 
                THEN '精' ELSE '' END AS 種類,
                shinsakaiKaisaiBashoJoho."shinsakaiKaisaiBashoName" AS "shinsakaiKaisaiBashoJoho_shinsakaiKaisaiBashoName",
                shinsakaiKaisaiYoteiJoho."shinsakaiWariateZumiNinzu" AS "shinsakaiKaisaiYoteiJoho_shinsakaiWariateZumiNinzu",
                shinsakaiKaisaiYoteiJoho."shinsakaiYoteiTeiin" AS "shinsakaiKaisaiYoteiJoho_shinsakaiYoteiTeiin",
                gogitaiJoho."gogitaiDummyFlag" AS "gogitaiJoho_gogitaiDummyFlag",
                wariateJoho."shinsakaiOrder" AS wariateJoho_shinsakaiOrder
        FROM rgdb."DbT5501ShinsakaiKaisaiYoteiJoho" AS shinsakaiKaisaiYoteiJoho
        INNER JOIN rgdb."DbT5591GogitaiJoho" AS gogitaiJoho
                ON gogitaiJoho."gogitaiNo" = shinsakaiKaisaiYoteiJoho."gogitaiNo"
               AND gogitaiJoho."gogitaiYukoKikanKaishiYMD" <![CDATA[<=]]>  shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiYMD"
               AND gogitaiJoho."gogitaiYukoKikanShuryoYMD" <![CDATA[>=]]>  shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiYMD"
               AND gogitaiJoho."gogitaiDummyFlag" = FALSE
        LEFT JOIN rgdb."DbT5511ShinsakaiKaisaiKekkaJoho" AS shinsakaiKaisaiKekkaJoho
                ON shinsakaiKaisaiKekkaJoho."shinsakaiKaisaiNo" = shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiNo"
        LEFT JOIN rgdb."DbT5592ShinsakaiKaisaiBashoJoho" AS shinsakaiKaisaiBashoJoho
                ON shinsakaiKaisaiBashoJoho."shinsakaiKaisaiBashoCode" = shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiBashoCode"
        LEFT JOIN (
                SELECT * FROM rgdb."DbT5502ShinsakaiWariateJoho" AS "mst"
                WHERE NOT EXISTS (SELECT 'X'
                FROM rgdb."DbT5502ShinsakaiWariateJoho" AS "slv"
		WHERE "mst"."shinsakaiKaisaiNo" = "slv"."shinsakaiKaisaiNo"
		AND "mst"."shinsakaiOrder" <![CDATA[<]]> "slv"."shinsakaiOrder")) AS wariateJoho
                ON wariateJoho."shinsakaiKaisaiNo" = shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiNo"
        WHERE shinsakaiKaisaiYoteiJoho."isDeleted" = false
                AND shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiYMD" <![CDATA[>=]]> #{表示期間From}
         	AND shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiYMD" <![CDATA[<=]]> #{表示期間To}
                AND shinsakaiKaisaiYoteiJoho."ShinsakaiShinchokuJokyo" IN ('0', '1')
                AND shinsakaiKaisaiYoteiJoho."shinsakaiYoteiTeiin" <![CDATA[>]]> shinsakaiKaisaiYoteiJoho."shinsakaiWariateZumiNinzu"
        <if test="is開催予定登録OR対象者割付">
            <if test="is表示しない">
                AND gogitaiJoho."gogitaiDummyFlag" = false
            </if>
        </if>
        ORDER BY shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiYoteiYMD", shinsakaiKaisaiYoteiJoho."shinsakaiKaisaiNo"
    </select>
</mapper>
