<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： DbT1001HihokenshaDaichoEntityのマッピング用XMLです。 -->
<!--SelectMethod : getHihokenshaShutokuJyoho-->
<!--ParentResultMap : resultMap_getHihokenshaShutokuJyoho-->
<mapper namespace="jp.co.ndensan.reams.db.dbe.persistence.db.mapper.relate.hakkoichiranhyo.IHomonChosaIraishoMapper">

    <resultMap id="resultMap_getHomonChosaIraisho" type="jp.co.ndensan.reams.db.dbe.entity.db.relate.hakkoichiranhyo.HomonChosaIraishoRelateEntity" autoMapping="true">
	<result property="申請書管理番号" column="Temp_申請書管理番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者番号" column="Temp_被保険者番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者氏名カナ" column="Temp_被保険者氏名カナ" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者氏名" column="Temp_被保険者氏名" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者住所" column="Temp_被保険者住所" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="生年月日" column="Temp_生年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="性別コード" column="Temp_性別コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者住所_郵便番号" column="Temp_被保険者住所_郵便番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者電話番号" column="Temp_被保険者電話番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="要介護認定_更新申請日" column="Temp_要介護認定更新申請日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="申請区分コード" column="Temp_申請区分コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="認定調査依頼年月日" column="Temp_認定調査依頼年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="要介護認定調査表提出期限" column="Temp_要介護認定調査表提出期限" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="訪問調査先住所" column="Temp_訪問調査先住所" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="訪問調査先電話番号" column="Temp_訪問調査先電話番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="訪問調査先名称" column="Temp_訪問調査先名称" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="訪問調査先住所_郵便番号" column="Temp_訪問調査先住所_郵便番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="事業者番号" column="Temp_事業者番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="調査員名" column="Temp_調査員名" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="最大依頼履歴番号" column="Temp_最大依頼履歴番号" />
    </resultMap>
    
    <select id="get訪問調査依頼書" resultMap="resultMap_getHomonChosaIraisho"
            parameterType="jp.co.ndensan.reams.db.dbe.definition.mybatisprm.hakkoichiranhyo.HomonChosaIraishoMybitisParamter" fetchSize="500">
        SELECT
            DbT5101."shinseishoKanriNo" AS Temp_申請書管理番号,
            DbT5101."hihokenshaNo" AS Temp_被保険者番号,
            DbT5101."hihokenshaKana" AS Temp_被保険者氏名カナ,
            DbT5101."hihokenshaName" AS Temp_被保険者氏名,
            DbT5101."jusho" AS Temp_被保険者住所,
            DbT5101."seinengappiYMD" AS Temp_生年月日,
            DbT5101."seibetsu" AS Temp_性別コード,
            DbT5101."yubinNo" AS Temp_被保険者住所_郵便番号,
            DbT5101."telNo" AS Temp_被保険者電話番号,
            DbT5101."ninteiShinseiYMD" AS Temp_要介護認定更新申請日,
            DbT5101."ninteiShinseiShinseijiKubunCode" AS Temp_申請区分コード,
            DbT5201."ninteichosaIraiYMD" AS Temp_認定調査依頼年月日,
            DbT5201."ninteichosaKigenYMD" AS Temp_要介護認定調査表提出期限,
            DbT5910."jusho" AS Temp_訪問調査先住所,
            DbT5910."telNo" AS Temp_訪問調査先電話番号,
            DbT5910."jigyoshaMeisho" AS Temp_訪問調査先名称,
            DbT5910."yubinNo" AS Temp_訪問調査先住所_郵便番号,
            DbT5910."jigyoshaNo" AS Temp_事業者番号,
            DbT5913."chosainShimei" AS Temp_調査員名,
            ninteiChosaSaioIraiRirekiNo."ninteichosaIraiRirekiNo" AS Temp_最大依頼履歴番号 
        FROM
            rgdb."DbT5101NinteiShinseiJoho" AS DbT5101 
        INNER JOIN 
            rgdb."DbT5105NinteiKanryoJoho" AS DbT5105 
        ON 
            DbT5105."shinseishoKanriNo"= DbT5101."shinseishoKanriNo"
        LEFT JOIN 
            rgdb."DbT7051KoseiShichosonMaster" AS DbT7051 
        ON 
            DbT7051."shoKisaiHokenshaNo"= DbT5101."shoKisaiHokenshaNo"
        LEFT JOIN 
            rgdb."DbT5910NinteichosaItakusakiJoho" AS DbT5910 
        ON 
            DbT5910."shichosonCode"= DbT7051."shichosonCode"
        AND DbT5910."ninteichosaItakusakiCode"= DbT5101."ninteiChosaItakusakiCode"
        AND DbT5910."jokyoFlag"= false 
        LEFT JOIN 
            rgdb."DbT5913ChosainJoho" AS DbT5913 
        ON
            DbT5913."shichosonCode"= DbT7051."shichosonCode"
        AND DbT5913."ninteiChosaItakusakiCode"= DbT5101."ninteiChosaItakusakiCode"
        AND DbT5913."ninteiChosainCode"= DbT5101."ninteiChosainCode"
        AND DbT5913."jokyoFlag"= false INNER JOIN( 
            SELECT
              MAX("ninteichosaIraiRirekiNo") AS"ninteichosaIraiRirekiNo",
             "shinseishoKanriNo"
            FROM
              rgdb."DbT5201NinteichosaIraiJoho"
            WHERE
             "logicalDeletedFlag"= false 
            GROUP BY
             "shinseishoKanriNo"
          ) ninteiChosaSaioIraiRirekiNo 
        ON 
            ninteiChosaSaioIraiRirekiNo."shinseishoKanriNo"= DbT5101."shinseishoKanriNo"
        INNER JOIN 
            rgdb."DbT5201NinteichosaIraiJoho" AS DbT5201 
        ON 
            DbT5201."shinseishoKanriNo"= DbT5101."shinseishoKanriNo"
        AND DbT5201."logicalDeletedFlag"= false 
        AND DbT5201."ninteichosaIraiRirekiNo"= ninteiChosaSaioIraiRirekiNo."ninteichosaIraiRirekiNo"
        WHERE
            DbT5101."shoKisaiHokenshaNo"= #{hihokenshaNo} 
        AND DbT5101."ninteiChosaItakusakiCode" IN 
        <foreach  
            collection="ninteiChosaItakusakiCodeList"
            item="item"
            open="(" 
            separator="," 
            close=")">  
            #{item}
        </foreach>
        AND DbT5101."ninteiChosainCode" IN
        <foreach  
             collection="ninteiChosainNoList" 
             item="item"
             open="(" 
             separator="," 
             close=")">  
             #{item}
        </foreach>
        AND DbT5101."shoriJotaiKubun" IN ('01', '04') 
        AND DbT5101."logicalDeletedFlag" = false 
        AND DbT5105."ninteiShinseiJohoTorokuKanryoYMD" IS NOT NULL 
        AND DbT5105."ninteichosaKanryoYMD"IS NULL 
        AND DbT5105."ninteiShinsakaiWariateKanryoYMD" IS NULL 
        AND DbT5105."ninteiShinsakaiKanryoYMD" IS NULL 
        AND DbT5105."centerSoshinYMD" IS NULL 
        <if test= "is依頼日From">
            AND DbT5201."ninteichosaIraiYMD" <![CDATA[>=]]> #{iraiFromYMD}
        </if>
        <if test= "is依頼日To">
            AND DbT5201."ninteichosaIraiYMD" <![CDATA[<=]]> #{iraiToYMD}
        </if>
        <if test="is認定調査依頼書未印刷">
            AND dbT5201."iraishoShutsuryokuYMD" IS NULL
        </if>
        <if test="is認定調査依頼書印刷済">
            AND dbT5201."iraishoShutsuryokuYMD" IS NOT NULL
        </if>
        <if test="is認定調査票未印刷">
            AND dbT5201."chosahyoTouShutsuryokuYMD" IS NULL
        </if>
        <if test="is認定調査票印刷済">
            AND dbT5201."chosahyoTouShutsuryokuYMD" IS NOT NULL
        </if>
        ORDER BY
            DbT5101."ninteiChosaItakusakiCode",
            DbT5101."ninteiChosainCode"
    </select>
    
    <update id="update認定調査依頼情報"  parameterType="jp.co.ndensan.reams.db.dbz.entity.db.basic.DbT5201NinteichosaIraiJohoEntity">
        UPDATE rgdb."DbT5201NinteichosaIraiJoho"
        SET
            "iraishoShutsuryokuYMD" = #{iraishoShutsuryokuYMD},
            "ninteichosaKigenYMD" = #{ninteichosaKigenYMD}
        WHERE
            "shinseishoKanriNo" = #{shinseishoKanriNo}
        AND "ninteichosaIraiRirekiNo" = #{ninteichosaIraiRirekiNo}
        AND "logicalDeletedFlag" = #{logicalDeletedFlag}
      </update>
</mapper>