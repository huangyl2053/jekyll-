<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： DbT1001HihokenshaDaichoEntityのマッピング用XMLです。 -->
<!-- @reamsid_L DBE-0080-130 duanzhanli -->
<!--SelectMethod : getHihokenshaShutokuJyoho-->
<!--ParentResultMap : resultMap_getHihokenshaShutokuJyoho-->
<mapper namespace="jp.co.ndensan.reams.db.dbe.persistence.db.mapper.relate.hakkoichiranhyo.IShujiiIkenshoTeishutsuIraishoHakkoMapper">

    <resultMap id="resultMap_ShujiiIkenshoTeishutsuIraishoHakko" type="jp.co.ndensan.reams.db.dbe.entity.db.relate.hakkoichiranhyo.ShujiiIkenshoTeishutsuIraishoHakkoRelateEntity" autoMapping="true">
        <result property="申請書管理番号" column="shinseishoKanriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="証記載保険者番号" column="shoKisaiHokenshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="被保険者氏名カナ" column="hihokenshaKana" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="被保険者氏名" column="hihokenshaName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="被保険者番号" column="hihokenshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="年齢" column="age" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="住所" column="jusho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="生年月日" column="seinengappiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="性別" column="seibetsu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="郵便番号" column="yubinNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="認定申請年月日" column="ninteiShinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="電話番号" column="telNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医医療機関コード" column="shujiiIryokikanCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医コード" column="shujiiCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="医療機関住所" column="医療機関住所" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="医療機関電話番号" column="医療機関電話番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="医療機関FAX番号" column="医療機関FAX番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="医療機関郵便番号" column="医療機関郵便番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="医療機関名称" column="iryoKikanMeisho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="代表者名" column="daihyoshaName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書依頼区分" column="ikenshoIraiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書作成期限年月日" column="ikenshoSakuseiKigenYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/> 
        <result property="在宅施設区分" column="zaitakuShisetsuKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書作成依頼年月日" column="ikenshoSakuseiIraiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="認定申請区分申請時コード" column="ninteiShinseiShinseijiKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="意見書作成回数区分" column="ikenshoSakuseiKaisuKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書記入年月日" column="ikenshoKinyuYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書読取年月日" column="ikenshoReadYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医氏名" column="shujiiName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="保険者名" column="保険者名" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="市町村コード" column="市町村コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書別途診療費" column="ikenshoBettoShinryohi" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="主治医意見書報酬支払年月日" column="hoshuShiharaiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/> 
        <result property="最大依頼履歴番号" column="ikenshoIraiRirekiNo"/> 
        <result property="直近区分" column="直近区分" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <association property="dbt5301Entity" resultMap="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT5301ShujiiIkenshoIraiJohoMapper.ResultMap_DbT5301ShujiiIkenshoIraiJohoEntity"/>
    </resultMap>
    
    <select resultOrdered="true" id="get主治医意見書提出依頼書発行" resultMap="resultMap_ShujiiIkenshoTeishutsuIraishoHakko"
            parameterType="jp.co.ndensan.reams.db.dbe.definition.mybatisprm.hakkoichiranhyo.ShujiiIkenMybatisParameter" fetchSize="500">
        SELECT
        pickout."shinseishoKanriNo" AS "shinseishoKanriNo"
        , pickout."shoKisaiHokenshaNo" AS "shoKisaiHokenshaNo"
        , pickout."hihokenshaKana" AS "hihokenshaKana"
        , pickout."hihokenshaName" AS "hihokenshaName"
        , pickout."hihokenshaNo" AS "hihokenshaNo"
        , pickout."age" AS "age"
        , pickout."jusho_5101" AS "jusho"
        , pickout."seinengappiYMD" AS "seinengappiYMD"
        , pickout."seibetsu" AS "seibetsu"
        , pickout."yubinNo_5101" AS "yubinNo"
        , pickout."ninteiShinseiYMD" AS "ninteiShinseiYMD"
        , pickout."telNo_5101" AS "telNo"
        , pickout."shujiiIryokikanCode" AS "shujiiIryokikanCode"
        , pickout."shujiiCode" AS "shujiiCode"
        , pickout."jusho_5911" AS "医療機関住所"
        , pickout."telNo_5911" AS "医療機関電話番号"
        , pickout."faxNo_5911" AS "医療機関FAX番号"
        , pickout."yubinNo_5911" AS "医療機関郵便番号"
        , pickout."iryoKikanMeisho" AS "iryoKikanMeisho"
        , pickout."daihyoshaName" AS "daihyoshaName"
        , pickout."ikenshoIraiKubun" AS "ikenshoIraiKubun"
        , pickout."ikenshoSakuseiKigenYMD" AS "ikenshoSakuseiKigenYMD"
        , IkenshoJoho."zaitakuShisetsuKubun" AS "zaitakuShisetsuKubun"
        , pickout."ikenshoSakuseiIraiYMD" AS "ikenshoSakuseiIraiYMD"
        , pickout."ninteiShinseiShinseijiKubunCode" AS "ninteiShinseiShinseijiKubunCode"
        , IkenshoJoho."ikenshoSakuseiKaisuKubun" AS "ikenshoSakuseiKaisuKubun"
        , IkenshoJoho."ikenshoKinyuYMD" AS "ikenshoKinyuYMD"
        , IkenshoJoho."ikenshoReadYMD" AS "ikenshoReadYMD"
        , IkenshoJoho."ikenshoIraiKubun" AS "shinseishoKanriNo"
        , pickout."shujiiName" AS "shujiiName"
        , pickout."shichosonMeisho" AS "保険者名"
        , pickout."shichosonCode" AS "市町村コード"
        , IkenshoJoho."ikenshoBettoShinryohi" AS "ikenshoBettoShinryohi"
        , IkenshoJoho."hoshuShiharaiYMD" AS "hoshuShiharaiYMD"
        , pickout."ikenshoIraiRirekiNo"  AS "ikenshoIraiRirekiNo"
        , <include refid="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT5301ShujiiIkenshoIraiJohoMapper.allColumns_DbT5301ShujiiIkenshoIraiJoho" />
        FROM(
        <include refid="ShujiiIkenshoHakko" />
        ) AS pickout
        LEFT JOIN 
        ( SELECT
        DbT5302."shinseishoKanriNo"
        , DbT5302."ikenshoIraiRirekiNo"
        , DbT5302."zaitakuShisetsuKubun"
        , DbT5302."ikenshoSakuseiKaisuKubun"
        , DbT5302."ikenshoKinyuYMD"
        , DbT5302."ikenshoReadYMD"
        , DbT5302."ikenshoIraiKubun"
        , DbT5602."ikenshoBettoShinryohi"
        , DbT5602."hoshuShiharaiYMD"
        FROM
        rgdb."DbT5302ShujiiIkenshoJoho" AS DbT5302 
        LEFT JOIN rgdb."DbT5602ShujiiIkenshoHoshuJissekiJoho" AS DbT5602 
        ON DbT5602."shinseishoKanriNo" = DbT5302."shinseishoKanriNo" 
        AND DbT5602."shujiiIryoKikanCode" = DbT5302."shujiiIryoKikanCode" 
        AND DbT5602."shujiiCode" = DbT5302."shujiiCode" 
        AND DbT5602."ikenshoIraiRirekiNo" = DbT5302."ikenshoIraiRirekiNo"
        ) AS IkenshoJoho
        ON IkenshoJoho."shinseishoKanriNo" = pickout."shinseishoKanriNo" 
        AND IkenshoJoho."ikenshoIraiRirekiNo" = pickout."ikenshoIraiRirekiNo" 
        INNER JOIN
        rgdb."DbT5301ShujiiIkenshoIraiJoho"
        ON
        pickout."shinseishoKanriNo" = rgdb."DbT5301ShujiiIkenshoIraiJoho"."shinseishoKanriNo"
        AND pickout."ikenshoIraiRirekiNo" = rgdb."DbT5301ShujiiIkenshoIraiJoho"."ikenshoIraiRirekiNo"
        AND rgdb."DbT5301ShujiiIkenshoIraiJoho"."isDeleted" = FALSE
        
        ORDER BY
        pickout."shichosonCode",
	pickout."shujiiIryokikanCode",
        pickout."shujiiCode",
        pickout."ninteiShinseiYMD",
        pickout."hihokenshaKana",
        pickout."hihokenshaNo" 
    </select>
    
    <sql id="ShujiiIkenshoHakko">
        SELECT
        DbT5101."shinseishoKanriNo"
        , DbT5101."shoKisaiHokenshaNo"
        , DbT5101."hihokenshaKana"
        , DbT5101."hihokenshaName"
        , DbT5101."hihokenshaNo"
        , DbT5101."age"
        , DbT5101."jusho" AS "jusho_5101"
        , DbT5101."seinengappiYMD"
        , DbT5101."seibetsu"
        , DbT5101."yubinNo" AS "yubinNo_5101"
        , DbT5101."ninteiShinseiYMD"
        , DbT5101."telNo" AS "telNo_5101"
        , DbT5101."shujiiIryokikanCode"
        , DbT5101."shujiiCode"
        , DbT5911."jusho" AS "jusho_5911"
        , DbT5911."telNo" AS "telNo_5911"
        , DbT5911."faxNo" AS "faxNo_5911"
        , DbT5911."yubinNo" AS "yubinNo_5911"
        , DbT5911."iryoKikanMeisho"
        , DbT5911."daihyoshaName"
        , DbT5301."ikenshoIraiKubun"
        , DbT5301."ikenshoSakuseiKigenYMD"
        , DbT5301."ikenshoSakuseiIraiYMD"
        , DbT5101."ninteiShinseiShinseijiKubunCode"
        , DbT5912."shujiiName"
        , DbT7051."shichosonMeisho"
        , DbT5101."shichosonCode"
        , DbT5301."ikenshoIraiRirekiNo"
        <!-- jp.co.ndensan.reams.db.dbe.persistence.db.mapper.relate.iraisho.IIraishoIkkatsuHakkoMapper.selectShuziiIkenshoIrai
        と同じ。//TODO 引数の関係でまとめていない。できたらまとめる START -->   
        FROM 
        rgdb."DbT5301ShujiiIkenshoIraiJoho" AS DbT5301,
        rgdb."DbT7051KoseiShichosonMaster" AS DbT7051,
        rgdb."DbT5911ShujiiIryoKikanJoho" AS DbT5911,
        rgdb."DbT5912ShujiiJoho" AS DbT5912,
        rgdb."DbT5105NinteiKanryoJoho" AS DbT5105,
        rgdb."DbT5101NinteiShinseiJoho" AS DbT5101
        <where> 
            AND DbT5911."shichosonCode" = DbT5101."shichosonCode"
            AND DbT5911."shujiiIryokikanCode" = DbT5301."shujiiIryokikanCode"
            AND DbT5912."shichosonCode" = DbT5101."shichosonCode"
            AND DbT5912."shujiiIryokikanCode" = DbT5301."shujiiIryokikanCode"							
            AND DbT5912."shujiiCode" = DbT5301."shujiiCode"						
            AND DbT5301."shinseishoKanriNo" = DbT5105."shinseishoKanriNo"										
            AND DbT5301."ikenshoIraiRirekiNo" = 
            (SELECT 
            MAX("ikenshoIraiRirekiNo") 
            FROM 
            rgdb."DbT5301ShujiiIkenshoIraiJoho" 
            WHERE 
            "shinseishoKanriNo" = DbT5105."shinseishoKanriNo" 
            )
            AND DbT5301."logicalDeletedFlag"= false 
            AND DbT5101."shinseishoKanriNo" = DbT5105."shinseishoKanriNo" 
            AND DbT5101."shoKisaiHokenshaNo" = DbT7051."shoKisaiHokenshaNo" 
            AND DbT5101."shoriJotaiKubun" IN (#{通常},#{延期}) 
            AND DbT5101."logicalDeletedFlag" = false 
            AND (DbT5105."ninteiShinseiJohoTorokuKanryoYMD" IS NOT NULL 
            AND DbT5105."ninteiShinseiJohoTorokuKanryoYMD" <![CDATA[<>]]> '') 
            AND (DbT5105."ninteiShinsakaiWariateKanryoYMD" IS NULL 
            OR DbT5105."ninteiShinsakaiWariateKanryoYMD" = '') 
            AND (DbT5105."ninteiShinsakaiKanryoYMD" IS NULL 
            OR DbT5105."ninteiShinsakaiKanryoYMD" = '') 
            AND (DbT5105."centerSoshinYMD" IS NULL 
            OR DbT5105."centerSoshinYMD" = '') 
            AND (DbT5101."ninteiShinseiShinseijiKubunCode" <![CDATA[<>]]> #{転入}
            AND DbT5101."ninteiShinseiShinseijiKubunCode" <![CDATA[<>]]> #{喪失})
            <if test="is依頼日From">
                AND DbT5301."ikenshoSakuseiIraiYMD"<![CDATA[>=]]> #{iraiFromYMD}
            </if>
            <if test="is依頼日To">
                AND DbT5301."ikenshoSakuseiIraiYMD"<![CDATA[<=]]> #{iraiToYMD}
            </if>
            <if test="!is意見書作成未印刷_印刷済">
                <if test="is意見書作成未印刷">
                    AND (DbT5301."iraishoShutsuryokuYMD" IS NULL 
                    OR DbT5301."iraishoShutsuryokuYMD" = '') 
                </if>
                <if test="is意見書作成印刷済">
                    AND (DbT5301."iraishoShutsuryokuYMD" IS NOT NULL
                    AND DbT5301."iraishoShutsuryokuYMD" <![CDATA[<>]]> '')  
                </if>
            </if>
            <if test="!is意見書未印刷_印刷済">
                <if test="is意見書未印刷">
                    AND (DbT5301."ikenshoShutsuryokuYMD" IS NULL 
                    OR DbT5301."ikenshoShutsuryokuYMD" = '')    
                </if>
                <if test="is意見書印刷済">
                    AND (DbT5301."ikenshoShutsuryokuYMD" IS NOT NULL
                    AND DbT5301."ikenshoShutsuryokuYMD" <![CDATA[<>]]> '')  
                </if>
            </if>
            <!-- jp.co.ndensan.reams.db.dbe.persistence.db.mapper.relate.iraisho.IIraishoIkkatsuHakkoMapper.selectShuziiIkenshoIrai
            と同じ。//TODO 引数の関係でまとめていない。できたらまとめる END-->
            AND <foreach collection="shujiiIkenshoSakuseiIraiList" item="item" open="(" separator="OR" close=")">  
                (DbT5101."shujiiIryokikanCode" =  #{item.shujiiIryoKikanCode} 
                AND DbT5101."shujiiCode" = #{item.ishiNo} 
                AND DbT5101."shoKisaiHokenshaNo" =  #{item.shoKisaiHokenshaNo} )
            </foreach>
        </where>
    </sql>
    
    <sql id="ShujiiIkenshoTeishutsuIraiHakko">
        FROM
        rgdb."DbT5101NinteiShinseiJoho" AS DbT5101 
        INNER JOIN rgdb."DbT5105NinteiKanryoJoho" AS DbT5105 
        ON DbT5105."shinseishoKanriNo" = DbT5101."shinseishoKanriNo" 
        LEFT JOIN rgdb."DbT7051KoseiShichosonMaster" AS DbT7051 
        ON DbT7051."shoKisaiHokenshaNo" = DbT5101."shoKisaiHokenshaNo" 
        LEFT JOIN rgdb."DbT5911ShujiiIryoKikanJoho" AS DbT5911 
        ON DbT5911."shichosonCode" = DbT5101."shichosonCode" 
        AND DbT5911."shujiiIryokikanCode" = DbT5101."shujiiIryokikanCode" 
        AND DbT5911."jokyoFlag" = true 
        INNER JOIN ( 
        SELECT
        MAX("ikenshoIraiRirekiNo") AS "ikenshoIraiRirekiNo"
        , "shinseishoKanriNo" 
        FROM
        rgdb."DbT5301ShujiiIkenshoIraiJoho" 
        WHERE
        "logicalDeletedFlag" = false 
        GROUP BY
        "shinseishoKanriNo"
        ) rirekiNosho 
        ON rirekiNosho."shinseishoKanriNo" = DbT5101."shinseishoKanriNo" 
        LEFT JOIN rgdb."DbT5301ShujiiIkenshoIraiJoho" AS DbT5301 
        ON DbT5301."shinseishoKanriNo" = DbT5101."shinseishoKanriNo" 
        AND DbT5301."logicalDeletedFlag" = false 
        AND DbT5301."ikenshoIraiRirekiNo" = rirekiNosho."ikenshoIraiRirekiNo" 
        LEFT JOIN rgdb."DbT5202NinteichosahyoGaikyoChosa" AS DbT5202 
        ON DbT5202."shinseishoKanriNo" = DbT5101."shinseishoKanriNo" 
        AND DbT5202."ninteichosaRirekiNo" = rirekiNosho."ikenshoIraiRirekiNo" 
        LEFT JOIN rgdb."DbT5302ShujiiIkenshoJoho" AS DbT5302 
        ON DbT5302."shinseishoKanriNo" = DbT5101."shinseishoKanriNo" 
        AND DbT5302."ikenshoIraiRirekiNo" = rirekiNosho."ikenshoIraiRirekiNo" 
        LEFT JOIN rgdb."DbT5912ShujiiJoho" AS DbT5912 
        ON DbT5301."shujiiIryokikanCode" = DbT5912."shujiiIryokikanCode" 
        AND DbT5301."shujiiCode" = DbT5912."shujiiCode" 
        AND DbT7051."shichosonCode" = DbT5912."shichosonCode" 
        AND DbT5912."jokyoFlag" = true 
        LEFT JOIN rgdb."DbT5602ShujiiIkenshoHoshuJissekiJoho" AS DbT5602 
        ON DbT5602."shinseishoKanriNo" = DbT5302."shinseishoKanriNo" 
        AND DbT5602."shujiiIryoKikanCode" = DbT5302."shujiiIryoKikanCode" 
        AND DbT5602."ikenshoIraiRirekiNo" = DbT5302."ikenshoIraiRirekiNo"
        WHERE
        <foreach  
            collection="shujiiIkenshoSakuseiIraiList"
            item="item"
            open="("  
            separator="OR"  
            close=")">  
            (DbT5101."shujiiIryokikanCode" =  #{item.shujiiIryoKikanCode} 
            AND DbT5101."shujiiCode" = #{item.ishiNo} 
            AND Dbt5101."shoKisaiHokenshaNo" =  #{item.shoKisaiHokenshaNo} )
        </foreach>
        AND DbT5101."shoriJotaiKubun" IN (#{通常},#{延期})
        AND DbT5101."logicalDeletedFlag"= false 
        AND (DbT5105."ninteiShinseiJohoTorokuKanryoYMD" IS NOT NULL AND DbT5105."ninteiShinseiJohoTorokuKanryoYMD" <![CDATA[<>]]> '')
        AND (DbT5105."ninteiShinsakaiWariateKanryoYMD" IS NULL OR DbT5105."ninteiShinsakaiWariateKanryoYMD" = '')
        AND (DbT5105."ninteiShinsakaiKanryoYMD" IS NULL OR DbT5105."ninteiShinsakaiKanryoYMD" = '')
        AND (DbT5105."centerSoshinYMD" IS NULL OR DbT5105."centerSoshinYMD" = '')
        <if test="is依頼日From">
            AND DbT5301."ikenshoSakuseiIraiYMD"<![CDATA[>=]]> #{iraiFromYMD}
        </if>
        <if test="is依頼日To">
            AND DbT5301."ikenshoSakuseiIraiYMD"<![CDATA[<=]]> #{iraiToYMD}
        </if>
        <if test="!is意見書作成未印刷_印刷済">
            <if test="is意見書作成未印刷">
                AND (DbT5301."iraishoShutsuryokuYMD" IS NULL OR DbT5105."iraishoShutsuryokuYMD" = '')
            </if>
            <if test="is意見書作成印刷済">
                AND (DbT5301."iraishoShutsuryokuYMD" IS NOT NULL AND DbT5301."iraishoShutsuryokuYMD" <![CDATA[<>]]> '')
            </if>
        </if>
        <if test="!is意見書未印刷_印刷済">
            <if test="is意見書未印刷">
                AND (DbT5301."ikenshoShutsuryokuYMD" IS NULL OR DbT5105."ikenshoShutsuryokuYMD" = '')
            </if>
            <if test="is意見書印刷済">
                AND (DbT5301."ikenshoShutsuryokuYMD" IS NOT NULL AND DbT5301."ikenshoShutsuryokuYMD" <![CDATA[<>]]> '')
            </if>
        </if>
        ORDER BY
        DbT5101."shujiiIryokikanCode",
        DbT5101."shujiiCode"
    </sql>
      
    <select resultOrdered="true" id="get主治医意見書作成依頼情報" 
            resultMap="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT5301ShujiiIkenshoIraiJohoMapper.ResultMap_DbT5301ShujiiIkenshoIraiJohoEntity"
            parameterType="jp.co.ndensan.reams.db.dbe.entity.db.relate.hakkoichiranhyo.ShujiiIkenshoTeishutsuIraishoHakkoRelateEntity" fetchSize="500">
        SELECT
        <include refid="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT5301ShujiiIkenshoIraiJohoMapper.allColumns_DbT5301ShujiiIkenshoIraiJoho" />
        FROM
        rgdb."DbT5301ShujiiIkenshoIraiJoho"
        WHERE
        "shinseishoKanriNo" = #{申請書管理番号}
        AND "ikenshoIraiRirekiNo" = #{最大依頼履歴番号}
        AND "logicalDeletedFlag" = false
    </select>   
    <select resultOrdered="true" id="get主治医意見書作成依頼履歴一覧" resultMap="resultMap_ShujiiIkenshoTeishutsuIraishoHakko"
            parameterType="jp.co.ndensan.reams.db.dbe.definition.mybatisprm.hakkoichiranhyo.ShujiiIkenMybatisParameter"
            fetchSize="500">
        WITH rireki AS(
        SELECT
        CASE WHEN(lag(T5101."hihokenshaNo",1) OVER (ORDER BY T5101."hihokenshaNo" ASC, T5101."ninteiShinseiYMD" DESC) = T5101."hihokenshaNo") 
        THEN FALSE ELSE TRUE END AS chokkin
        , T5101."hihokenshaNo"
        , T5101."hihokenshaKana"
        , T5101."hihokenshaName"
        , T5101."jusho"
        , T5911."iryoKikanMeisho"
        , T5912."shujiiName"
        , T5301."ikenshoSakuseiIraiYMD"
        , T5101."ninteiShinseiShinseijiKubunCode"
        , T5302."ikenshoSakuseiKaisuKubun"
        , mod(row_number()over(ORDER BY T5101."hihokenshaNo" ASC,T5101."ninteiShinseiYMD" DESC),25)
        FROM
        rgdb."DbT5101NinteiShinseiJoho" T5101 
        LEFT JOIN ( 
        SELECT
        T5121."zenkaiShinseishoKanriNo"
        , T5101_2."hihokenshaNo" 
        FROM
        rgdb."DbT5121ShinseiRirekiJoho" T5121 
        INNER JOIN rgdb."DbT5101NinteiShinseiJoho" T5101_2 
        ON T5101_2."shinseishoKanriNo" = T5121."zenkaiShinseishoKanriNo"
        ) D 
        ON D."zenkaiShinseishoKanriNo" = T5101."shinseishoKanriNo" 
        INNER JOIN rgdb."DbT7051KoseiShichosonMaster" T7051 
        ON T5101."shoKisaiHokenshaNo" = T7051."shoKisaiHokenshaNo" 
        INNER JOIN rgdb."DbT5301ShujiiIkenshoIraiJoho" AS T5301 
        ON T5101."shinseishoKanriNo" = T5301."shinseishoKanriNo" 
        AND T5301."logicalDeletedFlag" = False 
        AND NOT EXISTS ( 
        SELECT
        'X' 
        FROM
        rgdb."DbT5301ShujiiIkenshoIraiJoho" AS B1 
        WHERE
        T5301."shinseishoKanriNo" = B1."shinseishoKanriNo" 
        AND B1."logicalDeletedFlag" = False 
        AND T5301."ikenshoIraiRirekiNo" <![CDATA[<]]> B1."ikenshoIraiRirekiNo"
        ) 
        LEFT JOIN rgdb."DbT5302ShujiiIkenshoJoho" T5302 
        ON T5302."shinseishoKanriNo" = T5301."shinseishoKanriNo" 
        AND T5302."ikenshoIraiRirekiNo" = T5301."ikenshoIraiRirekiNo" 
        LEFT JOIN rgdb."DbT5911ShujiiIryoKikanJoho" T5911 
        ON T5301."shujiiIryokikanCode" = T5911."shujiiIryokikanCode" 
        AND T5101."shichosonCode" = T5911."shichosonCode" 
        AND T5911."jokyoFlag" = True 
        LEFT JOIN rgdb."DbT5912ShujiiJoho" T5912 
        ON T5301."shujiiIryokikanCode" = T5912."shujiiIryokikanCode" 
        AND T5301."shujiiCode" = T5912."shujiiCode" 
        AND T5101."shichosonCode" = T5912."shichosonCode" 
        AND T5912."jokyoFlag" = True 
        INNER JOIN
        (<include refid="ShujiiIkenshoHakko" />) AS pickout 
        ON pickout."hihokenshaNo" = T5101."hihokenshaNo"
        AND pickout."shoKisaiHokenshaNo" = T5101."shoKisaiHokenshaNo"
        WHERE
        T5101."logicalDeletedFlag" = FALSE
      
        ORDER BY
        T5101."hihokenshaNo" ASC
        , T5101."ninteiShinseiYMD" DESC
)
        
        SELECT 
        CASE WHEN "chokkin" THEN '直近' ELSE '' END AS "直近区分"
        , CASE WHEN "chokkin" OR mod = '1' THEN "hihokenshaNo" ELSE '' END AS "hihokenshaNo"
        , CASE WHEN "chokkin" OR mod = '1' THEN "hihokenshaKana" ELSE '' END AS "hihokenshaKana"
        , CASE WHEN "chokkin" OR mod = '1' THEN "hihokenshaName" ELSE '' END AS "hihokenshaName"
        , CASE WHEN "chokkin" OR mod = '1' THEN "jusho" ELSE '' END AS "jusho"
        , "iryoKikanMeisho" AS "iryoKikanMeisho"
        , "shujiiName" AS "shujiiName"
        , "ikenshoSakuseiIraiYMD" AS "ikenshoSakuseiIraiYMD"
        , "ninteiShinseiShinseijiKubunCode" AS "ninteiShinseiShinseijiKubunCode"
        , "ikenshoSakuseiKaisuKubun" AS "ikenshoSakuseiKaisuKubun"
        FROM rireki
    </select>     
</mapper>