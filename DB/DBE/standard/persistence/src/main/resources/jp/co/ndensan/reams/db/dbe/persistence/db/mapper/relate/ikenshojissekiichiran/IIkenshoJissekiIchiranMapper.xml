<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： 主治医意見書作成実績集計表のデータ取得のMapperXMLです。 -->
<!-- @reamsid_L DBE-1690-020 dongyabin -->
<!-- どのマッパーインターフェースと対応するかを指定する -->
<mapper namespace="jp.co.ndensan.reams.db.dbe.persistence.db.mapper.relate.ikenshojissekiichiran.IIkenshoJissekiIchiranMapper">


    <select id="get主治医意見書作成実績集計表"
            resultType="jp.co.ndensan.reams.db.dbe.entity.db.relate.ikenshojissekiichiran.IkenshoJissekiIchiranRelateEntity"
            parameterType="jp.co.ndensan.reams.db.dbe.definition.mybatisprm.ikenshojissekiichiran.IkenshoJissekiIchiranMybitisParamter" fetchSize="500"  resultOrdered="true">
        SELECT
        T7051."shoKisaiHokenshaNo" AS 証記載保険者番号
        , T7051."shichosonMeisho" AS 市町村名称
        , T5302."shujiiIryoKikanCode" AS 医療機関コード
        , T5911."iryoKikanMeisho" AS 医療機関名称
        , T5912."shujiiName" AS 主治医氏名
        , T5101."hihokenshaNo" AS 被保険者番号
        , T5101."hihokenshaName" AS 申請者氏名
        , T5301."ikenshoSakuseiIraiYMD" AS 依頼日
        , T5302."ikenshoKinyuYMD" AS 記入日
        , T5302."ikenshoJuryoYMD" AS 入手日
        , T5302."zaitakuShisetsuKubun" AS 在宅_施設区分
        , T5302."ikenshoSakuseiKaisuKubun" AS 意見書作成回数区分
        , CAST(T5032.tanka AS text) AS 単価
        , T5302."shinseishoKanriNo" AS 申請書管理番号
        , T5302."ikenshoIraiRirekiNo" AS 主治医意見書作成依頼履歴番号
        , T5302."shujiiCode" AS 主治医コード
        <include refid="core" />
        <include refid="group" />
        <include refid="order" />
    </select>

    <select id="getTotalCount"
            resultType="int"
            parameterType="jp.co.ndensan.reams.db.dbe.definition.mybatisprm.ikenshojissekiichiran.IkenshoJissekiIchiranMybitisParamter" fetchSize="500"  resultOrdered="true">
        SELECT
        COUNT(*)
        FROM (
        SELECT
        T7051."shoKisaiHokenshaNo"
        , T7051."shichosonMeisho"
        , T5302."shujiiIryoKikanCode"
        , T5911."iryoKikanMeisho"
        , T5912."shujiiName"
        , T5101."hihokenshaNo"
        , T5101."hihokenshaName"
        , T5301."ikenshoSakuseiIraiYMD"
        , T5302."ikenshoKinyuYMD"
        , T5302."ikenshoJuryoYMD"
        , T5302."zaitakuShisetsuKubun"
        , T5302."ikenshoSakuseiKaisuKubun"
        , T5032.tanka
        , T5302."shinseishoKanriNo"
        , T5302."ikenshoIraiRirekiNo"
        , T5302."shujiiCode"
        <include refid="core" />
        <include refid="group" />
        ) AS A
    </select>

    <sql id="core">
        FROM
        rgdb."DbT5302ShujiiIkenshoJoho" AS T5302
        INNER JOIN rgdb."DbT5101NinteiShinseiJoho" AS T5101
        ON T5101."shinseishoKanriNo" = T5302."shinseishoKanriNo"
        INNER JOIN rgdb."DbT7051KoseiShichosonMaster" AS T7051
        ON T7051."shoKisaiHokenshaNo" = T5101."shoKisaiHokenshaNo"
        INNER JOIN rgdb."DbT5911ShujiiIryoKikanJoho" AS T5911
        ON T5911."shichosonCode" = T7051."shichosonCode"
        AND T5911."shujiiIryokikanCode" = T5302."shujiiIryoKikanCode"
        INNER JOIN rgdb."DbT5912ShujiiJoho" AS T5912
        ON T5912."shichosonCode" = T7051."shichosonCode"
        AND T5912."shujiiIryokikanCode" = T5302."shujiiIryoKikanCode"
        AND T5912."shujiiCode" = T5302."shujiiCode"
        INNER JOIN rgdb."DbT5301ShujiiIkenshoIraiJoho" AS T5301
        ON T5302."shinseishoKanriNo" = T5301."shinseishoKanriNo"
        INNER JOIN rgdb."DbT5032ShujiiIkenshoHoshuTanka" AS T5032
        ON T5302."ikenshoSakuseiKaisuKubun" = T5032."ikenshoSakuseiKaisuKubun"
        AND T5302."zaitakuShisetsuKubun" = T5032."zaitakuShisetsuKubun"
        <if test="基準日FROMFlag">
            AND T5032."kaishiYM" <![CDATA[<=]]> #{基準日FROM}
        </if>
        <if test="基準日TOFlag">
            AND T5032."shuryoYM" <![CDATA[>=]]> #{基準日TO}
        </if>
        <where>
            <choose>
                <when test="基準日区分 == 2">
                    <if test="基準日FROMFlag">
                        AND #{基準日FROM} <![CDATA[<=]]> T5302."ikenshoKinyuYMD"
                    </if>
                    <if test="基準日TOFlag">
                        AND T5302."ikenshoKinyuYMD" <![CDATA[<=]]> #{基準日TO}
                    </if>
                </when>
                <when test="基準日区分 == 3">
                    <if test="基準日FROMFlag">
                        AND #{基準日FROM} <![CDATA[<=]]> T5302."ikenshoJuryoYMD"
                    </if>
                    <if test="基準日TOFlag">
                        AND T5302."ikenshoJuryoYMD" <![CDATA[<=]]> #{基準日TO}
                    </if>
                </when>
            </choose>
            <if test="保険者Flag">
                AND T7051."shichosonCode" = #{保険者}
            </if>
            <if test="batchFlag">
                AND
                <foreach collection="keyJoho" item="item" open="("
                         separator="OR"
                         close=")">
                    (
                    T5302."shujiiIryoKikanCode" = #{item.shujiiIryoKikanCode}
                    AND T5302."shujiiCode" = #{item.shujiiCode}
                    AND T5302."shinseishoKanriNo" = #{item.shinseishoKanriNo}
                    AND T5302."ikenshoIraiRirekiNo" = #{item.ikenshoIraiRirekiNo}
                    )
                </foreach>
            </if>
        </where>
    </sql>
    
    <sql id="group">
        GROUP BY T7051."shoKisaiHokenshaNo"
        , T7051."shichosonMeisho"
        , T5302."shujiiIryoKikanCode"
        , T5911."iryoKikanMeisho"
        , T5912."shujiiName"
        , T5101."hihokenshaNo"
        , T5101."hihokenshaName"
        , T5301."ikenshoSakuseiIraiYMD"
        , T5302."ikenshoKinyuYMD"
        , T5302."ikenshoJuryoYMD"
        , T5302."zaitakuShisetsuKubun"
        , T5302."ikenshoSakuseiKaisuKubun"
        , T5032.tanka
        , T5302."shinseishoKanriNo" 
        , T5302."ikenshoIraiRirekiNo"
        , T5302."shujiiCode"
    </sql>

    <sql id="order">
        ORDER BY T5302."shujiiIryoKikanCode", T5302."shujiiCode", T5302."shinseishoKanriNo", T5302."ikenshoIraiRirekiNo"
        <if test="件数Flag">
            LIMIT #{件数}
        </if>
    </sql>

</mapper>