<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- @reamsid_L DBB-1850-030 sunhui -->
<mapper namespace="jp.co.ndensan.reams.db.dbb.persistence.db.mapper.relate.tokuchoteishitaisyosyadoutei.ITokuchoTeishiTaisyosyaDouteiMapper">
    <!--特徴対象者同定情報取得 -->
    <select resultOrdered="true" id="select処理日付管理マスタ"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.tokuchoteishitaisyosyadoutei.TokuchoTeishiTaisyosyaDouteiMybatisParameter"
            resultMap="resultMap_ShoriDateKanriEntity" fetchSize="500">
        <include refid="selectShoriDateKanriEntity" />
    </select>
    <sql id="selectShoriDateKanriEntity" >
        SELECT DISTINCT
        A."shichosonCode" as 市町村コード,
        B."kijunYMD" as 基準年月日
        FROM
        rgdb."DbT7051KoseiShichosonMaster" as A
        INNER JOIN 
        rgdb."DbT7022ShoriDateKanri" as B ON 
        '00'|| A."shichosonShokibetsuID" = B."shoriEdaban"
        AND B."shoriName" = #{処理名}
        AND B."subGyomuCode" = #{介護賦課}
        AND B."nendo" = #{処理年度}  
        WHERE
        A."gappeiKyuShichosonKubun" = #{最新の広域構成市町村}  
        AND A."gappeiKyuShichosonHyojiUmu" = #{表示}  
    </sql>
    <resultMap id="resultMap_ShoriDateKanriEntity" autoMapping="true"
               type="jp.co.ndensan.reams.db.dbb.entity.db.relate.shoridatekanri.ShoriDateKanriEntity">
        <result property="市町村コード" column="市町村コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.LasdecCodeTypeHandler"/>
        <result property="基準年月日" column="基準年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    </resultMap>  
    
    <!--処理状況一覧情報取得 -->
    <select resultOrdered="true" id="select処理状況一覧情報"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.tokuchoteishitaisyosyadoutei.TokuchoTeishiTaisyosyaDouteiMybatisParameter"
            resultMap="resultMap_ShoriJokyoJohoEntity" fetchSize="500">
        <include refid="selectShoriJokyoJohoEntity" />
    </select>  
    <sql id="selectShoriJokyoJohoEntity" >
        SELECT DISTINCT 
        A."shichosonCode" as 市町村コード,  
        A."shichosonMeisho" as 市町村名称,
        B."shoriName" as 処理名,
        B."kijunYMD" as 基準年月日,
        B."kijunTimestamp" as 基準日時
        FROM  
        rgdb."DbT7051KoseiShichosonMaster" as A
        LEFT JOIN 
        rgdb."DbT7022ShoriDateKanri" as B ON 
        '00'|| A."shichosonShokibetsuID" = B."shoriEdaban"
        AND B."subGyomuCode" = #{介護賦課}
        AND B."nendo" = #{処理年度} 
        AND CASE
        WHEN #{対象者情報取得月} = '04' THEN B."nendoNaiRenban" = '0001' AND B."shoriName" =#{特徴結果情報取込}  
        WHEN #{対象者情報取得月} = '05' THEN B."nendoNaiRenban" = '0001' AND B."shoriName" =#{特徴対象者情報取込}
        WHEN #{対象者情報取得月} = '08' THEN B."nendoNaiRenban" = '0005' AND B."shoriName" =#{特徴結果情報取込}
        WHEN #{対象者情報取得月} = '10' THEN B."nendoNaiRenban" = '0007' AND B."shoriName" =#{特徴結果情報取込}
        WHEN #{対象者情報取得月} = '12' THEN B."nendoNaiRenban" = '0009' AND B."shoriName" =#{特徴結果情報取込}
        WHEN #{対象者情報取得月} = '02' THEN B."nendoNaiRenban" = '0011' AND B."shoriName" =#{特徴結果情報取込}
        END
        WHERE 
        A."gappeiKyuShichosonKubun" = #{最新の広域構成市町村}  
        AND A."gappeiKyuShichosonHyojiUmu" = #{表示} 
        ORDER BY A."shichosonCode"
    </sql>
    <resultMap id="resultMap_ShoriJokyoJohoEntity" autoMapping="true"
               type="jp.co.ndensan.reams.db.dbb.entity.db.relate.shoridatekanri.ShoriJokyoJohoEntity">
        <result property="市町村コード" column="市町村コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.LasdecCodeTypeHandler"/>
        <result property="市町村名称" column="市町村名称" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="処理名" column="処理名" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="基準年月日" column="基準年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="基準日時" column="基準日時" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.YMDHMSTypeHandler"/>
    </resultMap>
    
    <!--今回処理内容情報取得 -->
    <select resultOrdered="true" id="select今回処理内容情報"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.tokuchoteishitaisyosyadoutei.TokuchoTeishiTaisyosyaDouteiMybatisParameter"
            resultMap="resultMap_KonkaiShoriNaiyoJohoEntity" fetchSize="500">
        <include refid="selectKonkaiShoriNaiyoJohoEntity" />
    </select> 
    <sql id="selectKonkaiShoriNaiyoJohoEntity" >
        SELECT DISTINCT
        A."nendoNaiRenban" as 年度内連番
        FROM
        rgdb."DbT7022ShoriDateKanri" as A 
        INNER JOIN 
        rgdb."DbT7051KoseiShichosonMaster" as B ON 
        A."shoriEdaban" = '00'|| B."shichosonShokibetsuID"
        AND B."gappeiKyuShichosonKubun" = #{最新の広域構成市町村}  
        AND B."gappeiKyuShichosonHyojiUmu" = #{表示} 
        WHERE
        A."shoriName" = #{特徴対象者同定}
        AND A."subGyomuCode" = #{介護賦課}
        AND A."nendo" = #{処理年度}
        AND A."kijunTimestamp" IS NULL
        ORDER BY A."nendoNaiRenban" LIMIT 1
    </sql>
    <resultMap id="resultMap_KonkaiShoriNaiyoJohoEntity" autoMapping="true"
               type="jp.co.ndensan.reams.db.dbb.entity.db.relate.shoridatekanri.KonkaiShoriNaiyoJohoEntity">
        <result property="年度内連番" column="年度内連番" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>
</mapper>