<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBB-1650-040 lijunjun -->

<mapper namespace="jp.co.ndensan.reams.db.dbb.persistence.db.mapper.relate.shotokujohoichiranhyosakusei.IShotokuJohoIchiranhyoSakuseiMapper">

    <!--KaigoHokenShotokuTempEntityの項目にマッピングします。-->
    <resultMap id="resultMap_KaigoHokenShotokuTempEntity" type="jp.co.ndensan.reams.db.dbb.entity.db.relate.shotokujohoichiranhyosakusei.KaigoHokenShotokuTempEntity" autoMapping="true">
        <result property="shikibetsuCode" column="shikibetsuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.ShikibetsuCodeTypeHandler"/>
        <result property="hihokenshaNo" column="hihokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="kanaMeisho" column="kanaMeisho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.AtenaKanaMeishoTypeHandler"/>
        <result property="meisho" column="meisho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.AtenaMeishoTypeHandler"/>
        <result property="shotokuNendo" column="shotokuNendo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearTypeHandler"/>
        <result property="seinengappiYMD" column="seinengappiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shojoIdoYMD" column="shojoIdoYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="seinengappiYMD" column="seinengappiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shojoJiyuCode" column="shojoJiyuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="seibetsuCode" column="seibetsuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="juminShubetsuCode" column="juminShubetsuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="kazeiKubun" column="kazeiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="kazeiKubunGemmenGo" column="kazeiKubunGemmenGo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="gokeiShotokuGaku" column="gokeiShotokuGaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="nenkiniShunyuGaku" column="nenkiniShunyuGaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="nenkiniShotokuGaku" column="nenkiniShotokuGaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="kazeiShotokuGaku" column="kazeiShotokuGaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="torokuGyomu" column="torokuGyomu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="setaiCode" column="setaiCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.SetaiCodeTypeHandler"/>
    </resultMap>

    <!--介護保険所得情報一覧データ取得-->
    <select resultOrdered="true" id="select介護保険所得情報一覧データ"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.shotokujohoichiranhyosakusei.ShotokuJohoIchiranhyoSakuseiParameter"
            resultMap="resultMap_KaigoHokenShotokuTempEntity" fetchSize="500">
        WITH master AS (
        SELECT
        A."shikibetsuCode",
        C."hihokenshaNo",
        A."shotokuNendo",
        A."kazeiKubun",
        A."kazeiKubunGemmenGo",
        A."gokeiShotokuGaku",
        A."nenkiniShunyuGaku",
        A."nenkiniShotokuGaku",
        A."kazeiShotokuGaku",
        A."torokuGyomu"
        FROM
        (
        SELECT
        F."shotokuNendo",
        F."shikibetsuCode",
        <if test="ラジオボタン == 2">
            F."rirekiNo",
        </if>
        <if test="ラジオボタン == 1">
            F."rirekiNo" ,
        </if>
        F."kazeiKubun",
        F."kazeiKubunGemmenGo",
        F."gokeiShotokuGaku",
        F."nenkiniShunyuGaku",
        F."nenkiniShotokuGaku",
        F."kazeiShotokuGaku",
        F."shoriTimeStamp",
        F."torokuGyomu"
        FROM rgdb."DbV2502KaigoShotoku" AS F
        <if test="ラジオボタン == 2">
            INNER JOIN
            (SELECT
            "shotokuNendo",
            "shikibetsuCode"
            ,max("rirekiNo") AS rirekiNo
            FROM rgdb."DbV2502KaigoShotoku" AS X
            GROUP BY X."shotokuNendo", X."shikibetsuCode"
            ) AS Y
            ON Y."shotokuNendo"=F."shotokuNendo"
            AND Y."shikibetsuCode"= F."shikibetsuCode"
            AND Y.rirekiNo= F."rirekiNo"
        </if>
        WHERE
        F."shotokuNendo"=#{処理年度}
        AND #{開始日時}<![CDATA[<=]]>F."shoriTimeStamp"
        AND F."shoriTimeStamp"<![CDATA[<=]]>#{終了日時}
        <if test="チックボックス == 1">
            AND (cast(F."torokuGyomu" as varchar(1)) = '1' OR cast(F."torokuGyomu" as varchar(1)) = '2')
        </if>
        <if test="チックボックス == 2">
            AND cast(F."torokuGyomu" as varchar(1)) = '1'
        </if>
        <if test="チックボックス == 3">
            AND cast(F."torokuGyomu" as varchar(1)) = '2'
        </if>
        ) AS A
        LEFT OUTER JOIN rgdb."DbV1001HihokenshaDaicho" AS C
        ON C."shikibetsuCode"=A."shikibetsuCode"
        AND (C."hihokennshaKubunCode"='1' OR C."hihokennshaKubunCode"='2'))
        SELECT master.*,
        B."kanaMeisho",
        B."meisho",
        B."seinengappiYMD",
        B."shojoJiyuCode",
        B."shojoIdoYMD",
        B."seibetsuCode",
        B."juminShubetsuCode",
        B."setaiCode"
        FROM master
        LEFT OUTER JOIN
        rgua."UaFt200FindShikibetsuTaisho"('1','','0','DB','0','','','','','','','','','','','0','0','','','','','',
        '','0','0','','','','','','','','','','0','','1','1','1','1','1','1','1','1','1','1','1','','','','','','','',
        '0','0','','','0','0','0','','','','','','','','','','','','','','','','','','', (
        SELECT
        ARRAY_AGG(CAST (master."shikibetsuCode" AS TEXT))
        FROM
        master
        )) AS B
        ON master."shikibetsuCode"=B."shikibetsuCode"
        ${出力順} , master."shotokuNendo" ASC
    </select>

    <!--広域市町村の所得情報一覧を取得します。-->
    <select resultOrdered="true" id="select対象データ"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.shotokujohoichiranhyosakusei.ShotokuJohoIchiranhyoSakuseiGParameter"
            resultMap="resultMap_KaigoHokenShotokuTempEntity" fetchSize="500">
        WITH leader AS (
        WITH master AS (
        SELECT
        M."shikibetsuCode",
        M."rirekiNo",
        M."shotokuNendo",
        M."kazeiKubun",
        M."kazeiKubunGemmenGo",
        M."gokeiShotokuGaku",
        M."nenkiniShunyuGaku",
        M."nenkiniShotokuGaku",
        M."kazeiShotokuGaku",
        M."torokuGyomu",
        M."shoriTimeStamp"
        FROM
        (
        SELECT
        F."shotokuNendo",
        F."shikibetsuCode",
        <if test="ラジオボタン == 2">
            F."rirekiNo",
        </if>
        <if test="ラジオボタン == 1">
            F."rirekiNo",
        </if>
        F."kazeiKubun",
        F."kazeiKubunGemmenGo",
        F."gokeiShotokuGaku",
        F."nenkiniShunyuGaku",
        F."nenkiniShotokuGaku",
        F."kazeiShotokuGaku",
        F."shoriTimeStamp",
        F."torokuGyomu"
        FROM rgdb."DbV2502KaigoShotoku" F
        <if test="チックボックス == 2">
            INNER JOIN
            (SELECT
            "shotokuNendo"
            ,max("rirekiNo") AS rirekiNo
            ,"shikibetsuCode"
            FROM rgdb."DbV2502KaigoShotoku" AS X
            GROUP BY X."shotokuNendo", X."shikibetsuCode"
            ORDER BY X."shotokuNendo", X."shikibetsuCode"
            ) AS Y
            ON Y."shotokuNendo"=F."shotokuNendo"
            AND Y."shikibetsuCode"= F."shikibetsuCode"
            AND Y.rirekiNo=F."rirekiNo"
        </if>
        WHERE
        F."shotokuNendo"=#{処理年度}
        )AS M)
        SELECT
        master.*,
        N."kanaMeisho",
        N."meisho",
        N."seinengappiYMD",
        N."shojoJiyuCode",
        N."shojoIdoYMD",
        N."seibetsuCode",
        N."juminShubetsuCode",
        N."genLasdecCode",
        N."setaiCode"
        FROM master
        LEFT OUTER JOIN
        rgua."UaFt200FindShikibetsuTaisho"('1','','0','DB','0','','','','','','','','','','','0','0','','','','','',
        '','0','0','','','','','','','','','','0','','1','1','1','1','1','1','1','1','1','1','1','','','','','','','',
        '0','0','','','0','0','0','','','','','','','','','','','','','','','','','','',                    (
        SELECT
        ARRAY_AGG(CAST (master."shikibetsuCode" AS TEXT))
        FROM
        master
        )) AS N
        ON master."shikibetsuCode"=N."shikibetsuCode"
        ORDER BY master."shotokuNendo" ASC, master."rirekiNo" DESC)
        SELECT
        A."shikibetsuCode",
        B."hihokenshaNo",
        A."kanaMeisho",
        A."meisho",
        A."shotokuNendo",
        A."seinengappiYMD",
        A. "shojoJiyuCode",
        A. "shojoIdoYMD",
        A."seibetsuCode",
        A."juminShubetsuCode",
        A."kazeiKubun",
        A."kazeiKubunGemmenGo",
        A."gokeiShotokuGaku",
        A."nenkiniShunyuGaku",
        A."nenkiniShotokuGaku",
        A."kazeiShotokuGaku",
        A."torokuGyomu",
        A."setaiCode"
        FROM
        (
        SELECT
        leader."shikibetsuCode",
        leader."kanaMeisho",
        leader."meisho",
        leader."shotokuNendo",
        leader."seinengappiYMD",
        leader. "shojoJiyuCode",
        leader. "shojoIdoYMD",
        leader."seibetsuCode",
        leader."juminShubetsuCode",
        leader."kazeiKubun",
        leader."kazeiKubunGemmenGo",
        leader."gokeiShotokuGaku",
        leader."nenkiniShunyuGaku",
        leader."nenkiniShotokuGaku",
        leader."kazeiShotokuGaku",
        leader."torokuGyomu",
        leader."shoriTimeStamp",
        leader."setaiCode"
        FROM leader
        WHERE
        #{開始日時}<![CDATA[<=]]>leader."shoriTimeStamp"
        AND leader."shoriTimeStamp"<![CDATA[<=]]>#{終了日時}
        AND leader."genLasdecCode"=#{市町村コード}
        <if test="チックボックス == 1">
            AND (cast(leader. "torokuGyomu" as varchar(1)) = '1' OR cast(leader. "torokuGyomu" as varchar(1)) = '2')
        </if>
        <if test="チックボックス == 2">
            AND cast(leader. "torokuGyomu" as varchar(1)) = '1'
        </if>
        <if test="チックボックス == 3">
            AND cast(leader. "torokuGyomu" as varchar(1)) = '2'
        </if> ) AS A
        LEFT OUTER JOIN
        rgdb."DbV1001HihokenshaDaicho" AS B
        ON A."shikibetsuCode"=B."shikibetsuCode"
        AND(B."hihokennshaKubunCode"='1' OR B."hihokennshaKubunCode"='2')
        ${出力順}, "shotokuNendo" ASC
    </select>

    <!--select所得情報一覧データ-->
    <select id="select所得情報一覧データ" resultMap="resultMap_KaigoHokenShotokuTempEntity" fetchSize="500">
        SELECT *
        FROM "KaigoHokenShotokuTemp"
    </select>

    <!--処理日付管理マスタ_単一市町村を取得します。-->
    <select resultOrdered="true" id="select処理日付管理マスタ_単一市町村" resultType="jp.co.ndensan.reams.db.dbx.entity.db.basic.DbT7022ShoriDateKanriEntity"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.shotokujohoichiranhyosakusei.RegistShoriDateKanriParameter" fetchSize="500">
        SELECT *
        FROM rgdb."DbT7022ShoriDateKanri"
        WHERE "subGyomuCode"='DBB'
        AND "shichosonCode"=#{市町村コード}
        AND "shoriName"='所得情報一覧表作成'
        AND "shoriEdaban"='0001'
        AND "nendo"=#{処理年度}
        AND "nendoNaiRenban"='0001'
    </select>

    <!--処理日付管理マスタ_広域市町村を取得します。-->
    <select resultOrdered="true" id="select処理日付管理マスタ_広域市町村"
            resultType="jp.co.ndensan.reams.db.dbx.entity.db.basic.DbT7022ShoriDateKanriEntity"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.shotokujohoichiranhyosakusei.RegistShoriDateKanriParameter" fetchSize="500">
        SELECT *
        FROM rgdb."DbT7022ShoriDateKanri"
        WHERE "subGyomuCode"='DBB'
        AND "shichosonCode"=#{市町村コード}
        AND "shoriName"='所得情報一覧表作成'
        AND "shoriEdaban"=#{市町村識別ID}
        AND "nendo"=#{処理年度}
        AND "nendoNaiRenban"='0001'
    </select>

    <select resultOrdered="true" id="selectTempAll"
            parameterType="jp.co.ndensan.reams.db.dbb.definition.mybatisprm.shotokujohoichiranhyosakusei.PrtKaigoHokenShotokuJohoIchiranParameter"
            resultType="jp.co.ndensan.reams.db.dbb.entity.db.relate.shotokujohoichiranhyosakusei.KaigoHokenShotokuTempEntity" fetchSize="500">
        SELECT TEMP.*
        FROM "KaigoHokenShotokuTemp" TEMP
        ${出力順}
    </select>

</mapper>