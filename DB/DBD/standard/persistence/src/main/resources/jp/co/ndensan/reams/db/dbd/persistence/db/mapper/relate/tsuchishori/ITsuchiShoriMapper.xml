<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBD-2040-010 chenxin -->
<!-- 概要： 完了処理・通知書発行画面初期化用XMLです。 -->

<mapper namespace="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.relate.tsuchishori.ITsuchiShoriMapper">
    <select id="初期化データ取得" fetchSize="500" resultOrdered="true" resultType="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbd5030001.TsuchiShoriEntity">
        SELECT
            T4101."shoKisaiHokenshaNo" AS 証記載保険者番号,
            T7051."shichosonMeisho" AS 市町村名称,
            T4101."hihokenshaNo" AS 被保険者番号,
            T4101."hihokenshaName" AS 被保険者氏名,
            T4101."ninteiShinseiYMD" AS 認定申請年月日,
            T4101."ninteiShinseiShinseijiKubunCode" AS 認定申請区分申請時コード,
            T4101."ninteiShinseiHoreiKubunCode" AS 認定申請区分法令コード,
            T4101."shinseishoKanriNo" AS 申請書管理番号,
<!--        TODO QA #100668-->
<!--            T4122."tsuchiKanryoYMD" AS 通知完了年月日,-->
            '20000101' AS 通知完了年月日,
            T4001."ninteiKekkaTsuchishoHakkoYMD" AS 認定結果通知書発行年月日,
            T4001."kubunHenkoTsuchishoHakkoYMD" AS 区分変更通知書発行年月日,
            T4001."serviceHenkoTsuchishoHakkoYMD" AS サービス変更通知書発行年月日,
            T4001."ninteiKyakkaTsuchishoHakkoYMD" AS 認定却下通知書発行年月日,
            T4001."ninteiTorikeshiTsuchishoHakkoYMD" AS 認定取消通知書発行年月日
        FROM
            rgdb."DbT4101NinteiShinseiJoho" AS T4101
        INNER JOIN  rgdb."DbT7051KoseiShichosonMaster" AS T7051
            ON  T7051."shoKisaiHokenshaNo" = T4101."shoKisaiHokenshaNo"
        INNER JOIN  rgdb."DbT4001JukyushaDaicho" AS T4001
            ON  T4001."shichosonCode" = T7051."shichosonCode"
            AND T4001."hihokenshaNo" = T4101."hihokenshaNo"
            AND T4001."rirekiNo" = (SELECT 
                                        MAX(rgdb."DbT4001JukyushaDaicho"."rirekiNo")
                                    FROM rgdb."DbT4001JukyushaDaicho" 
                                    WHERE rgdb."DbT4001JukyushaDaicho"."shichosonCode" = T7051."shichosonCode" 
                                    AND rgdb."DbT4001JukyushaDaicho"."hihokenshaNo" = T4101."hihokenshaNo")
            AND T4001."edaban" = (SELECT 
                                        MAX(rgdb."DbT4001JukyushaDaicho"."edaban")
                                    FROM rgdb."DbT4001JukyushaDaicho" 
                                    WHERE rgdb."DbT4001JukyushaDaicho"."shichosonCode" = T7051."shichosonCode" 
                                    AND rgdb."DbT4001JukyushaDaicho"."hihokenshaNo" = T4101."hihokenshaNo")
            AND T4001."logicalDeletedFlag" = FALSE
            AND T4001."rirekiNo" != '0000'
            AND (T4001."ninteiKekkaTsuchishoHakkoYMD" IS NOT NULL
                OR T4001."kubunHenkoTsuchishoHakkoYMD" IS NOT NULL
                OR T4001."serviceHenkoTsuchishoHakkoYMD" IS NOT NULL
                OR T4001."ninteiKyakkaTsuchishoHakkoYMD" IS NOT NULL
                OR T4001."ninteiTorikeshiTsuchishoHakkoYMD" IS NOT NULL
            )
        WHERE
            T4101."shoriJotaiKubun" = '1'
        AND NOT EXISTS(
            SELECT
                *
            FROM
                rgdb."DbT4122TsuchishoHakkoJoho" AS T4122
            WHERE
                T4122."shinseishoKanriNo"= T4101."shinseishoKanriNo")
        AND T4101."logicalDeletedFlag" = FALSE
        ORDER BY 被保険者番号,被保険者氏名,認定申請年月日            
    </select>
</mapper>
