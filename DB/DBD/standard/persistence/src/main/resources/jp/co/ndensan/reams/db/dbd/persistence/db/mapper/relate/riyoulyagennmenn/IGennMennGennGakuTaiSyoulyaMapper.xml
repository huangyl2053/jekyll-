<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： 対象者一次特定用XMLです。 -->
<!-- @reamsid_L DBD-3980-030 x_youyj -->

<!-- どのマッパーインターフェースと対応するかを指定する -->
<mapper namespace="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.relate.riyoulyagennmenn.IGennMennGennGakuTaiSyoulyaMapper">

   <select id="select減免減額対象者判定用ByKey" resultMap="resultMap_HchiJinoSyouriNo"
            parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.dbdbt00002.TaishoshaIchijiTokuteiMybatisprmParamter"
            fetchSize="500" resultOrdered="true">
        SELECT
        A."hihokenshaNo" AS 被保険者番号
        FROM
        rgdb."DbV1001HihokenshaDaicho" AS A
        LEFT JOIN
        rgdb."DbT4001JukyushaDaicho" AS DbT4001JukyushaDaicho
        ON
        A."hihokenshaNo" = DbT4001JukyushaDaicho."hihokenshaNo"
        LEFT JOIN
        rgdb."DbT4014RiyoshaFutangakuGengaku" AS DbT4014RiyoshaFutangakuGengaku
        ON
        A."hihokenshaNo" = DbT4014RiyoshaFutangakuGengaku."hihokenshaNo"
        LEFT JOIN
        rgdb."DbT3105SogoJigyoTaishosha" AS DbT3105SogoJigyoTaishosha
        ON
        A."hihokenshaNo" = DbT3105SogoJigyoTaishosha."hihokenshaNo"
        WHERE 1=1
        <if test="is該当者リスト">
            <if test="is受給者">
                AND DbT4001JukyushaDaicho."ninteiYukoKikanKaishiYMD" &lt;= #{基準日}
                AND DbT4001JukyushaDaicho."ninteiYukoKikanShuryoYMD" &gt;= #{基準日}
                AND DbT4001JukyushaDaicho."logicalDeletedFlag" = false
                AND DbT4001JukyushaDaicho."yukoMukoKubun" = '1'
            </if>
            <if test="is事業対象者">
                AND DbT3105SogoJigyoTaishosha."tekiyoKaishiYMD" &lt;= #{基準日}
                AND DbT3105SogoJigyoTaishosha."tekiyoShuryoYMD" &gt;= #{基準日}
                AND NOT (
                #{基準日} &gt;= DbT4001JukyushaDaicho."ninteiYukoKikanKaishiYMD"
                AND #{基準日} &lt; DbT4001JukyushaDaicho."ninteiYukoKikanShuryoYMD"
                AND DbT4001JukyushaDaicho."logicalDeletedFlag" = false
                AND DbT4001JukyushaDaicho."yukoMukoKubun" = #{有効})
            </if>
        </if>
        <if test="is旧措置者">
                AND DbT4001JukyushaDaicho."logicalDeletedFlag" = false
               AND DbT4001JukyushaDaicho."kyuSochishaFlag" = true
        </if>
        <if test="is旧措置者以外">
                AND NOT EXIST (
                    SELECT COUNT(1)
                    FROM DbT4001JukyushaDaicho AS J
                    WHERE A."hihokenshaNo" = J."hihokenshaNo"
                    AND J."logicalDeletedFlag" = false
                    AND J."kyuSochishaFlag" = true
            )
        </if>
        <if test="is認定者リスト">
            AND (DbT4014RiyoshaFutangakuGengaku."ketteiKubun"='1'
                AND DbT4014RiyoshaFutangakuGengaku."tekiyoKaishiYMD" &lt;= #{基準日}
                AND DbT4014RiyoshaFutangakuGengaku."tekiyoShuryoYMD" &gt;= #{基準日})
            OR (DbT4014RiyoshaFutangakuGengaku."ketteiKubun" = ''
                AND DbT4014RiyoshaFutangakuGengaku."shinseiYMD" &lt;= #{基準日})
        </if>
    </select>
    <resultMap id="resultMap_HchiJinoSyouriNo" type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00002.temptable.TaishoshaIchijiTokuteiTempTableEntity" autoMapping="true">
        <id property="被保険者番号" column="被保険者番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>

    <select id="select利用者負担額減免認定者" resultMap="resultMap_ChohyoShutsuryokuJohoResultEntity"
            parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.dbdbt00002.NinteishaListSakuseiMybatisprmParameter"
            fetchSize="500" resultOrdered="true">
            SELECT
		A."被保険者番号" AS 被保険者番号,
		A."本人課税区分" AS 本人課税区分,
		A."is老齢福祉年金受給者" AS is老齢福祉年金受給者,
		A."is所得税課税者" AS is所得税課税者,
		A."is生活保護受給者" AS is生活保護受給者,
		施設入所情報."nyushoShisetsuCode" AS 入所施設コード,
		施設入所情報."jigyoshaName" AS 入所施設名称,
                認定情報."認定情報の被保険者番号" AS 認定情報の被保険者番号,
                認定情報."要介護状態区分コード" AS 認定情報の要介護状態区分コード,
                認定情報."認定年月日" AS 認定情報の認定年月日,
                認定情報."認定有効期間開始年月日" AS 認定情報の認定有効期間開始年月日,
                認定情報."認定有効期間終了年月日" AS 認定情報の認定有効期間終了年月日,
		要介護認定申請情報子."koroshoIfShikibetsuCode" AS 厚労省IF識別コード,
		受給者台帳Newest."kyuSochishaFlag" AS 旧措置者フラグ,
                総合事業対象者情報."総者の被保険者番号",
                総合事業対象者情報."総者のチェックリスト実施日",
                総合事業対象者情報."総者の適用開始年月日",
                総合事業対象者情報."総者の適用終了年月日",
                <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.columns_ShikibetsuTaisho" />,
		利用者負担額減額.*,
		減免減額申請.*,
                世帯員情報.*
            FROM
                "taishoShaHanteiYoukonkyoItokiTemp" AS A
                
            INNER JOIN rgua."UaFt200FindShikibetsuTaisho"('','',FALSE,'DB',FALSE,'','','','','','','','','','','',true,
                '','','','','','','',true,'','','','','','','','','','','',true,true,true,true,true,true,true,true,true,true,
                true,'','','','','','','','',true,'','',true,true,true,'','','','','','','','','','','','','','','','','','','{}') AS "ShikibetsuTaisho"
                     ON  A."本人識別コード" = "ShikibetsuTaisho"."shikibetsuCode"
            LEFT JOIN
                rgdb."DbV4001JukyushaDaicho" AS 受給者台帳Newest
                ON 受給者台帳Newest."hihokenshaNo" = A."被保険者番号"
            LEFT JOIN (
                SELECT
                    有効受給認定結果."hihokenshaNo" AS 認定情報の被保険者番号,
                    有効受給認定結果."yokaigoJotaiKubunCode" AS 要介護状態区分コード,
                    有効受給認定結果."ninteiYMD" AS 認定年月日,
                    有効受給認定結果."ninteiYukoKikanKaishiYMD" AS 認定有効期間開始年月日,
                    有効受給認定結果."ninteiYukoKikanShuryoYMD" AS 認定有効期間終了年月日
                FROM (
                    SELECT
                        *,
                        ROW_NUMBER() OVER (ORDER BY "ninteiYMD" DESC) AS 受給者台帳_番号
                    FROM
                        rgdb."DbT4001JukyushaDaicho" AS 受給者台帳
                    WHERE
                        受給者台帳."ninteiYukoKikanKaishiYMD" &lt;= #{基準日}
                        AND #{基準日} &lt;= 受給者台帳."ninteiYukoKikanShuryoYMD"
                        AND 受給者台帳."logicalDeletedFlag" = false
                        AND 受給者台帳."yukoMukoKubun" = '1'
                ) AS 有効受給認定結果
                WHERE
                    有効受給認定結果."受給者台帳_番号" = '1'
            ) AS 認定情報
                ON 認定情報."認定情報の被保険者番号" = A."被保険者番号"
            LEFT JOIN
                rgdb."DbT4101NinteiShinseiJoho" AS 要介護認定申請情報子
                ON 認定情報."認定情報の被保険者番号" = 要介護認定申請情報子."hihokenshaNo"
            LEFT JOIN
                    rgdb."DbT4014RiyoshaFutangakuGengaku" AS 利用者負担額減額
                ON 利用者負担額減額."hihokenshaNo" = A."被保険者番号"
            LEFT JOIN
                rgdb."DbT4010GemmenGengakuShinsei" AS 減免減額申請
                ON 減免減額申請."hihokenshaNo" = 利用者負担額減額."hihokenshaNo"
                AND 減免減額申請."shinseiRirekiNo" = 利用者負担額減額."rirekiNo"
            LEFT JOIN (
                SELECT
                    介護保険施設入退所."shikibetsuCode",
                    介護保険施設入退所."nyushoShisetsuCode",
                    入所施設."jigyoshaName"
                FROM
                    rgdb."DbT1004ShisetsuNyutaisho" AS 介護保険施設入退所
                INNER JOIN (
                    SELECT
                        *,
                        ROW_NUMBER() OVER (ORDER BY "yukoKaishiYMD" DESC) AS 入所施設_番号
                    FROM
                        rgdb."DbT7060KaigoJigyosha" AS 介護事業者
                    WHERE
                        介護事業者."yukoKaishiYMD" &lt;= #{基準日}
                    ) AS 入所施設
                        ON 入所施設."jigyoshaNo" = 介護保険施設入退所."nyushoShisetsuCode"
                WHERE
                    入所施設."入所施設_番号" = '1'
                    AND	介護保険施設入退所."nyushoYMD" &lt;= #{基準日}
                    AND #{基準日} &lt;= 介護保険施設入退所."taishoYMD"
            ) AS 施設入所情報
                ON 施設入所情報."shikibetsuCode" = A."本人識別コード"
            LEFT JOIN (
                SELECT
                    世帯員所得情報一時."hihokenshaNo" AS 世帯員の被保険者番号,
                    世帯員所得情報一時."shikibetsuCode" AS 世帯員の識別コード,
                    世帯員所得情報一時."kazeiKubun" AS 世帯員の課税区分,
                    世帯員所得情報一時."kazeiShotokuGaku" AS 課税所得額,
                    <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.columns_ShikibetsuTaisho" />
                FROM
                    "TmpSetaiShotoku" AS 世帯員所得情報一時
                INNER JOIN  rgua."UaFt200FindShikibetsuTaisho"('','',FALSE,'DB',FALSE,'','','','','','','','','','','',true,
                    '','','','','','','',true,'','','','','','','','','','','',true,true,true,true,true,true,true,true,true,true,
                    true,'','','','','','','','',true,'','',true,true,true,'','','','','','','','','','','','','','','','','','','{}') AS "ShikibetsuTaisho"
                         ON 世帯員所得情報一時."shikibetsuCode" = "ShikibetsuTaisho"."shikibetsuCode"
                WHERE
                    世帯員所得情報一時."honninKubun" != '1'
<!--                <if test="is世帯表示しない">
                    AND FALSE
                </if>  //TODO QA-->
            ) AS 世帯員情報
                ON 世帯員情報."世帯員の被保険者番号" = A."被保険者番号"
            LEFT JOIN (
                SELECT
                    総合事業対象者."hihokenshaNo" AS 総者の被保険者番号,
                    総合事業対象者."checklistJisshiYMD" AS 総者のチェックリスト実施日,
                    総合事業対象者."tekiyoKaishiYMD" AS 総者の適用開始年月日,
                    総合事業対象者."tekiyoShuryoYMD" AS 総者の適用終了年月日
                    
                FROM rgdb."DbT3105SogoJigyoTaishosha" AS 総合事業対象者
                WHERE
                    総合事業対象者."tekiyoKaishiYMD" &lt;= #{基準日}
                    AND #{基準日} &lt;= 総合事業対象者."tekiyoShuryoYMD"
                ) AS 総合事業対象者情報
            ON A."被保険者番号" = 総合事業対象者情報."総者の被保険者番号"
            WHERE
                (減免減額申請."gemmenGengakuShurui" = #{利用者負担額減額}
                OR 減免減額申請."gemmenGengakuShurui" IS null )
                AND (利用者負担額減額."hihokenshaNo" IS null
                OR (
                    (利用者負担額減額."ketteiKubun" = #{承認する}
                    AND 利用者負担額減額."tekiyoKaishiYMD" &lt;= #{基準日}
                    AND #{基準日} &lt;= 利用者負担額減額."tekiyoShuryoYMD")
                    OR (利用者負担額減額."ketteiKubun" is null 
                        AND 利用者負担額減額."shinseiYMD" &lt;= #{基準日})
                    )
		)
                <if test="is該当者リスト">
                    <if test="is市町村民税非課税世帯">
                        A."世帯課税区分" = '2'
                    </if>
                    <if test="is所得税非課税世帯">
                        A."is所得税課税世帯" = false
                    </if>
                    <if test="is市町村民税本人非課税者">
                        A."本人課税区分" = '1'
                    </if>
                    <if test="is老齢福祉年金受給者">
                        A."is老齢福祉年金受給者" = true
                    </if>
                    <if test="is生活保護受給者">
                        A."is生活保護受給者" = true
                    </if>
                </if>
	ORDER BY #{出力順}
    </select>
    <resultMap id="resultMap_ChohyoShutsuryokuJohoResultEntity" type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00002.NinteishaListSakuseiResultEntity" autoMapping="true">
        <result property="被保険者番号" column="被保険者番号" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="本人課税区分" column="本人課税区分" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="is老齢福祉年金受給者" column="is老齢福祉年金受給者" typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
        <result property="is所得税課税者" column="is所得税課税者" typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
        <result property="is生活保護受給者" column="is生活保護受給者" typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
        <result property="入所施設コード" column="入所施設コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="入所施設名称" column="入所施設名称" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="厚労省IF識別コード" column="厚労省IF識別コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="旧措置者フラグ" column="旧措置者フラグ" typeHandler="org.apache.ibatis.type.BooleanTypeHandler" />
        <result property="認定情報の被保険者番号" column="認定情報の被保険者番号" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="認定情報の要介護状態区分コード" column="認定情報の要介護状態区分コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="認定情報の認定年月日" column="認定情報の認定年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="認定情報の認定有効期間開始年月日" column="認定情報の認定有効期間開始年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="認定情報の認定有効期間終了年月日" column="認定情報の認定有効期間終了年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="総者の被保険者番号" column="総者の被保険者番号" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="総者のチェックリスト実施日" column="総者のチェックリスト実施日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="総者の適用開始年月日" column="総者の適用開始年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="総者の適用終了年月日" column="総者の適用終了年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <association property="psmEntity" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>
        <collection property="利用者負担額減額Entity" resultMap="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.basic.IDbT4014RiyoshaFutangakuGengakuMapper.ResultMap_DbT4014RiyoshaFutangakuGengakuEntity"/>
        <collection property="減免減額申請Entity" resultMap="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.basic.IDbT4010GemmenGengakuShinseiMapper.ResultMap_DbT4010GemmenGengakuShinseiEntity"/>
        <collection property="世帯員Entity" resultMap="resultMap_世帯員"/>
    </resultMap>
    <resultMap id="resultMap_世帯員" type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00002.SeteiYouEntity" autoMapping="true">
        <id property="識別コード" column="世帯員の識別コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.ShikibetsuCodeTypeHandler"/>
        <result property="被保険者番号" column="世帯員の被保険者番号" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="課税区分" column="世帯員の課税区分" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="課税所得額" column="課税所得額" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <association property="psmEntity" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>
    </resultMap>
</mapper>