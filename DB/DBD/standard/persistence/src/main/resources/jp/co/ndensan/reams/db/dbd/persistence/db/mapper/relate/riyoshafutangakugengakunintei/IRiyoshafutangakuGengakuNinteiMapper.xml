<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBD-3970-050 x_xuliang -->


<mapper namespace="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.relate.riyoshafutangakugengakunintei.IRiyoshafutangakuGengakuNinteiMapper">
    <select id="get減免減額"
                parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.dbdbt00003.TaishoshaIchijiTokuteiMybatisParameter"
                resultType="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00003.TaishoshaIchijiTokuteiEntity" 
                fetchSize="500" resultOrdered="true">
        SELECT DISTINCT
        A."hihokenshaNo"
        FROM
        rgdb."DbV1001HihokenshaDaicho" AS A
        LEFT  JOIN   rgdb."DbT4001JukyushaDaicho" AS 受給者台帳
        ON A."hihokenshaNo" = 受給者台帳."hihokenshaNo"
        LEFT  JOIN   rgdb."DbT4016HomonKaigoRiyoshaFutangakuGengaku" AS 訪問介護利用者負担額減額
        ON A."hihokenshaNo" = 訪問介護利用者負担額減額."hihokenshaNo"
        LEFT JOIN rgdb."DbT3105SogoJigyoTaishosha" AS 総合事業対象者
        ON A."hihokenshaNo" = 総合事業対象者."hihokenshaNo"
        WHERE
        1 = 1
        <if test="is対象リスト_該当者リスト">
            <if test="is受給者区分_受給者">
                AND (受給者台帳."ninteiYukoKikanKaishiYMD" <![CDATA[<=]]> #{課税判定等基準日} 
                AND #{課税判定等基準日} <![CDATA[<=]]> 受給者台帳."ninteiYukoKikanShuryoYMD"
                AND 受給者台帳."logicalDeletedFlag" = false
                AND 受給者台帳."yukoMukoKubun" = #{有効無効区分_有効})
            </if>
            <if test="is受給者区分_事業対象者">
                AND 総合事業対象者."tekiyoKaishiYMD" <![CDATA[<=]]> #{課税判定等基準日}
                AND #{課税判定等基準日} <![CDATA[<=]]> 総合事業対象者."tekiyoShuryoYMD"
                AND NOT (受給者台帳."ninteiYukoKikanKaishiYMD" <![CDATA[<=]]> #{課税判定等基準日} 
                AND #{課税判定等基準日} <![CDATA[<=]]> 受給者台帳."ninteiYukoKikanShuryoYMD"
                AND 受給者台帳."logicalDeletedFlag" = false
                AND 受給者台帳."yukoMukoKubun" = #{有効無効区分_有効})
            </if>
            <if test="is旧措置者区分_旧措置者">
                AND (受給者台帳."logicalDeletedFlag" = false
                AND 受給者情報."kyuSochishaFlag" = true )
            </if>
            <if test="is旧措置者区分_旧措置者以外">
                AND NOT EXIST (
                SELECT 1
                FROM
                rgdb."DbT4001JukyushaDaicho" AS J
                WHERE
                J."hihokenshaNo" = A."hihokenshaNo"
                AND J."logicalDeletedFlag" = false
                AND J."kyuSochishaFlag" = true
                )
            </if>
        </if>
        <if test="is対象リスト_認定者リスト">
            <if test="is対象期間指定_対象年度">
                AND 訪問介護利用者負担額減額."ketteiKubun" = #{決定区分_承認する}
                AND #{対象年度の開始年月日} <![CDATA[<=]]> 訪問介護利用者負担額減額."tekiyoKaishiYMD"
                AND 訪問介護利用者負担額減額."tekiyoShuryoYMD" <![CDATA[<=]]> #{対象年度の終了年月日}
            </if>
            <if test="is対象期間指定_基準日">
                AND 訪問介護利用者負担額減額."ketteiKubun" = #{決定区分_承認する}
                AND 訪問介護利用者負担額減額."tekiyoKaishiYMD" <![CDATA[<=]]> #{基準日}
                AND #{基準日} <![CDATA[<=]]> 訪問介護利用者負担額減額."tekiyoShuryoYMD"
            </if>
        </if>
    </select>
    <resultMap id="resultMap_get訪問介護利用者負担額減額認定者リスト"  type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00003.NinteishaListSakuseiEntity" autoMapping="true">
        <result property="被保険者番号" column="被保険者番号"  typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="本人課税区分" column="本人課税区分"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="is老齢福祉年金受給者" column="is老齢福祉年金受給者"  typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="is所得税課税者" column="is所得税課税者"  typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="is生活保護受給者" column="is生活保護受給者"  typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <result property="要介護認定申請情報_厚労省IF識別コード" column="要介護認定申請情報_厚労省IF識別コード"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="要介護認定申請情報_2号特定疾病コード" column="要介護認定申請情報_2号特定疾病コード"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="受給者台帳Newest_旧措置者フラグ" column="受給者台帳Newest_旧措置者フラグ"  typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
        <association property="総合事業対象者情報Entity" resultMap="resultMap_総合事業対象者情報"/>
        <association property="認定情報Entity" resultMap="resultMap_認定情報"/>
        <association property="訪問介護利用者負担額減額" resultMap="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.basic.IDbT4016HomonKaigoRiyoshaFutangakuGengakuMapper.ResultMap_DbT4016HomonKaigoRiyoshaFutangakuGengakuEntity"/>
        <association property="減免減額申請" resultMap="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.basic.IDbT4010GemmenGengakuShinseiMapper.ResultMap_DbT4010GemmenGengakuShinseiEntity"/>
        <association property="psmEntity" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>
        <collection property="世帯員リスト" resultMap="resultMap_setaiinshotokujoho"/>
    </resultMap>
    <resultMap id="resultMap_総合事業対象者情報"  type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00003.SougouJigyouTaisyoSyaEntity" autoMapping="true">
        <result property="総合事業対象者情報_被保険者番号" column="総合事業対象者情報_被保険者番号"  typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="総合事業対象者情報_チェックリスト実施日" column="総合事業対象者情報_チェックリスト実施日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="総合事業対象者情報_適用開始年月日" column="総合事業対象者情報_適用開始年月日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="総合事業対象者情報_適用終了年月日" column="総合事業対象者情報_適用終了年月日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    </resultMap>
    <resultMap id="resultMap_認定情報"  type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00003.NinnteiJohoEntity" autoMapping="true">
        <result property="認定情報_被保険者番号" column="認定情報_被保険者番号"  typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="認定情報_要介護状態区分コード" column="認定情報_要介護状態区分コード"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="認定情報_認定年月日" column="認定情報_認定年月日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="認定情報_認定有効期間開始年月日" column="認定情報_認定有効期間開始年月日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="認定情報_認定有効期間終了年月日" column="認定情報_認定有効期間終了年月日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
    </resultMap>
    <resultMap id="resultMap_setaiinshotokujoho"  type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt00003.SetaiInRisutoEntity" autoMapping="true">
        <result property="識別コード" column="shikibetsuCode"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="課税区分" column="kazeiKubun"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="課税所得額" column="kazeiShotokuGaku"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <association property="世帯員宛名" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>    
        
    </resultMap>
    <select resultOrdered="true" id="get訪問介護利用者負担額減額認定者リスト"
            parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.dbdbt00003.NinteishaListSakuseiMybatisParameter"
            resultMap="resultMap_get訪問介護利用者負担額減額認定者リスト"
            fetchSize="500">
        SELECT
            A.被保険者番号 AS 被保険者番号,
            A.本人課税区分 AS 本人課税区分,
            A.is老齢福祉年金受給者 AS is老齢福祉年金受給者,
            A.is所得税課税者 AS is所得税課税者,
            A.is生活保護受給者 AS is生活保護受給者,
            <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.columns_ShikibetsuTaisho"/>,
            認定情報.*,
            要介護認定申請情報."koroshoIfShikibetsuCode" AS 要介護認定申請情報_厚労省IF識別コード,
            要介護認定申請情報."nigoTokuteiShippeiCode" AS 要介護認定申請情報_2号特定疾病コード,
            受給者台帳Newest."kyuSochishaFlag" AS 受給者台帳Newest_旧措置者フラグ,
            訪問介護利用者負担額減額.*,
            減免減額申請.*,
            総合事業対象者情報.*,
            世帯員情報.*
        FROM
            "taishoShaHanteiYoukonkyoItokiTemp" A
            INNER JOIN  <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.tableName_PsmShikibetsuTaisho" />
            AS <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" /> 
            ON <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" /> ."shikibetsuCode" = A."本人識別コード"
        <!--受給認定の情報を取得-->
        LEFT JOIN (
                    SELECT
                        有効受給認定結果."hihokenshaNo"  AS 認定情報_被保険者番号,
                        有効受給認定結果."yokaigoJotaiKubunCode" AS 認定情報_要介護状態区分コード,
                        有効受給認定結果."ninteiYMD"  AS 認定情報_認定年月日,
                        有効受給認定結果."ninteiYukoKikanKaishiYMD" AS 認定情報_認定有効期間開始年月日,
                        有効受給認定結果."ninteiYukoKikanShuryoYMD" AS 認定情報_認定有効期間終了年月日
                    FROM (
                        SELECT
                        *,
                        ROW_NUMBER() OVER (ORDER BY "ninteiYMD" DESC) AS 受給者台帳_番号
                        FROM
                        rgdb."DbT4001JukyushaDaicho" AS 受給者台帳
                        WHERE
                        受給者台帳."ninteiYukoKikanKaishiYMD" <![CDATA[<=]]> #{課税判定等基準日}
                        AND  #{課税判定等基準日} <![CDATA[<=]]> 受給者台帳."ninteiYukoKikanShuryoYMD"
                        AND 受給者台帳."logicalDeletedFlag" = false
                        AND 受給者台帳."yukoMukoKubun" = #{有効無効区分_有効}
                    ) AS 有効受給認定結果
                    WHERE
                    有効受給認定結果.受給者台帳_番号 = 1
                ) AS 認定情報
        ON 認定情報."認定情報_被保険者番号" = A."被保険者番号"
        LEFT JOIN
                rgdb."DbT4101NinteiShinseiJoho" AS 要介護認定申請情報
                ON 認定情報."認定情報_被保険者番号"  = 要介護認定申請情報."hihokenshaNo"
        <!--旧措置者かどうかの判断のため、最新の受給者台帳を取得-->
        LEFT JOIN
                rgdb."DbV4001JukyushaDaicho" AS 受給者台帳Newest
                ON 受給者台帳Newest."hihokenshaNo" = A."被保険者番号"
        LEFT JOIN
                rgdb."DbT4016HomonKaigoRiyoshaFutangakuGengaku" AS 訪問介護利用者負担額減額
                ON 訪問介護利用者負担額減額."hihokenshaNo" = A."被保険者番号"
        LEFT JOIN
                rgdb."DbT4010GemmenGengakuShinsei" AS 減免減額申請
                ON 減免減額申請."hihokenshaNo" = 訪問介護利用者負担額減額."hihokenshaNo"
                AND 減免減額申請."shinseiRirekiNo" = 訪問介護利用者負担額減額."rirekiNo"
        <!--世帯員の情報を取得-->
        LEFT JOIN (
            SELECT
                世帯員所得情報一時."hihokenshaNo",
                世帯員所得情報一時."shikibetsuCode",
                世帯員所得情報一時."kazeiKubun",
                世帯員所得情報一時."kazeiShotokuGaku",
                 <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.columns_ShikibetsuTaisho" />
            FROM 
                "TmpSetaiShotoku" AS 世帯員所得情報一時
            INNER JOIN  <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.tableName_PsmShikibetsuTaisho" />
                AS <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" /> 
                ON <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" /> ."shikibetsuCode" = 世帯員所得情報一時."shikibetsuCode"
            WHERE
                世帯員所得情報一時."honninKubun" <![CDATA[<>]]> '1'
                <if test="世帯表示_表示しない">
                    AND false
                </if>
         ) AS 世帯員情報
         ON 世帯員情報."hihokenshaNo" = A."被保険者番号"
      <!--  <if test="世帯表示_表示しない">-->
            <!-- 総合事業対象者の情報を取得-->
            LEFT JOIN  (
                        SELECT
                            総合事業対象者."hihokenshaNo" AS 総合事業対象者情報_被保険者番号,
                            総合事業対象者."checklistJisshiYMD" AS 総合事業対象者情報_チェックリスト実施日,
                            総合事業対象者."tekiyoKaishiYMD" AS 総合事業対象者情報_適用開始年月日,
                            総合事業対象者."tekiyoShuryoYMD" AS 総合事業対象者情報_適用終了年月日
                        FROM
                            rgdb."DbT3105SogoJigyoTaishosha" AS 総合事業対象者
                        WHERE
                            総合事業対象者."tekiyoKaishiYMD" <![CDATA[<=]]> #{課税判定等基準日}
                            AND #{課税判定等基準日} <![CDATA[<=]]> 総合事業対象者."tekiyoShuryoYMD"
                    ) AS 総合事業対象者情報
                        ON A."被保険者番号" = 総合事業対象者情報."総合事業対象者情報_被保険者番号"
                    WHERE
                        (減免減額申請."gemmenGengakuShurui" = #{減免減額種類_訪問介護利用者負担額減額}
                        OR 減免減額申請."gemmenGengakuShurui" IS NULL )
                        AND (訪問介護利用者負担額減額."hihokenshaNo" IS NULL
                    OR (
                        1=1
                        <if test="is対象期間指定_対象年度">
                            AND (訪問介護利用者負担額減額."ketteiKubun" = #{決定区分_承認する}
                            AND #{対象年度の開始年月日} <![CDATA[<=]]> 訪問介護利用者負担額減額."tekiyoKaishiYMD"
                            AND 訪問介護利用者負担額減額."tekiyoShuryoYMD" <![CDATA[<=]]> #{対象年度の終了年月日} )
                            OR ((訪問介護利用者負担額減額."ketteiKubun" is null or 訪問介護利用者負担額減額."ketteiKubun" = '')
                                AND #{対象年度の開始年月日} <![CDATA[<=]]> 訪問介護利用者負担額減額."shinseiYMD"
                                AND 訪問介護利用者負担額減額."shinseiYMD" <![CDATA[<=]]> #{対象年度の終了年月日})
                        </if>

                        <if test="is対象期間指定_基準日">
                            AND (訪問介護利用者負担額減額."ketteiKubun" = #{決定区分_承認する}
                            訪問介護利用者負担額減額."tekiyoKaishiYMD" <![CDATA[<=]]> #{基準日}
                            AND #{基準日} <![CDATA[<=]]> 訪問介護利用者負担額減額."tekiyoShuryoYMD")
                            OR (訪問介護利用者負担額減額."ketteiKubun" IS NULL 
                            AND 訪問介護利用者負担額減額."shinseiYMD" <![CDATA[<=]]> #{基準日} )
                        </if>                  
                    )                   
            ) 
        <if test="is対象リスト_該当者リスト">
            <if test="is世帯非課税等_市町村民税非課税世帯">
                AND A.世帯課税区分 = #{世帯課税区分_非課税}
            </if>
            <if test="is世帯非課税等_所得税非課税世帯">
                AND A.is所得税課税世帯 = FALSE 
            </if>
            <if test="is世帯非課税等_市町村民税本人非課税者">
                AND A.本人課税区分 = '1'
            </if>
            <if test="is世帯非課税等_老齢福祉年金受給者">
                AND A.is老齢福祉年金受給者 = TRUE
            </if>
            <if test="is世帯非課税等_生活保護受給者">
                AND A.is生活保護受給者 = TRUE
            </if>
        </if>         
        <if test="is対象リスト_認定者リスト">
           <if test="is法別区分_全て">
                AND 訪問介護利用者負担額減額."hobetsuKubun"
                IN (#{法別区分施行時} , #{法別区分障害時},#{法別区分障害全額免除})
            </if>
            <if test="is法別区分施行時">
                AND 訪問介護利用者負担額減額."hobetsuKubun" = #{法別区分施行時}
            </if>
            <if test="is法別区分_障害時">
                AND 訪問介護利用者負担額減額."hobetsuKubun" = #{法別区分障害時}
            </if>
            <if test="is法別区分_障害ヘルプ全額免除">
                AND 訪問介護利用者負担額減額."hobetsuKubun" = #{法別区分障害全額免除}
            </if>
        </if>
        <!--#{出力順}-->
</select>
</mapper>
