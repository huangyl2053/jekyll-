<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--@reamsid_L DBD-3530-080 mawy-->

<mapper namespace="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.relate.gemmen.shinseisho.hakko.IFutanGendogakuOshiraseTsuchiHakkoMapper">
 <resultMap id="resultMap_get出力対象者情報Entity"  type="jp.co.ndensan.reams.db.dbd.entity.db.relate.gemmen.shinseisho.hakko.FutanGendogakuOshiraseTsuchiHakkoEntity" autoMapping="true">
     <result property="被保険者番号" column="被保険者番号"  typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
     <result property="識別コード" column="識別コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.ShikibetsuCodeTypeHandler"/>
     <result property="旧措置者フラグ" column="旧措置者フラグ" typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
     <result property="更新認定フラグ" column="更新認定フラグ"  typeHandler="org.apache.ibatis.type.BooleanTypeHandler"/>
     <result property="郵便番号" column="郵便番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.YubinNoTypeHandler"/>
     <result property="町域コード" column="町域コード"   typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.ChoikiCodeTypeHandler"/>
     <result property="行政区コード" column="行政区コード"   typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.GyoseikuCodeTypeHandler"/>
     <result property="氏名カナ"  column="氏名カナ"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
     <result property="生年月日"  column="生年月日"  typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
     <association property="宛名" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>
     <association property="宛先" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt250FindAtesakiMapper.resultAtesakiEntity"/>
 </resultMap>
  <select resultOrdered="true" id="get出力対象者情報"  
              resultMap="resultMap_get出力対象者情報Entity" 
              parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.gemmen.shinseisho.hakko.FutanGendogakuMybatisParameter"
              fetchSize="500">
      WITH master AS(
      SELECT 
             E."hihokenshaNo" AS 被保険者番号,
             E."shikibetsuCode" AS 識別コード,
             H."kyuSochishaFlag" AS 旧措置者フラグ ,
             E."willBeRenewed" AS 更新認定フラグ,
             I."nyushoShisetsuCode" AS 指定事業者番号,
             J."keikakuJigyoshaNo" AS 計画事業者番号,
             <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt250FindAtesakiMapper.columns_Atesaki"/>
       FROM  
             rgdb."DbT4032ShinseishoIkkatsuHakkoBatch"	 AS A
             INNER JOIN rgdb."DbT4033ShinseishoHakkoTaishoshas"  AS D
             ON  D."hakkoShoriID" = A."hakkoShoriID"
             INNER JOIN rgdb."DbT4031ShinseishoHakkoKohoshas"  AS E
             ON  E."haakuShoriID" =A."haakuShoriId"
             AND E."hihokenshaNo" = D."hihokenshaNo"
             AND E."willBeRenewed" IS TRUE 
             INNER JOIN rgua."UaFt250FindAtesaki"('DB','DBB','','true','','','true','true','true','true',#{基準日}) AS "Atesaki"
             ON "Atesaki"."shikibetsuCode" =E."shikibetsuCode"
             LEFT JOIN rgdb."DbV4001JukyushaDaicho" AS H
             ON H."hihokenshaNo" =E."hihokenshaNo"
             AND H."ninteiYMD" <![CDATA[<=]]>#{基準日}
             AND H."logicalDeletedFlag" IS FALSE 
       LEFT JOIN (
       SELECT 
       I1."shikibetsuCode",
       I1."nyushoShisetsuCode"
       FROM 
       rgdb."DbT1004ShisetsuNyutaisho" AS I1
       WHERE
       I1."taishoYMD" IS NULL
       AND I1."daichoShubetsu" ='1'
       AND I1."nyushoYMD" =(SELECT MAX(I2."nyushoYMD")
                            FROM  rgdb."DbT1004ShisetsuNyutaisho" AS I2
                            WHERE
                            I1."shikibetsuCode" =I2."shikibetsuCode"
                            AND I2."taishoYMD" IS NULL 
                            AND I2."daichoShubetsu" ='1'
                            )
        )AS I
        ON I."shikibetsuCode" = E."shikibetsuCode"
        LEFT JOIN
        (SELECT "hihokenshaNo",
                "keikakuJigyoshaNo"
         FROM  (SELECT "hihokenshaNo",                    
                       "keikakuJigyoshaNo",
                       "taishoYM",
                       "rirekiNo",
                       row_number() OVER (PARTITION BY "hihokenshaNo" ORDER BY "taishoYM" DESC,"rirekiNo" DESC) AS rrkno
                FROM   rgdb."DbT3006KyotakuKeikakuJigyoshaSakusei" 
                ) AS T3006
         WHERE rrkno=1
         )AS J
       ON J."hihokenshaNo" = E."hihokenshaNo"
       WHERE  
             A."hakkoShoriID" =#{発行処理ID}
             )
       SELECT 
       master.*,
       "ShikibetsuTaisho"."yubinNo" AS 郵便番号,
       "ShikibetsuTaisho"."choikiCode" AS 町域コード,
       "ShikibetsuTaisho"."gyoseikuCode" AS 行政区コード,
       "ShikibetsuTaisho"."kanaShimei" AS 氏名カナ,
       "ShikibetsuTaisho"."seinengappiYMD" AS 生年月日,
       <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.columns_ShikibetsuTaisho"/>
       FROM 
       master
       INNER JOIN  rgua."UaFt200FindShikibetsuTaisho"('',#{基準日},FALSE,'DB',FALSE,'','','','','','','','','','','',true,
        '','','','','','','',true,'','','','','','','','','','','',true,true,true,true,true,true,true,true,true,true,
        true,'','','','','','','','',true,'','',true,true,true,'','','','','','','','','','','','','','','','','','',
               (SELECT 
               ARRAY_AGG(CAST(識別コード  AS TEXT))
               FROM 
               master
               )
               ) AS "ShikibetsuTaisho"
             ON "ShikibetsuTaisho"."shikibetsuCode" = master.識別コード
       ${出力順}
</select>
</mapper>