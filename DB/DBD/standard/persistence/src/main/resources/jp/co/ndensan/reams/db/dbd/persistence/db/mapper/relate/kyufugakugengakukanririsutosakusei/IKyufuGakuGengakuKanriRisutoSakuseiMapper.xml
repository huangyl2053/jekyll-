<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBD-3800-050 x_xuliang -->
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->

<mapper namespace="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.relate.kyufugakugengakukanririsutosakusei.IKyufuGakuGengakuKanriRisutoSakuseiMapper">
    
    <resultMap id="resultMap_TaishoShaKanriJohoEntity" type="jp.co.ndensan.reams.db.dbd.entity.db.relate.dbdbt32004.TaishoShaKanriJohoEntity" autoMapping="true">
        <result property="hihokenshaNo" column="hihokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
    </resultMap>
        
    <select id="get対象者管理情報の取得" 
            parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.dbdbt32004.TaishoShaKanriJohoMybatisParameter"
            resultMap="resultMap_TaishoShaKanriJohoEntity" 
            fetchSize="500" resultOrdered="true">
        SELECT DISTINCT
        収納滞納状況一時テーブル."tmp_hihokenshaNo" AS "hihokenshaNo"
        FROM
        "ShunoJokyoTemp" AS 収納滞納状況一時テーブル
            INNER JOIN rgdb."DbT4021ShiharaiHohoHenko" AS 支払方法変更
            ON 収納滞納状況一時テーブル."tmp_hihokenshaNo" = 支払方法変更."hihokenshaNo" AND
            支払方法変更."kanriKubun" = '3' AND
            支払方法変更."tekiyoKaishiYMD" <![CDATA[<=]]> #{システム日付} AND
            支払方法変更."tekiyoShuryoYMD" <![CDATA[>=]]> #{システム日付} AND
            支払方法変更."logicalDeletedFlag" = 'false'
            
        <if test="is対象区分_全登録者以外">
            <if test="is通知書未発行者抽出">
                AND (支払方法変更."gemmen_TsuchiHakkoYMD" is null or rgdb.支払方法変更."gemmen_TsuchiHakkoYMD"='')
            </if>
            <if test="is減額適用中者抽出">
                INNER JOIN rgdb."DbT4025ShiharaiHohoHenkoGengaku" AS 支払方法変更減額1
                ON 支払方法変更."shoKisaiHokenshaNo" = 支払方法変更減額1."shoKisaiHokenshaNo" AND
                支払方法変更."hihokenshaNo" = 支払方法変更減額1."hihokenshaNo" AND
                支払方法変更."kanriKubun" = 支払方法変更減額1."kanriKubun" AND
                支払方法変更."rirekiNo" = 支払方法変更減額1."rirekiNo" AND
                支払方法変更減額1."kakutei_GengakuKaishiYMD" <![CDATA[<=]]> #{減額適用中者抽出基準日}  AND
                支払方法変更減額1."kakutei_GengakuShuryoYMD" <![CDATA[>=]]> #{減額適用中者抽出基準日}
            </if>
            
            <if test="is減額終了日抽出">
                INNER JOIN rgdb."DbT4025ShiharaiHohoHenkoGengaku" AS 支払方法変更減額2
                ON 支払方法変更."shoKisaiHokenshaNo" = 支払方法変更減額2."shoKisaiHokenshaNo" AND
                支払方法変更."hihokenshaNo" = 支払方法変更減額2."hihokenshaNo" AND
                支払方法変更."kanriKubun" = 支払方法変更減額2."kanriKubun" AND
                支払方法変更."rirekiNo" = 支払方法変更減額2."rirekiNo" AND
                支払方法変更減額2."kakutei_GengakuKaishiYMD" <![CDATA[>=]]> #{減額終了日範囲From}  AND
                支払方法変更減額2."kakutei_GengakuShuryoYMD" <![CDATA[<=]]> #{減額終了日範囲To}
            </if>
        </if>
        WHERE
        収納滞納状況一時テーブル."tmp_jikoKisanYMD" <![CDATA[>]]> #{基準日の2年前} 
        AND 収納滞納状況一時テーブル."tmp_minoKannoKubun" = #{未納完納区分_未納あり}
        <if test="is対象区分_全登録者以外"> 
            AND 収納滞納状況一時テーブル."tmp_minogaku" > 0  
        </if>
        
            <if test="is保険料完納者出力">
                UNION SELECT
                A."tmp_hihokenshaNo"  AS "hihokenshaNo"
                FROM "ShunoJokyoTemp" A
                WHERE NOT EXISTS (
                SELECT 1
                FROM "ShunoJokyoTemp" B
                WHERE B."tmp_hihokenshaNo" = A."tmp_hihokenshaNo"
                AND B."tmp_minoKannoKubun" = #{未納完納区分_未納あり}
                )
            </if>
    </select>

</mapper>
