<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBD-5080-030 mawy -->

<!-- どのマッパーインターフェースと対応するかを指定する -->
<mapper namespace="jp.co.ndensan.reams.db.dbd.persistence.db.mapper.relate.hanyorisutojigyotaishosha.IHanyoRisutoJigyoTaishoshaMapper">
     <resultMap id="resultMap_HanyoRisutoJigyoTaishoshaEntity" type="jp.co.ndensan.reams.db.dbd.entity.db.relate.hanyorisutojigyotaishosha.HanyoRisutoJigyoTaishoshaEntity" autoMapping="true">
        <result property="被保険者台帳管理_識別コード" column="被保険者台帳管理_識別コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
         <result property="被保険者台帳管理_市町村コード" column="被保険者台帳管理_市町村コード" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="二次予防事業対象者_被保険者番号" column="二次予防事業対象者_被保険者番号" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="二次予防事業対象者_履歴番号" column="二次予防事業対象者_履歴番号" typeHandler="org.apache.ibatis.type.IntegerTypeHandler"/>
        <result property="二次予防事業対象者_適用開始年月日" column=" 二次予防事業対象者_適用開始年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="二次予防事業対象者_適用終了年月日" column=" 二次予防事業対象者_適用終了年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="二次予防事業対象者_チェックリスト実施日" column="二次予防事業対象者_チェックリスト実施日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="二次予防事業対象者_決定年月日" column="二次予防事業対象者_決定年月日" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <association property="psmEntity" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>
        <association property="atesakiEntity" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt250FindAtesakiMapper.resultAtesakiEntity"/>
     </resultMap>
     <select resultOrdered="true" id="get汎用リスト"
            resultMap="resultMap_HanyoRisutoJigyoTaishoshaEntity"
            parameterType="jp.co.ndensan.reams.db.dbd.definition.mybatisprm.hanyorisutojigyotaishosha.HanyoRisutoJigyoTaishoshaMybatisParameter"
            fetchSize="500">
WITH master AS (          
         SELECT	
            最新被保台帳."shikibetsuCode" AS 被保険者台帳管理_識別コード,				
            最新被保台帳."shichosonCode" AS 被保険者台帳管理_市町村コード,
            二次予防事業対象者."hihokenshaNo" AS 二次予防事業対象者_被保険者番号,
            二次予防事業対象者."rirekiNo" AS 二次予防事業対象者_履歴番号,
            二次予防事業対象者."tekiyoKaishiYMD" AS 二次予防事業対象者_適用開始年月日,
            二次予防事業対象者."tekiyoShuryoYMD" AS 二次予防事業対象者_適用終了年月日,
            二次予防事業対象者."chosaJisshiYMD" AS 二次予防事業対象者_チェックリスト実施日,
            二次予防事業対象者."ketteiYMD" AS 二次予防事業対象者_決定年月日,
            <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt250FindAtesakiMapper.columns_Atesaki" />												
	FROM																
		rgdb."DbT3100NijiYoboJigyoTaishosha" AS 二次予防事業対象者										
																	
		INNER JOIN															
			rgdb."DbV1001HihokenshaDaicho" AS 最新被保台帳														
			ON  最新被保台帳."hihokenshaNo" = 二次予防事業対象者."hihokenshaNo"
                INNER JOIN
                <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt250FindAtesakiMapper.tableName_PsmAtesaki" /> AS "Atesaki"
                ON "Atesaki"."shikibetsuCode" = 最新被保台帳."shikibetsuCode"
                <if test="isJigyotaishoshacyusyutsu">											
			INNER JOIN (
                              SELECT
                                "hihokenshaNo", "rirekiNo"
                                     FROM (
                                         SELECT * , ROW_NUMBER() OVER(PARTITION BY "hihokenshaNo" ORDER BY "rirekiNo" DESC) AS 二次予防事業対象者_番号									
					FROM
                                            rgdb."DbT3100NijiYoboJigyoTaishosha" AS 二次予防事業対象者3
					WHERE
                                            二次予防事業対象者3."isDeleted" = false											
					) AS a
                                       WHERE
                                       二次予防事業対象者_番号 = '1'
                    ) AS 二次予防事業対象者2
                    ON (二次予防事業対象者2."hihokenshaNo" = 二次予防事業対象者."hihokenshaNo"
                    AND 二次予防事業対象者2."rirekiNo" = 二次予防事業対象者."rirekiNo")													
                </if>														
	     WHERE 二次予防事業対象者."isDeleted" = false	
            <if test="is基準日">
                AND ((二次予防事業対象者."tekiyoShuryoYMD" IS NOT NULL
                AND  二次予防事業対象者."tekiyoKaishiYMD"<![CDATA[<=]]> #{kizyunnichi}
                AND  #{kizyunnichi} <![CDATA[<=]]>二次予防事業対象者."tekiyoShuryoYMD")
                OR (二次予防事業対象者."tekiyoShuryoYMD" IS NULL
                AND #{kizyunnichi} <![CDATA[<=]]> 二次予防事業対象者."tekiyoKaishiYMD"))
            </if>
            <if test="is範囲">
                <if test="is適用開始日 and has日付範囲From">
                    AND #{hitsukehanifrom} <![CDATA[<=]]> 二次予防事業対象者."tekiyoKaishiYMD"
                </if>
                <if test="is適用開始日 and has日付範囲To">
                    AND 二次予防事業対象者."tekiyoKaishiYMD" <![CDATA[<=]]> #{hitsukehanito}
                </if>
                <if test="is適用終了日 and has日付範囲From">
                    AND #{hitsukehanifrom} <![CDATA[<=]]> 二次予防事業対象者."tekiyoShuryoYMD"
                </if>
                <if test="is適用終了日 and has日付範囲To">
                    AND 二次予防事業対象者."tekiyoShuryoYMD" <![CDATA[<=]]> #{hitsukehanito}
                </if>
                <if test="isチェックリスト実施日 and has日付範囲From">
                    AND #{hitsukehanifrom} <![CDATA[<=]]> 二次予防事業対象者."chosaJisshiYMD"
                </if>
                <if test="isチェックリスト実施日 and has日付範囲To">
                    AND 二次予防事業対象者."chosaJisshiYMD" <![CDATA[<=]]> #{hitsukehanito}
                </if>
            </if>
            <if test="has市町村コード">
                AND (最新被保台帳."shichosonCode" = #{市町村コード}
                OR 最新被保台帳."koikinaiTokureiSochimotoShichosonCode" = #{市町村コード})
            </if>
        )
             SELECT
              master.*,
              <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.columns_ShikibetsuTaisho" />
              FROM master
              LEFT OUTER JOIN
                    <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.multi.IUaFt200FindShikibetsuTaishoFunctionMultiParameterMapper.tableName_PsmParamClassWithoutShikibetsuCodeList_First" />
                     (
                          SELECT ARRAY_AGG(CAST ("被保険者台帳管理_識別コード" AS TEXT))
                          FROM master
                     )
                    <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.multi.IUaFt200FindShikibetsuTaishoFunctionMultiParameterMapper.tableName_PsmParamClassWithoutShikibetsuCodeList_Second" />
                    AS "ShikibetsuTaisho"
                    ON 被保険者台帳管理_識別コード = "ShikibetsuTaisho"."shikibetsuCode"
                <if test="is年齢">
                    <if test="has年齢From">
                        AND "ShikibetsuTaisho"."seinengappiYMD" <![CDATA[<=]]> #{年齢From年月日}
                    </if>
                    <if test="has年齢To">
                        AND #{年齢To年月日} <![CDATA[<=]]> "ShikibetsuTaisho"."seinengappiYMD"
                    </if>
                </if>
                <if test="is生年月日">
                    <if test="has生年月日From">
                        AND #{生年月日From} <![CDATA[<=]]> "ShikibetsuTaisho"."seinengappiYMD"
                    </if>
                    <if test="has生年月日To">
                        AND "ShikibetsuTaisho"."seinengappiYMD" <![CDATA[<=]]> #{生年月日To}
                    </if>
               </if>		
                <if test="is住所">
                    <if test="has地区選択From">
                        AND #{地区選択コードFrom} <![CDATA[<=]]> "ShikibetsuTaisho"."choikiCode"
                    </if>
                    <if test="has地区選択To">
                        AND "ShikibetsuTaisho"."choikiCode" <![CDATA[<=]]> #{地区選択コードTo}
                    </if>
                </if>
                <if test="is行政区">
                    <if test="has行政区From">
                        AND #{地区選択コードFrom} <![CDATA[<=]]> "ShikibetsuTaisho"."gyoseikuCode"
                    </if>
                    <if test="has行政区To">
                         AND "ShikibetsuTaisho"."gyoseikuCode" <![CDATA[<=]]> #{地区選択コードTo}
                    </if>
                </if>
                <if test="is地区">
                    <if test="has地区1From">
                        AND #{地区選択コードFrom} <![CDATA[<=]]> "ShikibetsuTaisho"."chikuCode1"
                    </if>
                    <if test="has地区1To">
                        AND "ShikibetsuTaisho"."chikuCode1" <![CDATA[<=]]> #{地区選択コードTo}
                    </if>
                    <if test="has地区2From">
                        AND #{地区選択コードFrom} <![CDATA[<=]]> "ShikibetsuTaisho"."chikuCode2"
                    </if>
                    <if test="has地区2To">
                        AND "ShikibetsuTaisho"."chikuCode2" <![CDATA[<=]]> #{地区選択コードTo}
                    </if>
                    <if test="has地区3From">
                        AND #{地区選択コードFrom} <![CDATA[<=]]> "ShikibetsuTaisho"."chikuCode3"
                    </if>
                    <if test="has地区3To">
                        AND "ShikibetsuTaisho"."chikuCode3" <![CDATA[<=]]> #{地区選択コードTo}
                    </if>
                </if>
     </select>
</mapper>
