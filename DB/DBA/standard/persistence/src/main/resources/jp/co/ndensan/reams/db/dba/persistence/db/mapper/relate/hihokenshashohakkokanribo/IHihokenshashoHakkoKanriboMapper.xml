<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBA-0600-020 zhangguopeng -->
<mapper namespace="jp.co.ndensan.reams.db.dba.persistence.db.mapper.relate.hihokenshashohakkokanribo.IHihokenshashoHakkoKanriboMapper">

    <resultMap id="resultMap_get証発行管理リスト情報" type="jp.co.ndensan.reams.db.dba.entity.db.relate.hihokenshashohakkokanribo.AkasiHakouKanriEntity" autoMapping="true">
        <id property="hihokenshaNo" column="shoKofuKaishu_hihokenshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shichosonCode" column="shoKofuKaishu_shichosonCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.LasdecCodeTypeHandler"/>
        <result property="shikibetsuCode" column="shoKofuKaishu_shikibetsuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.ShikibetsuCodeTypeHandler"/>
        <result property="kofuYMD" column="shoKofuKaishu_kofuYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="yukoKigenYMD" column="shoKofuKaishu_yukoKigenYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="kofuJiyu" column="shoKofuKaishu_kofuJiyu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="kaishuYMD" column="shoKofuKaishu_kaishuYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="kaishuJiyu" column="shoKofuKaishu_kaishuJiyu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shoYoshikiKubunCode" column="shoKofuKaishu_shoYoshikiKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="meisho" column="psm_meisho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="yubinNo" column="psm_yubinNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="jusho" column="psm_jusho" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>

        <result property="pageBreakItem1" column="pageBreakItem1" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="pageBreakItem2" column="pageBreakItem2" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="pageBreakItem3" column="pageBreakItem3" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="pageBreakItem4" column="pageBreakItem4" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="pageBreakItem5" column="pageBreakItem5" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>

    <select resultOrdered="true" id="get証発行管理リスト情報"
            resultMap="resultMap_get証発行管理リスト情報"
            parameterType="jp.co.ndensan.reams.db.dba.definition.mybatisprm.hihokenshashohakkokanribo.HihokenshashoHakkoKanriboMybatisParameter" fetchSize="500">
        SELECT
            *,
            PSM."meisho" AS "psm_meisho",
            PSM."yubinNo" AS "psm_yubinNo",
            PSM."jusho" || PSM."banchi" || '('||PSM."gyoseikuName"||')' AS "psm_jusho"
            ${pageBreakItems}
        FROM (
            SELECT
            ShoKofuKaishu."hihokenshaNo" AS "shoKofuKaishu_hihokenshaNo",
            ShoKofuKaishu."shichosonCode" AS "shoKofuKaishu_shichosonCode",
            ShoKofuKaishu."shikibetsuCode" AS "shoKofuKaishu_shikibetsuCode",
            ShoKofuKaishu."kofuYMD" AS "shoKofuKaishu_kofuYMD",
            ShoKofuKaishu."yukoKigenYMD" AS "shoKofuKaishu_yukoKigenYMD",
            ShoKofuKaishu."kofuJiyu" AS "shoKofuKaishu_kofuJiyu",
            ShoKofuKaishu."kaishuYMD" AS "shoKofuKaishu_kaishuYMD",
            ShoKofuKaishu."kaishuJiyu" AS "shoKofuKaishu_kaishuJiyu",
            ShoKofuKaishu."shoYoshikiKubunCode" AS "shoKofuKaishu_shoYoshikiKubunCode",
            row_number() over(partition by "hihokenshaNo" order by "kofuYMD" desc, "lastUpdateTimestamp" desc) as rank_number
            FROM
            rgdb."DbT7037ShoKofuKaishu" AS ShoKofuKaishu
            WHERE
            ShoKofuKaishu."logicalDeletedFlag" = 'false'
            AND
            ShoKofuKaishu."kofuShoShurui" = #{akasihakouMod}
        <if test="iskoufukayisihi">
            AND ShoKofuKaishu."kofuYMD" <![CDATA[>=]]> #{koufukayisihi}
        </if>
        <if test="iskoufuShuryouhi">
            AND ShoKofuKaishu."kofuYMD" <![CDATA[<=]]> #{koufusiuryouhi}
        </if>
        <if test="iskaisyuKayisihi">
            AND ShoKofuKaishu."kaishuYMD" <![CDATA[>=]]> #{kasyuukayisihi}
        </if>
        <if test="iskaisyuShuryouhi">
            AND ShoKofuKaishu."kaishuYMD" <![CDATA[<=]]> #{kasyuusiuryouhi}
        </if>
            ) AS 処理対象
        LEFT JOIN
            rgua.${psmShikibetsuTaisho} AS PSM
            ON "shoKofuKaishu_shikibetsuCode" = PSM."shikibetsuCode"
        WHERE '1'='1'
        <if test="isSaisinJohoFlg">
            AND "rank_number" = '1'
        </if>
        <if test="kofuJiyulist.size() > 0">
            AND
            "shoKofuKaishu_kofuJiyu" IN
            <foreach
                collection="kofuJiyulist"
                item="code"
                open="("
                separator=","
                close=")">
                #{code}
            </foreach>
        </if>
        <if test="kaishuJiyulist.size() > 0">
            AND
            "shoKofuKaishu_kaishuJiyu" IN
            <foreach
                collection="kaishuJiyulist"
                item="code"
                open="("
                separator=","
                close=")">
                #{code}
            </foreach>
        </if>
        <if test="isMikaisyushaList">
            AND
            "shoKofuKaishu_kaishuYMD" = ''
        </if>
        ${shutsuryokujunOrderBy}
    </select>
</mapper>