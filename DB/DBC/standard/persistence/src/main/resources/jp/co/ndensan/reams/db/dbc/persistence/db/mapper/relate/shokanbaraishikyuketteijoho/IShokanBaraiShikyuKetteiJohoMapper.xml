<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBC-0980-350 gongliang -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.shokanbaraishikyuketteijoho.IShokanBaraiShikyuKetteiJohoMapper">

    <!-- 償還払支給決定情報一時TBLを作成します。 -->
    <insert id="create償還払支給決定情報一時TBL">
        CREATE TEMP TABLE "TABLE_SHOKANBARAISHIKYUKETTEIJOHO"
        (
        "kokanShikibetsuNo" rgdb."DbUDD009KokanShikibetsuNo",
        "zhangpiaoKindHead" varchar(20),
        "shoKisaiHokenshaNo" rgdb."DbUDD015ShoKisaiHokenshaNo",
        "baoxianzheName" varchar(20),
        "sakuseiYMD" rshare."UDD015YMD",
        "guobaolianhehuiName" varchar(20),
        "zhangpiaoKind" varchar(20),
        "no" varchar(20),
        "seiriNo" varchar(10),
        "hihokenshaNo" rgdb."DbUDD002HihokenshaNo",
        "hiHokenshaName" varchar(20),
        "serviceTeikyoYM" rshare."UDD015YMD",
        "jigyoshoNo" rgdb."DbUDD004JigyoshaNo",
        "jigyoshoName" varchar(20),
        "serviceShuruiCode" rgdb."DbUDD005ServiceShuruiCode",
        "serviceShuruiName" varchar(12),
        "tanisuKingaku" numeric(10,2),
        "shikyuKingaku" numeric(10,2),
        "zougenTanisu" integer,
        "shiharaiHohoKubunCode" varchar(1),
        "biko" varchar(20),
        "shikibetsuCode" rshare."UDD001ShikibetsuCode",
        "zenkokuJushoCode" rshare."UDD004ZenkokuJushoCode",
        "jusho" varchar(50),
        "gyoseikuCode" rshare."UDD008GyoseikuCode",
        "gyoseikuName" varchar(20),
        "shikakuSoshitsuJiyuCode" varchar(2),
        "shikakuSoshitsuYMD" rshare."UDD015YMD",
        "shikyuYMD" rshare."UDD015YMD",
        "shikyuKubunCode" varchar(1),
        "isUpdate" boolean
        )
    </insert>

    <!--  新被保険者番号一時テーブルを作成する。 -->
    <insert id="create新被保険者番号一時テーブル">
        CREATE TEMP TABLE "TABLE_SINHIHOKENSHABANGOICHIJI"
        (
        "shichosonCode" rshare."UDD023LasdecCode",
        "shinNo" rgdb."DbUDD002HihokenshaNo",
        "kyuNo" rgdb."DbUDD002HihokenshaNo"
        )
    </insert>

    <!-- 償還払請求集計一時テーブルを作成する。 -->
    <insert id="create償還払請求集計一時テーブル">
        CREATE TEMP TABLE "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI"
        (
        "hihokenshaNo" rgdb."DbUDD002HihokenshaNo",
        "serviceTeikyoYM" rshare."UDD015YMD",
        "seiriNo" varchar(10),
        "jigyoshoNo" rgdb."DbUDD004JigyoshaNo",
        "serviceShuruiCode" rgdb."DbUDD005ServiceShuruiCode",
        "shiharaiHohoKubunCode" varchar(1),
        "tanisuKingaku" numeric(10,2),
        "shikyuKingaku" numeric(10,2),
        "zougenTanisu" integer,
        "biko" varchar(20)
        )
    </insert>

    <!-- 新被保険者番号一時テーブルに登録する。 -->
    <insert id="insert新被保険者番号一時テーブル"
            parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.SinHiBokenIchijiEntity">
        INSERT INTO "TABLE_SINHIHOKENSHABANGOICHIJI"
        VALUES (
        #{市町村コード},
        #{新番号},
        #{旧番号}
        )
    </insert>

    <!-- 償還払支給決定情報一時TBLに登録する。 -->
    <insert id="insert償還払支給決定情報一時TBL"
            parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.ShokanBaraiShikyuKetteiJohoItijiEntity">
        INSERT INTO "TABLE_SHOKANBARAISHIKYUKETTEIJOHO"
        VALUES(
        #{交換情報識別番号}
        #{帳票レコード種別_ヘッダ}
        #{証記載保険者番号}
        #{保険者名}
        #{作成年月日}
        #{国保連合会名}
        #{帳票レコード種別}
        #{No}
        #{整理番号}
        #{被保険者番号}
        #{被保険者氏名_漢字}
        #{サービス提供年月}
        #{事業所番号}
        #{事業所名_漢字}
        #{サービス種類コード}
        #{サービス種類名}
        #{単位数／金額}
        #{支払金額}
        #{増減単位数}
        #{支払方法区分コード}
        #{備考}
        #{支給不支給区分}
        #{更新DB無}
        )
    </insert>

    <!-- 集計結果を償還払請求集計一時テーブルに登録する。 -->
    <insert id="insert償還払請求集計一時テーブル"
            parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.ShokanBaraShiketteiShuukeiEntity">
        INSERT INTO "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI"
        VALUES(
        #{被保険者番号},
        #{サービス提供年月},
        #{整理番号},
        #{事業所番号},
        #{サービス種類コード},
        #{支給区分コード},
        #{単位数_金額},
        #{支払金額},
        #{増減点},
        #{増減理由}
        )
    </insert>

    <resultMap id="resultMap_Shuukei" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.ShokanBaraShiketteiShuukeiEntity" autoMapping="true">
        <result property="被保険者番号" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="サービス提供年月" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="整理番号" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="事業所番号" column="jigyoshoNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.JigyoshaNoTypeHandler"/>
        <result property="サービス種類コード" column="serviceShuruiCode" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ServiceShuruiCodeTypeHandler"/>
        <result property="単位数_金額" column="tanisuKingaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="支払金額" column="shikyuKingakuShuukei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="増減点" column="zougenTanisu"/>
        <result property="増減理由" column="biko" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>

    <select resultOrdered="true" id="select一時TBL4集計" resultMap="resultMap_Shuukei" fetchSize="500">
        SELECT TEMP."hiHokenshaNo",
        TEMP."serviceTeikyoYM",
        TEMP."seiriNo",
        TEMP."jigyoshoNo",
        TEMP."serviceShuruiCode",
        SUM(TEMP."tanisuKingaku") AS tanisuKingaku,
        SUM(TEMP."shikyuKingakuShuukei") AS shikyuKingakuShuukei,
        SUM(TEMP."zougenTanisu") AS zougenTanisu,
        MAX(TEMP."biko") AS "biko",
        FROM "TABLE_SHOKANBARAISHIKYUKETTEIJOHO" AS TEMP
        GROUP BY
        TEMP."hiHokenshaNo",
        TEMP."serviceTeikyoYM",
        TEMP."seiriNo",
        TEMP."jigyoshoNo",
        TEMP."serviceShuruiCode"
    </select>

    <resultMap id="resultMap_ShokanHanteiKekka" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.ShokanBaraShiketteiJohoShuukeiEntity" autoMapping="true">
        <result property="交換情報識別番号" column="kokanShikibetsuNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.KokanShikibetsuNoTypeHandler"/>
        <result property="帳票レコード種別" column="zhangpiaoKindHead" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="証記載保険者番号" column="shoKisaiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ShoKisaiHokenshaNoTypeHandler"/>
        <result property="保険者名" column="baoxianzheName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="作成年月日" column="sakuseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="国保連合会名" column="guobaolianhehuiName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="no" column="no" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="整理番号" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者番号" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="サービス提供年月" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="支払金額" column="shikyuKingakuShuukei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="前回支払金額" column="zenkaiShiharaiKingakuShuukei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="差額金額合計" column="sagakuKingakuGokeiShuukei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>

    <!-- 償還払支給決定情報一時TBL集計4償還払支給判定結 -->
    <select resultOrdered="true" id="select一時TBL4償還払支給判定結果" resultMap="resultMap_ShokanHanteiKekka" fetchSize="500">
        SELECT TEMP."kokanShikibetsuNo",
        TEMP."zhangpiaoKindHead",
        TEMP."shoKisaiHokenshaNo",
        TEMP."baoxianzheName",
        TEMP."sakuseiYMD",
        TEMP."guobaolianhehuiName",
        TEMP."no",
        TEMP."seiriNo",
        TEMP."hiHokenshaNo",
        TEMP."serviceTeikyoYM",
        SUM(TEMP."shikyuKingaku") AS "shikyuKingakuShuukei",
        SUM(TEMP."shikyuKingaku") AS "zenkaiShiharaiKingakuShuukei",
        SUM(TEMP."shikyuKingaku") AS "sagakuKingakuGokeiShuukei"
        FROM "TABLE_SHOKANBARAISHIKYUKETTEIJOHO" AS TEMP
        GROUP BY
        TEMP."kokanShikibetsuNo",
        TEMP."zhangpiaoKindHead",
        TEMP."shoKisaiHokenshaNo",
        TEMP."baoxianzheName",
        TEMP."sakuseiYMD",
        TEMP."guobaolianhehuiName",
        TEMP."no",
        TEMP."seiriNo",
        TEMP."hiHokenshaNo",
        TEMP."serviceTeikyoYM"
    </select>

    <resultMap id="resultMap_Hihokensha" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.ShokanBaraiShikyuKetteiJohoItijiEntity" autoMapping="true">
        <result property="被保険者番号" column="hihokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
    </resultMap>

    <!-- 一時テーブルの被保険者番号の取得-->
    <select resultOrdered="true" id="select被保険者番号" resultMap="resultMap_Hihokensha" fetchSize="500">
        SELECT DISTINCT SHOKAN."hihokenshaNo"
        FROM "TABLE_SHOKANBARAISHIKYUKETTEIJOHO" AS SHOKAN
    </select>

    <resultMap id="resultMap_SinHihokenshaBangoIchijiEntity"
               type="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.SinHiBokenIchijiEntity"
               autoMapping="true">
        <result property="市町村コード" column="shichosonCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.LasdecCodeTypeHandler"/>
        <result property="新番号" column="shinNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="旧番号" column="kyuNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>

    <!-- 新旧被保険者番号を変換する -->
    <update id="update償還払支給決定情報一時TBL">
        UPDATE "TABLE_SHOKANBARAISHIKYUKETTEIJOHO"
        SET    "hihokenshaNo" = ICHIJI."shinNo"
        FROM   "TABLE_SINHIHOKENSHABANGOICHIJI" AS ICHIJI
        WHERE  "hihokenshaNo" = ICHIJI."kyuNo"
    </update>

    <!-- 償還払支給決定情報一時TBLの識別コードを更新する    -->
    <update id="update償還払支給決定情報一時TBL_識別コード"
            parameterType="jp.co.ndensan.reams.db.dbz.entity.db.basic.DbT1001HihokenshaDaichoEntity">
        UPDATE "TABLE_SHOKANBARAISHIKYUKETTEIJOHO"
        SET    "shikibetsuCode" = #{shikibetsuCode}
        SET    "shikakuSoshitsuJiyuCode"= #{shikakuSoshitsuJiyuCode}
        SET    "shikakuSoshitsuYMD" = #{shikakuSoshitsuYMD}
        WHERE  "hihokenshaNo" = #{hihokenshaNo}
    </update>
    
    <!-- 償還払支給決定情報一時TBLの宛名情報更新。 -->
    <update id="update償還払支給決定情報一時TBL_宛名"
            parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanbaraishikyuketteijoho.IShikibetsuTaishoPSMEntity">
        UPDATE "TABLE_SHOKANBARAISHIKYUKETTEIJOHO"
        SET     "zenkokuJushoCode" = #{全国住所コード},
        "jusho" = #{住所},
        "gyoseikuCode" = #{行政区コード},
        "gyoseikuName" = #{行政区名}
        WHERE "shikibetsuCode" = #{識別コード}
    </update>

    <!-- 償還払請求集計を更新する  -->
    <update id="update償還払請求集計">
        UPDATE rgdb."DbT3053ShokanShukei"
        SET    "shikyuKubunCode" = TEMP."shiharaiHohoKubunCode",
        "tensuKingaku" = TEMP."tanisuKingaku",
        "shikyuKingaku" = TEMP."shikyuKingaku",
        "zougenten" = TEMP."zougenTanisu",
        "zougenRiyu" = TEMP."biko"
        FROM   "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI" AS TEMP
        WHERE  "hiHokenshaNo" = TEMP."hihokenshaNo"
        AND    "serviceTeikyoYM" = TEMP."serviceTeikyoYM"
        AND    "seiriNo" = TEMP."seiriNo"
        AND    "jigyoshaNo" = TEMP."jigyoshoNo"
        AND    "serviceShuruiCode" = TEMP."serviceShuruiCode"
    </update>

    <!-- 償還払請求食事費用を更新する -->
    <update id="update償還払請求食事費用">
        UPDATE rgdb."DbT3043ShokanShokujiHiyo"
        SET    "shikyuKubunCode" = TEMP."shiharaiHohoKubunCode",
        "tensuKingaku" = TEMP."tanisuKingaku",
        "shikyuKingaku" = TEMP."shikyuKingaku",
        "zougenTen" = TEMP."zougenTanisu"
        FROM   "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI" AS TEMP
        WHERE  "hiHokenshaNo" = TEMP."hihokenshaNo"
        AND    "serviceTeikyoYM" = TEMP."serviceTeikyoYM"
        AND    "seiriNo" = TEMP."seiriNo"
        AND    "jigyoshaNo" = TEMP."jigyoshoNo"
        AND    TEMP."serviceShuruiCode" IS NULL
    </update>

    <!-- 償還払請求サービス計画200004を更新する -->
    <update id="update償還払請求サービス計画200004">
        UPDATE rgdb."DbT3045ShokanServicePlan200004"
        SET    "shikyuKubunCode" = TEMP."shiharaiHohoKubunCode",
        "tensuKingaku" = TEMP."tanisuKingaku",
        "shikyuKingaku" = TEMP."shikyuKingaku",
        "zougenTen" = TEMP."zougenTanisu",
        "zougenRiyu" = TEMP."biko"
        FROM   "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI" AS TEMP
        WHERE  "hiHokenshaNo" = TEMP."hihokenshaNo"
        AND    "serviceTeikyoYM" = TEMP."serviceTeikyoYM"
        AND    "seiriNo" = TEMP."seiriNo"
        AND    "jigyoshaNo" = TEMP."jigyoshoNo"
        AND    substring("serviceCode", 1, 2) = TEMP."serviceShuruiCode"
    </update>

    <!-- 償還払請求サービス計画200604を更新する -->
    <update id="update償還払請求サービス計画200604">
        UPDATE rgdb."DbT3046ShokanServicePlan200604"
        SET    "shikyuKubunCode" = TEMP."shiharaiHohoKubunCode",
        "tensuKingaku" = TEMP."tanisuKingaku",
        "shikyuKingaku" = TEMP."shikyuKingaku",
        "zougenTen" = TEMP."zougenTanisu",
        "zougenRiyu" = TEMP."biko"
        FROM   "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI" AS TEMP
        WHERE  "hiHokenshaNo" = TEMP."hihokenshaNo"
        AND    "serviceTeikyoYM" = TEMP."serviceTeikyoYM"
        AND    "seiriNo" = TEMP."seiriNo"
        AND    "jigyoshaNo" = TEMP."jigyoshoNo"
        AND    substring("serviceCode", 1, 2) = TEMP."serviceShuruiCode"
    </update>

    <!-- 償還払請求サービス計画200904を更新する -->
    <update id="update償還払請求サービス計画200904">
        UPDATE rgdb."DbT3047ShokanServicePlan200904"
        SET    "shikyuKubunCode" = TEMP."shiharaiHohoKubunCode",
        "tensuKingaku" = TEMP."tanisuKingaku",
        "shikyuKingaku" = TEMP."shikyuKingaku",
        "zougenTen" = TEMP."zougenTanisu",
        "zougenRiyu" = TEMP."biko"
        FROM   "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI" AS TEMP
        WHERE  "hiHokenshaNo" = TEMP."hihokenshaNo"
        AND    "serviceTeikyoYM" = TEMP."serviceTeikyoYM"
        AND    "seiriNo" = TEMP."seiriNo"
        AND    "jigyoshaNo" = TEMP."jigyoshoNo"
        AND    substring("serviceCode", 1, 2) = TEMP."serviceShuruiCode"
    </update>

    <!-- 償還払請求特定入所者介護サービス費用を更新する。 -->
    <update id="update特定入所者介護サービス費用">
        UPDATE rgdb."DbT3050ShokanTokuteiNyushoshaKaigoServiceHiyo"
        SET    "shikyuKubunCode" = TEMP."shiharaiHohoKubunCode",
        "tensuKingaku" = TEMP."tanisuKingaku",
        "shikyuKingaku" = TEMP."shikyuKingaku",
        "zougenten" = TEMP."zougenTanisu",
        FROM   "TABLE_SHOKANBARAISHIKYUKETTEISHUUKEIICHIJI" AS TEMP
        WHERE  "hiHokenshaNo" = TEMP."hihokenshaNo"
        AND    "serviceTeikyoYM" = TEMP."serviceTeikyoYM"
        AND    "seiriNo" = TEMP."seiriNo"
        AND    "jigyoshaNo" = TEMP."jigyoshoNo"
        AND    "serviceShuruiCode" = TEMP."serviceShuruiCode"
    </update>
</mapper>