<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： 宅改修事前申請のマッピング用XMLです。 -->

<!-- どのマッパーインターフェースと対応するかを指定する -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.jutakukaishujizenshinsei.IJutakuKaishuJizenShinseiMapper">

    <select id="get最新住宅改修住所"
            resultMap="jp.co.ndensan.reams.db.dbc.entity.db.relate.jutakukaishujizenshinsei.NewJutakuKaishuHiEntity"
            parameterType="java.util.Map" fetchSize="500">
        SELECT
        shinsei."serviceTeikyoYM" AS "serviceTeikyoYM",
        kaishu."jutakuKaishuJutakuAddress" AS "jutakuKaishuJutakuAddress"
        FROM
        rgdb."DbT3034ShokanShinsei" shinsei
        INNER JOIN
        rgdb."DbT3049ShokanJutakuKaishu" kaishu
        ON
           kaishu."hiHokenshaNo" = #{hiHokenshaNo}
           AND kaishu."hiHokenshaNo" = shinsei."hiHokenshaNo"
           AND kaishu."serviceTeikyoYM" = shinsei."serviceTeikyoYM"
           AND kaishu."seiriNo" = shinsei."seiriNo"
           AND SUBSTRING(kaishu."yoshikiNo" ,1,3) = '21D'
        ORDER BY
           shinsei."serviceTeikyoYM" DESC
    </select>
   
    <select id="get開始サービス提供年月ある"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.jutakukaishujizenshinsei.JutakuKaishuHiParameter"
            resultType="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3034ShokanShinseiEntity" fetchSize="500">
        SELECT *
        FROM
        rgdb."DbT3034ShokanShinsei" T1
        INNER JOIN
           ( SELECT
              T3."hiHokenshaNo"	AS "hiHokenshaNo",
              T3."serviceTeikyoYM" AS "serviceTeikyoYM",
              T3."seiriNo" AS "seiriNo"
             FROM
             rgdb."DbT3049ShokanJutakuKaishu" T3
             WHERE
                 T3."hiHokenshaNo" = #{被保険者番号}
                 AND T3."serviceTeikyoYM" <![CDATA[<]]> #{サービス提供年月}
                 AND T3."jutakuKaishuJutakuAddress" = #{住宅住所}
                 AND SUBSTRING("yoshikiNo",1,3) = '21D'
             GROUP BY
                T3."hiHokenshaNo",
                T3."serviceTeikyoYM",
                T3."seiriNo"
           ) AS T2 
           ON
             T1."hiHokenshaNo" = T2."hiHokenshaNo"
             AND T1."serviceTeikyoYM" = T2."serviceTeikyoYM"
             AND T1."seiriNo" = T2."seiriNo"
        WHERE
            (T1."yokaigo3DankaiHenko" = TRUE
            OR T1."jutakuJushoHenko" = TRUE)
            AND T1."serviceTeikyoYM"<![CDATA[<]]>#{サービス提供年月}
        ORDER BY
            T1."serviceTeikyoYM" DESC
    </select>
    
    <select id="get開始サービス提供年月なし"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.jutakukaishujizenshinsei.JutakuKaishuHiParameter"
            resultType="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3034ShokanShinseiEntity" fetchSize="500">
        SELECT *
        FROM
        rgdb."DbT3034ShokanShinsei" T1
        INNER JOIN
           ( SELECT
              T3."hiHokenshaNo"	AS "hiHokenshaNo",
              T3."serviceTeikyoYM" AS "serviceTeikyoYM",
              T3."seiriNo" AS "seiriNo"
             FROM
             rgdb."DbT3049ShokanJutakuKaishu" T3
             WHERE
                 T3."hiHokenshaNo" = #{被保険者番号}
                 AND T3."serviceTeikyoYM" <![CDATA[<]]> #{サービス提供年月}
                 AND T3."jutakuKaishuJutakuAddress" = #{住宅住所}
                 AND SUBSTRING("yoshikiNo",1,3) = '21D'
             GROUP BY
                T3."hiHokenshaNo",
                T3."serviceTeikyoYM",
                T3."seiriNo"
           ) AS T2 
           ON
             T1."hiHokenshaNo" = T2."hiHokenshaNo"
             AND T1."serviceTeikyoYM" = T2."serviceTeikyoYM"
             AND T1."seiriNo" = T2."seiriNo"
        WHERE
            T1."serviceTeikyoYM"<![CDATA[<]]>#{サービス提供年月}
        ORDER BY
            T1."serviceTeikyoYM" ASC
    </select>
   
    <resultMap id="resultMap_ShiharaiKekkaResult"
               type="jp.co.ndensan.reams.db.dbc.business.core.jutakukaishujizenshinsei.ShiharaiKekkaResult"
               autoMapping="true">
        <result property="費用額合計" column="shiharaiKingakuTotal" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="保険対象費用額" column="hokenTaishoHiyogaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="保険給付額" column="hokenKyufugaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="利用者負担額" column="riyoshaFutangaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="住宅改修住宅住所" column="jutakuKaishuJutakuAddress" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>
    <select id="get住宅改修費支払結果"
            resultMap="resultMap_ShiharaiKekkaResult"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.jutakukaishujizenshinsei.JutakuKaishuHiParameter" fetchSize="500">
        SELECT
        SUM(T1."shiharaiKingakuTotal") AS "shiharaiKingakuTotal",
        SUM(T1."hokenTaishoHiyogaku") AS "hokenTaishoHiyogaku",
        SUM(T1."hokenKyufugaku") AS "hokenKyufugaku",
        SUM(T1."riyoshaFutangaku") AS "riyoshaFutangaku",
        T2."jutakuKaishuJutakuAddress" AS "jutakuKaishuJutakuAddress"
        FROM
        rgdb."DbT3034ShokanShinsei" T1
        INNER JOIN
           ( SELECT
                T3."hiHokenshaNo" AS "hiHokenshaNo",
                T3."serviceTeikyoYM" AS "serviceTeikyoYM",
                T3."seiriNo" AS "seiriNo",
                T3."jutakuKaishuJutakuAddress" AS "jutakuKaishuJutakuAddress"
             FROM
             rgdb."DbT3049ShokanJutakuKaishu" T3
             WHERE
                 T3."hiHokenshaNo" = #{被保険者番号}
                 AND T3."jutakuKaishuJutakuAddress" = #{住宅改修住宅住所}
                 AND T3."serviceTeikyoYM" <![CDATA[<]]> #{サービス提供年月}
                 AND T3."serviceTeikyoYM" <![CDATA[>=]]> #{開始サービス提供年月}
                 AND SUBSTRING("yoshikiNo",1,3) = '21D'
            GROUP BY
                T3."hiHokenshaNo",
                T3."serviceTeikyoYM",
                T3."seiriNo",
                T3."jutakuKaishuJutakuAddress"
            ) AS T2 ON
            T1."hiHokenshaNo" = T2."hiHokenshaNo"
            AND T1."serviceTeikyoYM" = T2."serviceTeikyoYM"
            AND T1."seiriNo" = T2."seiriNo"
        WHERE 
            T1."hiHokenshaNo"=#{被保険者番号}
            AND T1."serviceTeikyoYM" <![CDATA[<]]> #{サービス提供年月}
            AND T1."serviceTeikyoYM" <![CDATA[>=]]> #{開始サービス提供年月}
       GROUP BY "jutakuKaishuJutakuAddress"
</select>

    <select id="getWK給付率"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.jutakukaishujizenshinsei.JutakuKaishuHiParameter"
            resultType="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3113RiyoshaFutanWariaiEntity" fetchSize="500">
        SELECT *
        FROM
        rgdb."DbT3113RiyoshaFutanWariai" AS "futanWariai"
        INNER JOIN
            rgdb."DbT3114RiyoshaFutanWariaiMeisai" AS "wariaiMeisai"
            ON  
              wariaiMeisai."hihokenshaNo" = #{被保険者番号}
              AND wariaiMeisai."rirekiNo" = futanWariai."rirekiNo"
              AND wariaiMeisai."yukoKaishiYMD" <![CDATA[<=]]> #{サービス提供年月}
              AND wariaiMeisai."yukoShuryoYMD" <![CDATA[>=]]> #{サービス提供年月}
        ORDER BY 
           "rirekiNo" DESC,
           "edaNo" DESC
    </select>

</mapper>
