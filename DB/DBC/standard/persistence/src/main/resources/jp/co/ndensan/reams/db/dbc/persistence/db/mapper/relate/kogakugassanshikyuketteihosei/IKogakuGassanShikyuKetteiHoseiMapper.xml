<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要：支給決定情報補正（単）(事業分兼)のマッピング用XMLです。 -->
<!-- @reamsid_L DBC-2290-030 quxiaodong -->

<!-- どのマッパーインターフェースと対応するかを指定する -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.kogakugassanshikyuketteihosei.IKogakuGassanShikyuKetteiHoseiMapper">
    <select resultOrdered="true" id="get高額合算給付実績"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakugassanshikyuketteihosei.ShoriModeHanteiParameter"
            resultType="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3075KogakuGassanKyufuJissekiEntity"
            fetchSize="500">
        SELECT "B".*
        FROM
        (
        SELECT
        "C"."kokanJohoShikibetsuNo",
        "C"."hihokenshaNo",
        "C"."shikyuShinseiSeiriNo",
        MAX("C"."seiriNo") AS 整理番号
        FROM
        rgdb."DbT3075KogakuGassanKyufuJisseki" AS "C"
        GROUP BY
        "C"."kokanJohoShikibetsuNo",
        "C"."hihokenshaNo",
        "C"."shikyuShinseiSeiriNo"
        ) AS "A"
        INNER JOIN
        rgdb."DbT3075KogakuGassanKyufuJisseki" AS "B"
        ON
        "A"."kokanJohoShikibetsuNo"="B"."kokanJohoShikibetsuNo"
        AND "A"."hihokenshaNo"="B"."hihokenshaNo"
        AND "A"."shikyuShinseiSeiriNo"="B"."shikyuShinseiSeiriNo"
        WHERE
        "B"."isDeleted"='false'
        AND "B"."hihokenshaNo"=#{被保険者番号}
        AND "B"."shoKisaiHokenshaNo"=#{証記載保険者番号}
        AND "B"."shikyuShinseiSeiriNo"=#{支給申請書整理番号}
        ORDER BY
        "B"."shoriYM" DESC
    </select>

    <update id="logicalDelete高額合算給付実績"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakugassanshikyuketteihosei.KogakuGassanShikyuGakuKeisanKekkaUpdateParameter">
        UPDATE
        rgdb."DbT3075KogakuGassanKyufuJisseki"
        SET
        "isDeleted" ='true',
        "updateCount" = "updateCount" + 1,
        "lastUpdateReamsLoginId" = #{loginId},
        "lastUpdateTimestamp" = now()
        WHERE
        "DbT3075KogakuGassanKyufuJisseki"."kokanJohoShikibetsuNo" = #{更新前交換情報識別番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."hihokenshaNo" = #{更新前被保険者番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."shikyuShinseiSeiriNo" = #{更新前支給申請書整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."seiriNo" = #{更新前整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."jikoFutanSeiriNo" = #{更新前自己負担額証明書整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."hokenSeidoCode" = #{更新前保険制度コード}
        AND "DbT3075KogakuGassanKyufuJisseki"."kyufuJissekiSakuseiKubunCode" = #{更新前給付実績作成区分コード}
        AND "DbT3075KogakuGassanKyufuJisseki"."shoKisaiHokenshaNo" = #{更新前証記載保険者番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."kokuho_HihokenshaShoKigo" = #{更新前国保_被保険者証記号}
        AND "DbT3075KogakuGassanKyufuJisseki"."shinseiYMD" = #{更新前申請年月日}
        AND "DbT3075KogakuGassanKyufuJisseki"."ketteiYMD" = #{更新前決定年月日}
        AND "DbT3075KogakuGassanKyufuJisseki"."jikoFutanSogaku" = #{更新前自己負担総額}
        AND "DbT3075KogakuGassanKyufuJisseki"."shikyuGaku" = #{更新前支給額}
        AND "DbT3075KogakuGassanKyufuJisseki"."shoriYM" = #{更新前処理年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."uketoriYM" = #{更新前受取年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."sofuYM" = #{更新前送付年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."dataKubun" = #{更新前データ区分}
        AND "DbT3075KogakuGassanKyufuJisseki"."isDeleted" = #{更新前論理削除}
    </update>

    <delete id="physicalDelete高額合算給付実績"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakugassanshikyuketteihosei.KogakuGassanShikyuGakuKeisanKekkaUpdateParameter">
        DELETE
        FROM
        rgdb."DbT3075KogakuGassanKyufuJisseki"
        WHERE
        "DbT3075KogakuGassanKyufuJisseki"."kokanJohoShikibetsuNo" = #{更新前交換情報識別番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."hihokenshaNo" = #{更新前被保険者番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."shikyuShinseiSeiriNo" = #{更新前支給申請書整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."seiriNo" = #{更新前整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."jikoFutanSeiriNo" = #{更新前自己負担額証明書整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."hokenSeidoCode" = #{更新前保険制度コード}
        AND "DbT3075KogakuGassanKyufuJisseki"."kyufuJissekiSakuseiKubunCode" = #{更新前給付実績作成区分コード}
        AND "DbT3075KogakuGassanKyufuJisseki"."shoKisaiHokenshaNo" = #{更新前証記載保険者番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."kokuho_HihokenshaShoKigo" = #{更新前国保_被保険者証記号}
        AND "DbT3075KogakuGassanKyufuJisseki"."shinseiYMD" = #{更新前申請年月日}
        AND "DbT3075KogakuGassanKyufuJisseki"."ketteiYMD" = #{更新前決定年月日}
        AND "DbT3075KogakuGassanKyufuJisseki"."jikoFutanSogaku" = #{更新前自己負担総額}
        AND "DbT3075KogakuGassanKyufuJisseki"."shikyuGaku" = #{更新前支給額}
        AND "DbT3075KogakuGassanKyufuJisseki"."shoriYM" = #{更新前処理年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."uketoriYM" = #{更新前受取年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."sofuYM" = #{更新前送付年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."dataKubun" = #{更新前データ区分}
        AND "DbT3075KogakuGassanKyufuJisseki"."isDeleted" = #{更新前論理削除}
    </delete>

    <update id="update高額合算給付実績"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakugassanshikyuketteihosei.KogakuGassanShikyuGakuKeisanKekkaUpdateParameter">
        UPDATE
        rgdb."DbT3075KogakuGassanKyufuJisseki"
        SET
        "kyufuJissekiSakuseiKubunCode" =#{更新後給付実績作成区分コード},
        "jikoFutanSeiriNo" = #{更新後自己負担額証明書整理番号},
        "shinseiYMD" = #{更新後申請年月日},
        "ketteiYMD" = #{更新後決定年月日},
        "jikoFutanSogaku" = #{更新後自己負担総額},
        "shikyuGaku" = #{更新後支給額},
        "shoKisaiHokenshaNo" = #{更新後証記載保険者番号},
        "lastUpdateReamsLoginId" = #{loginId},
        "updateCount" = "updateCount" + 1,
        "lastUpdateTimestamp" = now()
        WHERE
        "DbT3075KogakuGassanKyufuJisseki"."kokanJohoShikibetsuNo" = #{更新前交換情報識別番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."hihokenshaNo" = #{更新前被保険者番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."shikyuShinseiSeiriNo" = #{更新前支給申請書整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."seiriNo" = #{更新前整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."jikoFutanSeiriNo" = #{更新前自己負担額証明書整理番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."hokenSeidoCode" = #{更新前保険制度コード}
        AND "DbT3075KogakuGassanKyufuJisseki"."kyufuJissekiSakuseiKubunCode" = #{更新前給付実績作成区分コード}
        AND "DbT3075KogakuGassanKyufuJisseki"."shoKisaiHokenshaNo" = #{更新前証記載保険者番号}
        AND "DbT3075KogakuGassanKyufuJisseki"."kokuho_HihokenshaShoKigo" = #{更新前国保_被保険者証記号}
        AND "DbT3075KogakuGassanKyufuJisseki"."shinseiYMD" = #{更新前申請年月日}
        AND "DbT3075KogakuGassanKyufuJisseki"."ketteiYMD" = #{更新前決定年月日}
        AND "DbT3075KogakuGassanKyufuJisseki"."jikoFutanSogaku" = #{更新前自己負担総額}
        AND "DbT3075KogakuGassanKyufuJisseki"."shikyuGaku" = #{更新前支給額}
        AND "DbT3075KogakuGassanKyufuJisseki"."shoriYM" = #{更新前処理年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."uketoriYM" = #{更新前受取年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."sofuYM" = #{更新前送付年月}
        AND "DbT3075KogakuGassanKyufuJisseki"."dataKubun" = #{更新前データ区分}
        AND "DbT3075KogakuGassanKyufuJisseki"."isDeleted" = #{更新前論理削除}
    </update>

    <select resultOrdered="true" id="get高額合算支給額計算結果"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakugassanshikyuketteihosei.KogakuGassanShikyuGakuKeisanKekkaParameter"
            resultType="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3072KogakuGassanShikyuGakuKeisanKekkaEntity"
            fetchSize="500">
        SELECT "B".*
        FROM
        (
        SELECT
        "C"."hihokenshaNo",
        "C"."taishoNendo",
        "C"."shoKisaiHokenshaNo",
        "C"."shikyuShinseishoSeiriNo",
        MAX("C"."rirekiNo") AS 履歴番号
        FROM
        rgdb."DbT3072KogakuGassanShikyuGakuKeisanKekka" AS "C"
        GROUP BY
        "C"."hihokenshaNo",
        "C"."taishoNendo",
        "C"."shoKisaiHokenshaNo",
        "C"."shikyuShinseishoSeiriNo"
        ) AS "A"
        INNER JOIN
        rgdb."DbT3072KogakuGassanShikyuGakuKeisanKekka" AS "B"
        ON
        "A"."hihokenshaNo"="B"."hihokenshaNo"
        AND "A"."taishoNendo"="B"."taishoNendo"
        AND "A"."shoKisaiHokenshaNo"="B"."shoKisaiHokenshaNo"
        AND "A"."shikyuShinseishoSeiriNo"="B"."shikyuShinseishoSeiriNo"
        WHERE
        "B"."isDeleted"='false'
        AND "B"."hihokenshaNo"=#{被保険者番号}
        AND "B"."taishoNendo"=#{対象年度}
        AND "B"."shoKisaiHokenshaNo"=#{証記載保険者番号}
        AND "B"."shikyuShinseishoSeiriNo"=#{支給申請書整理番号}
        ORDER BY
        "B"."rirekiNo" DESC
        LIMIT 1
    </select>
</mapper>