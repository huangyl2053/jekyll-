<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.kogakukyufutaishoshain.IKogakuKyufuTaishoshaInMapper">
   
    <resultMap id="resultMap_KogakuKyufuTaishoshaInEntity" 
               type="jp.co.ndensan.reams.db.dbc.entity.db.relate.kogakukyufutaishoshain.DbTKogakuKyufuTaishoshaDataTempTableEntity" autoMapping="true">
        <result property="kokanShikibetsuNo" column="kokanShikibetsuNo" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shoKisaiHokenshaNo" column="shoKisaiHokenshaNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ShoKisaiHokenshaNoTypeHandler"/>
        <result property="hokenshaNo" column="hokenshaNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HokenshaNoTypeHandler"/>
        <result property="hihokenshaName" column="hihokenshaName" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="sakuseiYMD" column="sakuseiYMD" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="kokukoRengoukaiNa" column="kokukoRengoukaiNa" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="no" column="no" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="hihokenshaNo" column="hihokenshaNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="hiHokenshaSimei" column="hiHokenshaSimei" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="serviceTeikyoYM" column="serviceTeikyoYM" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="jigyoshaNo" column="jigyoshaNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.JigyoshaNoTypeHandler"/>
        <result property="jigyoshaName" column="jigyoshaName" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="serviceShuruiCode" column="serviceShuruiCode" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ServiceShuruiCodeTypeHandler"/>
        <result property="serviceShuruiName" column="serviceShuruiName" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="serviceHiyoGokeiGaku" column="serviceHiyoGokeiGaku" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="riyoshaFutanGaku" column="riyoshaFutanGaku" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="bikou" column="bikou" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shikakuSoshitsuYMD" column="shikakuSoshitsuYMD" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="serviceHiyoGokeiGakuGokei" column="serviceHiyoGokeiGakuGokei" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="riyoshaFutanGakuGokei" column="riyoshaFutanGakuGokei" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="santeiKijunGaku" column="santeiKijunGaku" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="shiharaiSumiKingakuGokei" column="shiharaiSumiKingakuGokei" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="kogakuShikyuGaku" column="kogakuShikyuGaku" 
                typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="setaiShuyakuNo" column="setaiShuyakuNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
    </resultMap>

    <!-- 高額介護サービス費給付対象者一時テーブルのデータの取得-->
    <select id="select一時テーブル" resultMap="resultMap_KogakuKyufuTaishoshaInEntity" fetchSize="500">
        SELECT DISTINCT
        一時テーブル."kokanShikibetsuNo",
        一時テーブル."shoKisaiHokenshaNo",
        一時テーブル."hokenshaNo",
        一時テーブル."hihokenshaName",
        一時テーブル."sakuseiYMD",
        一時テーブル."kokukoRengoukaiNa",
        一時テーブル."no",
        一時テーブル."hihokenshaNo",
        一時テーブル."hiHokenshaSimei",
        一時テーブル."serviceTeikyoYM",
        一時テーブル."jigyoshaNo",
        一時テーブル."jigyoshaName",
        一時テーブル."serviceShuruiCode",
        一時テーブル."serviceShuruiName",
        一時テーブル."serviceHiyoGokeiGaku",
        一時テーブル."riyoshaFutanGaku",
        一時テーブル."bikou",
        temp."shikakuSoshitsuYMD",
        一時テーブル."serviceHiyoGokeiGakuGokei",
        一時テーブル."riyoshaFutanGakuGokei",
        一時テーブル."santeiKijunGaku",
        一時テーブル."shiharaiSumiKingakuGokei",
        一時テーブル."kogakuShikyuGaku",
        一時テーブル."setaiShuyakuNo"
        FROM "DbTKogakuKyufuTaishoshaDataTempTable" AS 一時テーブル
        INNER JOIN (
        SELECT
        B."hihokenshaNo" as "hihokenshaNo","shikakuSoshitsuYMD"
        FROM (SELECT "hihokenshaNo","shikakuSoshitsuYMD", MAX("idoYMD" || "edaNo") AS "max1" 
          FROM rgdb."DbT1001HihokenshaDaicho" GROUP BY "hihokenshaNo","shikakuSoshitsuYMD")AS B 
          INNER JOIN (
            SELECT "hihokenshaNo",MAX("idoYMD" || "edaNo")AS "max2" 
            FROM rgdb."DbT1001HihokenshaDaicho" 
            GROUP BY "hihokenshaNo") AS A 
          ON A."hihokenshaNo" = B."hihokenshaNo" AND B."max1" = A."max2"
        ) AS temp
        ON 一時テーブル."hihokenshaNo" = temp."hihokenshaNo"
        ORDER BY 一時テーブル."hihokenshaNo"
    </select>
    
    <update id="updateDbT3054サービス提供年月">
        UPDATE rgdb."DbT3054KogakuKyufuTaishoshaMeisai" AS dbT3054
        SET "isDeleted"=true
        FROM "DbTKogakuKyufuTaishoshaDataTempTable" AS 一時テーブル
        WHERE dbT3054."serviceTeikyoYM" = 一時テーブル."serviceTeikyoYM"
    </update>
    
    <update id="updateDbT3055サービス提供年月">
        UPDATE rgdb."DbT3055KogakuKyufuTaishoshaGokei" AS dbT3055
        SET "isDeleted"=true
        FROM "DbTKogakuKyufuTaishoshaDataTempTable" AS 一時テーブル
        WHERE dbT3055."serviceTeikyoYM" = 一時テーブル."serviceTeikyoYM"
    </update>
    
    <insert id="insert高額介護サービス費給付対象者合計">
        INSERT INTO rgdb."DbT3055KogakuKyufuTaishoshaGokei"(
        "hihokenshaNo",
        "serviceTeikyoYM",
        "rirekiNo",
        "serviceHiyoGokeiGakuGokei",
        "riyoshaFutanGakuGokei",
        "santeiKijunGaku",
        "shiharaiSumiKingakuGokei",
        "KogakuShikyuGaku",
        "tashoshaUketoriYM",
        "taishoshaHanteiShinsaYM",
        "setaiShuyakuNo",
        "kyokaisoTaishoshaFlag",
        "hojinKeigenTaishoFlag",
        "kogakuTaishoGaiFlag",
        "jidoShokanTaishoFlag"
        )
        SELECT
        TEMP."hihokenshaNo",
        TEMP."serviceTeikyoYM",
        (CASE WHEN TEMP."rirekiNo" IS NOT NULL
            THEN TEMP."rirekiNo" + "row"
            ELSE 0 + "row" END) AS "rirekiNo",
        TEMP."serviceHiyoGokeiGakuGokei",
        TEMP."riyoshaFutanGakuGokei",
        TEMP."santeiKijunGaku",
        TEMP."shiharaiSumiKingakuGokei",
        TEMP."kogakuShikyuGaku",
        to_char(now(),'YYYYMM'),
        substring(TEMP."sakuseiYMD",1,6),
        TEMP."setaiShuyakuNo",
        false,
        false,
        false,
        false
        FROM(
        SELECT
        ROW_NUMBER() OVER() AS "row",
        一時テーブル."hihokenshaNo",
        一時テーブル."serviceTeikyoYM",
        MAX(DbT3055."rirekiNo") AS "rirekiNo",
        一時テーブル."serviceHiyoGokeiGakuGokei",
        一時テーブル."riyoshaFutanGakuGokei",
        一時テーブル."santeiKijunGaku",
        一時テーブル."shiharaiSumiKingakuGokei",
        一時テーブル."kogakuShikyuGaku",
        一時テーブル."sakuseiYMD",
        一時テーブル."setaiShuyakuNo"
        from "DbTKogakuKyufuTaishoshaDataTempTable" as 一時テーブル
        LEFT JOIN rgdb."DbT3055KogakuKyufuTaishoshaGokei" as DbT3055
        ON 一時テーブル."hihokenshaNo" = DbT3055."hihokenshaNo"
        AND  一時テーブル."serviceTeikyoYM" =  DbT3055."serviceTeikyoYM"
        where 一時テーブル."hihokenshaNo" is not null
        and 一時テーブル."serviceTeikyoYM" is not null
        GROUP BY
        一時テーブル."hihokenshaNo",
        一時テーブル."serviceTeikyoYM",
        一時テーブル."serviceHiyoGokeiGakuGokei",
        一時テーブル."riyoshaFutanGakuGokei",
        一時テーブル."santeiKijunGaku",
        一時テーブル."shiharaiSumiKingakuGokei",
        一時テーブル."kogakuShikyuGaku",
        一時テーブル."sakuseiYMD",
        一時テーブル."setaiShuyakuNo"
        )AS TEMP
    </insert>
    
    <insert id="insert高額介護サービス費給付対象者明細">
        INSERT INTO rgdb."DbT3054KogakuKyufuTaishoshaMeisai"(
        "hihokenshaNo",
        "serviceTeikyoYM",
        "jigyoshaNo",
        "serviceShuruiCode",
        "rirekiNo",
        "serviceHiyoGokeiGaku" ,
        "riyoshaFutanGaku",
        "kogakuKyufuKonkyo"
        )
        SELECT
        TEMP."hihokenshaNo",
        TEMP."serviceTeikyoYM",
        TEMP."jigyoshaNo",
        TEMP."serviceShuruiCode",
        (CASE WHEN TEMP."rirekiNo" IS NOT NULL
            THEN TEMP."rirekiNo" + "row"
            ELSE 0 + "row" END) AS "rirekiNo",
        TEMP."serviceHiyoGokeiGaku",
        TEMP."riyoshaFutanGaku",
        TEMP."bikou"
        FROM(
        SELECT
        ROW_NUMBER() OVER() AS "row",
        一時テーブル."hihokenshaNo",
        一時テーブル."serviceTeikyoYM",
        一時テーブル."jigyoshaNo",
        一時テーブル."serviceShuruiCode",
        MAX(DbT3054."rirekiNo") AS "rirekiNo",
        一時テーブル."serviceHiyoGokeiGaku",
        一時テーブル."riyoshaFutanGaku",
        一時テーブル."bikou"
        from "DbTKogakuKyufuTaishoshaDataTempTable" as 一時テーブル,
        LEFT JOIN rgdb."DbT3054KogakuKyufuTaishoshaMeisai" as DbT3054
        ON 一時テーブル."hihokenshaNo" = DbT3054."hihokenshaNo"
        AND 一時テーブル."serviceTeikyoYM" = DbT3054."serviceTeikyoYM"
        AND 一時テーブル."jigyoshaNo" = DbT3054."jigyoshaNo"
        AND 一時テーブル."serviceShuruiCode" = DbT3054."serviceShuruiCode"
        where 一時テーブル."hihokenshaNo" is not null
        and 一時テーブル."serviceTeikyoYM" is not null
        and 一時テーブル."jigyoshaNo" is not null
        and 一時テーブル."serviceShuruiCode" is not null
        GROUP BY
        一時テーブル."hihokenshaNo",
        一時テーブル."serviceTeikyoYM",
        一時テーブル."jigyoshaNo",
        一時テーブル."serviceShuruiCode",
        一時テーブル."serviceHiyoGokeiGaku",
        一時テーブル."riyoshaFutanGaku",
        一時テーブル."bikou"
        )AS TEMP
    </insert>
    
    <resultMap id="resultMap_Hihokensha" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.kogakukyufutaishoshain.DbTKogakuKyufuTaishoshaDataTempTableEntity" autoMapping="true">
        <result property="hiHokenshaNo" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
    </resultMap>
    
    <!-- 一時テーブルのデータの取得-->
    <select id="select被保険者番号From一時テーブル" resultMap="resultMap_Hihokensha" fetchSize="500">
        SELECT DISTINCT ICHIJI."hiHokenshaNo"
        FROM "TABLE_KAGOKETTEIMEISAIICHIJI" AS ICHIJI
    </select>
    
    <!-- 被保険者台帳管理から市町村コード取得 -->
    <select id="select市町村コードFrom被保険者台帳管理"
            resultMap="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT1001HihokenshaDaichoMapper.ResultMap_DbT1001HihokenshaDaichoEntity"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakukyufutaishoshain.KogakuKyufuTaishoshaInParameter">
     SELECT
         <include refid="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT1001HihokenshaDaichoMapper.allColumns_DbT1001HihokenshaDaicho" />
     FROM
         rgdb."DbT1001HihokenshaDaicho"
     WHERE
         rgdb."DbT1001HihokenshaDaicho"."hihokenshaNo" = #{被保険者番号}
     AND rgdb."DbT1001HihokenshaDaicho"."isDeleted" <![CDATA[<>]]> TRUE
     ORDER BY rgdb."DbT1001HihokenshaDaicho"."hihokenshaNo" DESC,
              rgdb."DbT1001HihokenshaDaicho"."idoYMD" DESC,
              rgdb."DbT1001HihokenshaDaicho"."edaNo" DESC
     LIMIT(1)
    </select>
     
    <resultMap id="resultMap_DbT7026Entity" 
               type="jp.co.ndensan.reams.db.dbz.entity.db.basic.DbT7026ShinKyuHihokenshaNoHenkanEntity"
               autoMapping="true">
        <result property="shichosonCode" column="shichosonCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.LasdecCodeTypeHandler"/>
        <result property="shinNo" column="shinNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="kyuNo" column="kyuNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>

    <!-- 被保険者台帳管理から市町村コード取得 -->
    <select id="select新被保険者番号From新旧被保険者番号変換"
            resultMap="resultMap_DbT7026Entity"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kogakukyufutaishoshain.KogakuKyufuTaishoshaInParameter">
     SELECT
         DbT7026."shichosonCode",
         DbT7026."shinNo",
         DbT7026."kyuNo"
     FROM
         rgdb."DbT7026ShinKyuHihokenshaNoHenkan" AS DbT7026
     WHERE
         DbT7026."shichosonCode" = #{市町村コード}
         AND DbT7026."kyuNo" = #{被保険者番号}
    </select>
    
    <update id="update一時TBL被保険者番号" 
             parameterType="jp.co.ndensan.reams.db.dbz.entity.db.basic.DbT7026ShinKyuHihokenshaNoHenkanEntity">
        UPDATE "DbTKogakuKyufuTaishoshaDataTempTable"
        SET "hihokenshaNo"=#{shinNo}
        where "hihokenshaNo" = #{kyuNo}
    </update>
    
    <resultMap id="resultMap_DbT3004Entity" 
               type="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3004KyodoShoriyoJukyushaIdoKogakuSofuEntity"
               autoMapping="true">
        <result property="setaiShuyakuNo" column="setaiShuyakuNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="hiHokenshaNo" column="hiHokenshaNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="shoKisaiHokenshaNo" column="shoKisaiHokenshaNo" 
                typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ShoKisaiHokenshaNoTypeHandler"/>
    </resultMap>
    <select id="select世帯集約番号" resultMap="resultMap_DbT3004Entity" fetchSize="500">
        SELECT 
        dbT3004."setaiShuyakuNo",
        dbT3004."hiHokenshaNo",
        dbT3004."shoKisaiHokenshaNo"
        FROM rgdb."DbT3004KyodoShoriyoJukyushaIdoKogakuSofu" AS dbT3004
        LEFT JOIN "DbTKogakuKyufuTaishoshaDataTempTable" AS 一時テーブル
        ON dbT3004."hiHokenshaNo" = 一時テーブル."hiHokenshaNo"
        AND dbT3004."shoKisaiHokenshaNo" =  一時テーブル."shoKisaiHokenshaNo"
<!--        AND dbT3004."idoYMD" <![CDATA[<=]]> 一時テーブル."serviceTeikyoYM"-->
        AND dbT3004."isDeleted" <![CDATA[<>]]> TRUE
    </select>
    <update id="update世帯集約番号" 
             parameterType="jp.co.ndensan.reams.db.dbc.entity.db.basic.DbT3004KyodoShoriyoJukyushaIdoKogakuSofuEntity">
        UPDATE "DbTKogakuKyufuTaishoshaDataTempTable"
        SET "setaiShuyakuNo"=#{setaiShuyakuNo}
        where "hihokenshaNo" = #{hihokenshaNo}
        and "shoKisaiHokenshaNo" = #{shoKisaiHokenshaNo}
    </update>
</mapper>