<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： 過誤申立送付情報照会のマッピング用XMLです。 -->
<!-- @reamsid_L DBC-2950-030 jinjue -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.sofujoho.ISofujohoMapper">

    <resultMap id="resultMap_SofujohoRelateEntity" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.sofujoho.SofujohoRelateEntity" autoMapping="true">
        <result property="事業所番号" column="jigyoshoNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="事業所名" column="jigyoshaName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者番号" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="宛名名称" column="宛名名称" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="申立者区分コード" column="moshitateshaKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="申立事由コード" column="moshitateJiyuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="サービス提供年月" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="申立年月日" column="moshitateYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="証記載保険者番号" column="shokisaiHokenshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <association property="psmEntity" resultMap="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.UaFt200FindShikibetsuTaishoEntity"/>
    </resultMap>

    <select id="select過誤申立送付情報照会" resultMap="resultMap_SofujohoRelateEntity"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.sofujoho.SofujohoMybatisParameter" fetchSize="500" resultOrdered="true">
         WITH T AS (
  WITH 介護事業者Newest AS ( 
  select
   "mst"."jigyoshaNo" ,
        "mst"."yukoKaishiYMD" ,
        "mst"."insertDantaiCd" ,
        "mst"."insertTimestamp" ,
        "mst"."insertReamsLoginId",
        "mst"."insertContextId",
        "mst"."isDeleted" ,
        "mst"."updateCount" ,
        "mst"."lastUpdateTimestamp" ,
        "mst"."lastUpdateReamsLoginId" ,
        "mst"."yukoShuryoYMD" ,
        "mst"."idoYMD" ,
        "mst"."idoJiyuCode" ,
        "mst"."jigyoKaishiYMD" ,
        "mst"."jigyoKyushiYMD",
        "mst"."jigyoSaikaiYMD" ,
        "mst"."jigyoHaishiYMD",
        "mst"."jigyoshaName",
        "mst"."jigyoshaNameKana",
        "mst"."yubinNo",
        "mst"."jigyoshaAddress",
        "mst"."jigyoshaKanaAddress" ,
        "mst"."telNo",
        "mst"."faxNo",
        "mst"."atesakiBusho",
        "mst"."atesakininName" ,
        "mst"."atesakininNamekana" ,
        "mst"."shiteiKijungaitoJigyoshaKubun" ,
        "mst"."shozaiShichoson" ,
        "mst"."serviceJisshiChiiki",
        "mst"."hojinShubetsu",
        "mst"."bedSu",
        "mst"."shozokuNinzu" ,
        "mst"."riyoshaSu" ,
        "mst"."biko" 
  from
    rgdb."DbT7060KaigoJigyosha" as mst 
  where
    not EXISTS (
      select
        'X' 
      from
        rgdb."DbT7060KaigoJigyosha" as slv 
      where
        mst."jigyoshaNo" = slv."jigyoshaNo" 
        and mst."yukoKaishiYMD" <![CDATA[<]]> slv."yukoKaishiYMD")
)
        SELECT
        T3059."jigyoshoNo",
        Tb7060."jigyoshaName",
        T3059."hiHokenshaNo",
        T3059."moshitateshaKubunCode",
        T3059."moshitateJiyuCode",
        T3059."serviceTeikyoYM",
        T3059."moshitateYMD",
        T3059."shokisaiHokenshaNo",
        dbv1001."shikibetsuCode"
        FROM
        rgdb."DbT3059KagoMoshitate" AS T3059 
        LEFT JOIN
        介護事業者Newest AS Tb7060
        ON	T3059."jigyoshoNo"=Tb7060."jigyoshaNo"
        LEFT JOIN
        rgdb."DbV1001HihokenshaDaicho" AS dbv1001
        ON	T3059."hiHokenshaNo" = dbv1001."hihokenshaNo"
        WHERE
        T3059."moshitateshoKubunCode"='1'
      <if test="送付年月フラグ">
            AND T3059."kokuhorenSofuYM" = '201607'
       </if>
        <if test="!送付年月フラグ">
           AND T3059."kokuhorenSofuYM" IS NULL
       </if>
       <if test="保険者番号フラグ">
           AND substr(T3059."shokisaiHokenshaNo",1,5) = #{証記載保険者番号}
        </if>
        ORDER BY
        T3059."jigyoshoNo",
        T3059."hiHokenshaNo",
        T3059."serviceTeikyoYM",
        T3059."rirekiNo" DESC)
        SELECT T."jigyoshoNo",
        T."jigyoshaName",
        T."hiHokenshaNo",
        T."moshitateshaKubunCode",
        T."moshitateJiyuCode",
        T."serviceTeikyoYM",
        T."moshitateYMD",
        T."shokisaiHokenshaNo",
        T."shikibetsuCode",
        <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" />."meisho" AS 宛名名称
        FROM T
        LEFT JOIN
        <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.tableName_PsmShikibetsuTaisho" />
        AS <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" />
        ON <include refid="jp.co.ndensan.reams.ua.uax.persistence.db.mapper.IUaFt200FindShikibetsuTaishoFunctionMapper.as_ShikibetsuTaisho" />."shikibetsuCode" =T."shikibetsuCode"
    </select>
</mapper>