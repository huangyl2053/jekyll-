<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- @reamsid_L DBC-0980-320 xupeng -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.kagoketteihokenshain.IKagoKetteiHokenshaInMapper">

    <!--過誤決定通知書（保険者分）情報（明細）一時テーブルを作成します-->
    <insert id="create保険者分情報_明細">
        CREATE TEMP TABLE "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunMeisai"
        (
        "kokanShikibetsuNo" character varying(4),
        "toriatsukaiYM" rshare."UDD014YM",
        "shokisaiHokenshaNo" rgdb."DbUDD003HokenshaNo",
        "shokisaiHokenshaNa" character(40),
        "sakuseiYMD" rshare."UDD015YMD",
        "kokukoRengoukaiNa" character(30),
        "jigyoshoNo" rgdb."DbUDD004JigyoshaNo",
        "jigyoshoName" character(20),
        "hiHokenshaNo" rgdb."DbUDD002HihokenshaNo",
        "hiHokenshaSimei" character(25),
        "serviceTeikyoYM" rshare."UDD014YM" ,
        "serviceShuruiCode" rgdb."DbUDD005ServiceShuruiCode",
        "serviceShuruiName" character(12),
        "kagomoushitateJiyuCode" rshare."UDD035Code",
        "kagomoushitateJiyu" character(14),
        "tanisu" numeric(13,0),
        "hokenshaFutangaku" numeric(13,0)
        )
    </insert>
    
    <!--過誤決定通知書（保険者分）情報（明細）一時テーブルに登録します-->
    <insert id="insert保険者分情報_明細" parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.kagoketteihokenshain.KagoKetteiHokenshaInMeisaiEntity">
        INSERT INTO "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunMeisai" 
        VALUES 
        (
        #{kokanShikibetsuNo},
        #{toriatsukaiYM},
        #{shokisaiHokenshaNo},
        #{shokisaiHokenshaNa},
        #{sakuseiYMD},
        #{kokukoRengoukaiNa},
        #{jigyoshoNo},
        #{jigyoshoName},
        #{hiHokenshaNo},
        #{hiHokenshaSimei},
        #{serviceTeikyoYM},
        #{serviceShuruiCode},
        #{serviceShuruiName},
        #{kagomoushitateJiyuCode},
        #{kagomoushitateJiyu},
        #{tanisu},
        #{hokenshaFutangaku})
    </insert>
    
    <resultMap id="resultMap_KagoKetteiTsuchishoJyohoHokenshabunMeisaiEntity" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.kagoketteihokenshain.KagoKetteiHokenshaInMeisaiEntity" autoMapping="true">
        <result property="toriatsukaiYM" column="toriatsukaiYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="jigyoshoNo" column="jigyoshoNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.JigyoshaNoTypeHandler"/>
        <result property="jigyoshoName" column="jigyoshoName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="hiHokenshaNo" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="serviceTeikyoYM" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="serviceShuruiCode" column="serviceShuruiCode" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ServiceShuruiCodeTypeHandler"/>
        <result property="serviceShuruiName" column="serviceShuruiName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="kagomoushitateJiyuCode" column="kagomoushitateJiyuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.CodeTypeHandler"/>
        <result property="kagomoushitateJiyu" column="kagomoushitateJiyu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="tanisu" column="tanisu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="hokenshaFutangaku" column="hokenshaFutangaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
    </resultMap>
    
    <insert id="insert過誤決定明細">
        INSERT INTO rgdb."DbT3061KagoKetteiMeisai"
        (
        "toriatsukaiYM",	
        "hokenshaKubun",
        "rirekiNo",
        "jigyoshoNo",	
        "jigyoshoName",
        "hiHokenshaNo",
        "serviceTeikyoYM",
        "serviceShuruiCode",	
        "serviceShuruiName",
        "kagomoushitateJiyuCode",	
        "kagomoushitateJiyu",
        "tanisu",
        "hokenshaFutangaku") 
        SELECT
            TEMP."toriatsukaiYM",
            '1',
            (CASE WHEN TEMP."rirekiNo" IS NOT NULL
            THEN TEMP."rirekiNo" + "row"
            ELSE 0 + "row" END) AS "rirekiNo",
            TEMP."jigyoshoNo",
            TEMP."jigyoshoName",
            TEMP."hiHokenshaNo",
            TEMP."serviceTeikyoYM",
            TEMP."serviceShuruiCode",
            TEMP."serviceShuruiName",
            TEMP."kagomoushitateJiyuCode",
            TEMP."kagomoushitateJiyu",
            TEMP."tanisu",
            TEMP."hokenshaFutangaku"
        FROM (
            SELECT
            ROW_NUMBER() OVER() AS "row",
            Meisai."toriatsukaiYM",
            MAX(DbT3061."rirekiNo") AS "rirekiNo",
            Meisai."jigyoshoNo",
            Meisai."jigyoshoName",
            Meisai."hiHokenshaNo",
            Meisai."serviceTeikyoYM",
            Meisai."serviceShuruiCode",
            Meisai."serviceShuruiName",
            Meisai."kagomoushitateJiyuCode",
            Meisai."kagomoushitateJiyu",
            Meisai."tanisu",
            Meisai."hokenshaFutangaku"
            FROM "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunMeisai" AS Meisai
            LEFT JOIN rgdb."DbT3061KagoKetteiMeisai" AS DbT3061
            ON (DbT3061."toriatsukaiYM" = Meisai."toriatsukaiYM"
            AND DbT3061."hokenshaKubun" = '1')
            GROUP BY
            Meisai."toriatsukaiYM",
            Meisai."jigyoshoNo",
            Meisai."jigyoshoName",
            Meisai."hiHokenshaNo",
            Meisai."serviceTeikyoYM",
            Meisai."serviceShuruiCode",
            Meisai."serviceShuruiName",
            Meisai."kagomoushitateJiyuCode",
            Meisai."kagomoushitateJiyu",
            Meisai."tanisu",
            Meisai."hokenshaFutangaku" ) AS TEMP
    </insert>
    
    <!--過誤決定通知書（保険者分）情報（集計）一時テーブルを作成します-->
    <insert id="create保険者分情報_集計">
        CREATE TEMP TABLE "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunShukei"
        (
        "kokanShikibetsuNo" character varying(4),
        "toriatsukaiYM" rshare."UDD014YM",
        "shokisaiHokenshaNo" rgdb."DbUDD003HokenshaNo",
        "shokisaiHokenshaNa" character(40),
        "sakuseiYMD" rshare."UDD015YMD",
        "kokukoRengoukaiNa" character(30),
        "kaigoKyufuhiKensu" integer,
        "kaigoKyufuhiTanisu" numeric(13,0),
        "kaigoKyufuhiFutangaku" numeric(13,0),
        "kogakuServicehiKensu" integer,
        "kogakuServicehiTanisu" numeric(13,0),
        "kogakuServicehiFutangaku" numeric(13,0),
        "tokuteiNyushoshaServicehiKensu" integer,
        "tokuteiNyushoshaServicehiTanisu" numeric(13,0),
        "tokuteiNyushoshaServicehiFutangaku" numeric(13,0))
    </insert>
    
    <!--過誤決定通知書（保険者分）情報（集計）一時テーブルに登録します-->
    <insert id="insert保険者分情報_集計" parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.kagoketteihokenshain.KagoKetteiHokenshaInShukeiEntity">
        INSERT INTO "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunShukei" 
        VALUES 
        (
        #{kokanShikibetsuNo},
        #{toriatsukaiYM},
        #{shokisaiHokenshaNo},
        #{shokisaiHokenshaNa},
        #{sakuseiYMD},
        #{kokukoRengoukaiNa},
        #{kaigoKyufuhiKensu},
        #{kaigoKyufuhiTanisu},
        #{kaigoKyufuhiFutangaku},
        #{kogakuServicehiKensu},
        #{kogakuServicehiTanisu},
        #{kogakuServicehiFutangaku},
        #{tokuteiNyushoshaServicehiKensu},
        #{tokuteiNyushoshaServicehiTanisu},
        #{tokuteiNyushoshaServicehiFutangaku})
    </insert>

    <insert id="insert過誤決定集計">
        INSERT INTO rgdb."DbT3060KagoKetteiShukei" 
        (
        "toriatsukaiYM",
        "hokenshaKubun",
        "rirekiNo",
        "kaigoKyufuhiKensu",
        "kaigoKyufuhiTanisu",
        "kaigoKyufuhiFutangaku",
        "kogakuServicehiKensu",
        "kogakuServicehiTanisu",
        "kogakuServicehiFutangaku",
        "tokuteiNyushoshaServicehiKensu",
        "tokuteiNyushoshaServicehiTanisu",
        "tokuteiNyushoshaServicehiFutangaku",
        "kohiFutanshaNo",
        "sakuseiYMD",
        "torikomiYM") 
        SELECT
            TEMP."toriatsukaiYM",
            '1',
            (CASE WHEN TEMP."rirekiNo" IS NOT NULL
            THEN TEMP."rirekiNo" + "row"
            ELSE 0 + "row" END) AS "rirekiNo",
            TEMP."kaigoKyufuhiKensu",
            TEMP."kaigoKyufuhiTanisu",
            TEMP."kaigoKyufuhiFutangaku",
            TEMP."kogakuServicehiKensu",
            TEMP."kogakuServicehiTanisu",
            TEMP."kogakuServicehiFutangaku",
            TEMP."tokuteiNyushoshaServicehiKensu",
            TEMP."tokuteiNyushoshaServicehiTanisu",
            TEMP."tokuteiNyushoshaServicehiFutangaku",
            SUBSTRING(TEMP."shokisaiHokenshaNo",length(TEMP."shokisaiHokenshaNo") - 5),
            TEMP."sakuseiYMD",
            to_char(now(),'YYYYMM')
        FROM (
            SELECT
            ROW_NUMBER() OVER() AS "row",
            Shukei."toriatsukaiYM",
            MAX(DbT3060."rirekiNo") AS "rirekiNo",
            Shukei."kaigoKyufuhiKensu",
            Shukei."kaigoKyufuhiTanisu",
            Shukei."kaigoKyufuhiFutangaku",
            Shukei."kogakuServicehiKensu",
            Shukei."kogakuServicehiTanisu",
            Shukei."kogakuServicehiFutangaku",
            Shukei."tokuteiNyushoshaServicehiKensu",
            Shukei."tokuteiNyushoshaServicehiTanisu",
            Shukei."tokuteiNyushoshaServicehiFutangaku",
            Shukei."shokisaiHokenshaNo",
            Shukei."sakuseiYMD"
            FROM "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunShukei" AS Shukei
            LEFT JOIN rgdb."DbT3060KagoKetteiShukei" AS DbT3060
            ON (DbT3060."toriatsukaiYM" = Shukei."toriatsukaiYM"
            AND DbT3060."hokenshaKubun" = '1')
            GROUP BY
            Shukei."toriatsukaiYM",
            Shukei."kaigoKyufuhiKensu",
            Shukei."kaigoKyufuhiTanisu",
            Shukei."kaigoKyufuhiFutangaku",
            Shukei."kogakuServicehiKensu",
            Shukei."kogakuServicehiTanisu",
            Shukei."kogakuServicehiFutangaku",
            Shukei."tokuteiNyushoshaServicehiKensu",
            Shukei."tokuteiNyushoshaServicehiTanisu",
            Shukei."tokuteiNyushoshaServicehiFutangaku",
            Shukei."shokisaiHokenshaNo",
            Shukei."sakuseiYMD" ) AS TEMP
    </insert>

    <select id="select被保険者番号From一時テーブル" resultMap="resultMap_KagoKetteiTsuchishoJyohoHokenshabunMeisaiEntity" fetchSize="500">
        SELECT DISTINCT temp."hiHokenshaNo"
        FROM "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunMeisai" AS temp
    </select>
        
    <select id="get市町村コード"
            resultMap="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT1001HihokenshaDaichoMapper.ResultMap_DbT1001HihokenshaDaichoEntity"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kagoketteihokenshain.KagoKetteiHokenshaInParameter">
     SELECT
         <include refid="jp.co.ndensan.reams.db.dbz.persistence.db.mapper.basic.IDbT1001HihokenshaDaichoMapper.allColumns_DbT1001HihokenshaDaicho" />
     FROM
         rgdb."DbT1001HihokenshaDaicho"
     WHERE
         rgdb."DbT1001HihokenshaDaicho"."hihokenshaNo" = #{被保険者番号}
     AND rgdb."DbT1001HihokenshaDaicho"."isDeleted" <![CDATA[<>]]> TRUE
     ORDER BY rgdb."DbT1001HihokenshaDaicho"."hihokenshaNo" DESC,
              rgdb."DbT1001HihokenshaDaicho"."idoYMD" DESC,
              rgdb."DbT1001HihokenshaDaicho"."edaNo" DESC
     LIMIT(1)
    </select>
    
    <select id="get新被保険者番号" parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kagoketteihokenshain.KagoKetteiHokenshaInParameter" 
        resultType="jp.co.ndensan.reams.db.dbc.entity.db.relate.kagoketteihokenshain.ShihihokenshabangoTempTableEntity">
        SELECT 
        Henkan."shichosonCode",
        Henkan."shinNo",
        Henkan."kyuNo" 
        FROM 
        rgdb."DbT7026ShinKyuHihokenshaNoHenkan" Henkan 
        WHERE Henkan."shichosonCode" = #{市町村コード} 
        AND Henkan."kyuNo" = #{被保険者番号}
    </select>
    
    <update id="update保険者分情報_明細">
        UPDATE "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunMeisai" AS A
        SET "hiHokenshaNo"=B."shinNo" 
        FROM "TEMP_TABLE_Shihihokenshabango" AS B
        WHERE A."hiHokenshaNo"=B."kyuNo"
    </update>
    
    <insert id="create新被保険者番号">
        CREATE TEMP TABLE "TEMP_TABLE_Shihihokenshabango"
        (
        "shichosonCode" rshare."UDD023LasdecCode",
        "shinNo" character(20),
        "kyuNo" character(20)) 
    </insert>
    
    <insert id="insert新被保険者番号" parameterType="jp.co.ndensan.reams.db.dbc.entity.db.relate.kagoketteihokenshain.ShihihokenshabangoTempTableEntity">
        INSERT INTO "TEMP_TABLE_Shihihokenshabango"
        (
        "shichosonCode",
        "shinNo",
        "kyuNo") 
        VALUES 
        (
        #{shichosonCode},
        #{shinNo},
        #{kyuNo})
    </insert>
    
    <resultMap id="resultMap_KagoKetteiHokenshaInEntity" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.kagoketteihokenshain.KagoKetteiHokenshaInEntity" autoMapping="true">
        <result property="取扱年月" column="toriatsukaiYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="証記載保険者番号" column="shokisaiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HokenshaNoTypeHandler"/>
        <result property="証記載保険者名" column="shokisaiHokenshaNa" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="事業所番号" column="jigyoshoNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.JigyoshaNoTypeHandler"/>
        <result property="事業所名" column="jigyoshoName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="被保険者番号" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="被保険者氏名" column="hiHokenshaSimei" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="サービス提供年月" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="サービス種類コード" column="serviceShuruiCode" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ServiceShuruiCodeTypeHandler"/>
        <result property="サービス種類名" column="serviceShuruiName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="過誤申立事由コード" column="kagomoushitateJiyuCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.CodeTypeHandler"/>
        <result property="過誤申立事由" column="kagomoushitateJiyu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="単位数" column="tanisu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="保険者負担額" column="hokenshaFutangaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="介護給付費の件数" column="kaigoKyufuhiKensu"/>
        <result property="介護給付費の単位数" column="kaigoKyufuhiTanisu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="介護給付費の保険者負担額" column="kaigoKyufuhiFutangaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="高額介護サービス費の件数" column="kogakuServicehiKensu"/>
        <result property="高額介護サービス費の単位数" column="kogakuServicehiTanisu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="高額介護サービス費の保険者負担額" column="kogakuServicehiFutangaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="特定入所者介護サービス費等の件数" column="tokuteiNyushoshaServicehiKensu"/>
        <result property="特定入所者介護サービス費等の単位数" column="tokuteiNyushoshaServicehiTanisu" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="特定入所者介護サービス費等の保険者負担額" column="tokuteiNyushoshaServicehiFutangaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
    </resultMap>
    
    <select id="select一時テーブル" parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.kagoketteihokenshain.KagoKetteiHokenshaInMybatisParameter"
            resultMap="resultMap_KagoKetteiHokenshaInEntity" fetchSize="500">
        SELECT Meisai."toriatsukaiYM",
               Meisai."shokisaiHokenshaNo",
               Meisai."shokisaiHokenshaNa",
               Meisai."jigyoshoNo",
               Meisai."jigyoshoName",
               Meisai."hiHokenshaNo",
               Meisai."hiHokenshaSimei",
               Meisai."serviceTeikyoYM",
               Meisai."serviceShuruiCode",
               Meisai."serviceShuruiName",
               Meisai."kagomoushitateJiyuCode",
               Meisai."kagomoushitateJiyu",
               Meisai."tanisu",
               Meisai."hokenshaFutangaku",
               Shukei."kaigoKyufuhiKensu",
               Shukei."kaigoKyufuhiTanisu",
               Shukei."kaigoKyufuhiFutangaku",
               Shukei."kogakuServicehiKensu",
               Shukei."kogakuServicehiTanisu",
               Shukei."kogakuServicehiFutangaku",
               Shukei."tokuteiNyushoshaServicehiKensu",
               Shukei."tokuteiNyushoshaServicehiTanisu",
               Shukei."tokuteiNyushoshaServicehiFutangaku"
        FROM "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunMeisai" AS Meisai
        LEFT JOIN "TEMP_TABLE_KagoKetteiTsuchishoJyohoHokenshabunShukei" AS Shukei
        ON  Meisai."kokanShikibetsuNo" = Shukei."kokanShikibetsuNo"
        AND Meisai."toriatsukaiYM" = Shukei."toriatsukaiYM"
        AND Meisai."shokisaiHokenshaNo" = Shukei."shokisaiHokenshaNo"
        AND Meisai."shokisaiHokenshaNa" = Shukei."shokisaiHokenshaNa"
        AND Meisai."sakuseiYMD" = Shukei."sakuseiYMD"
        AND Meisai."kokukoRengoukaiNa" = Shukei."kokukoRengoukaiNa"
        <if test="outputOrderBy != null">
        ORDER BY ${outputOrderBy}
        </if>
        
    </select>
</mapper>
