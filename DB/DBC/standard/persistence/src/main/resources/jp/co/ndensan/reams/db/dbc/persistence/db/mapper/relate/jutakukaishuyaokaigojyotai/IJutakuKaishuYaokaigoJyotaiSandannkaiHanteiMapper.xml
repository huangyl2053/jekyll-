<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBC-0992-160 surun -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.jutakukaishuyaokaigojyotai.IJutakuKaishuYaokaigoJyotaiSandannkaiHanteiMapper">
    <select resultOrdered="true" id="select要介護認定状態区分コードByParam" parameterType="java.util.Map" resultType="jp.co.ndensan.reams.uz.uza.biz.Code">
        <include refid="selectYokaigoJotaiKubunCode" />
    </select>

    <select resultOrdered="true" id="selectサービス提供年月ByParam" parameterType="java.util.Map" resultType="jp.co.ndensan.reams.db.dbd.entity.db.basic.DbT3034ShokanShinseiEntity">
        <include refid="selectShokanShinsei" />
    </select>

    <sql id="selectYokaigoJotaiKubunCode">
        SELECT
        "JukyushaDaicho"."yokaigoJotaiKubunCode" AS "yokaigoJotaiKubunCode"
        FROM
        rgdb."DbT4001JukyushaDaicho" "JukyushaDaicho"
        WHERE "JukyushaDaicho"."logicalDeletedFlag" <![CDATA[<>]]> TRUE
        AND "JukyushaDaicho"."isDeleted" = FALSE
        AND "JukyushaDaicho"."yukoMukoKubun" = '1'
        AND "JukyushaDaicho"."hihokenshaNo" = #{被保険者番号}
        AND "JukyushaDaicho"."ninteiYukoKikanKaishiYMD" <![CDATA[<=]]> #{サービス提供年月}
        AND "JukyushaDaicho"."ninteiYukoKikanShuryoYMD" <![CDATA[>=]]> #{サービス提供年月}
        ORDER BY "JukyushaDaicho"."rirekiNo" DESC,
        "JukyushaDaicho"."edaban" DESC
        LIMIT 1
    </sql>

    <sql id="selectShokanShinsei">
        SELECT
        "ShokanShinsei"."serviceTeikyoYM" AS "serviceTeikyoYM",
        "ShokanShinsei"."yokaigo3DankaiHenko" AS "yokaigo3DankaiHenko"
        FROM
        rgdb."DbT3034ShokanShinsei" "ShokanShinsei"
        INNER JOIN
        (<include refid="selectShokanJutakuKaishu" />) AS "T1"
        ON "T1"."hiHokenshaNo" = "ShokanShinsei"."hiHokenshaNo"
        AND "T1"."serviceTeikyoYM" = "ShokanShinsei"."serviceTeikyoYM"
        AND "T1"."seiriNo" = "ShokanShinsei"."seiriNo"
        WHERE
        "ShokanShinsei"."isDeleted" = FALSE
        AND "ShokanShinsei"."hiHokenshaNo" = #{被保険者番号}
        AND "ShokanShinsei"."serviceTeikyoYM" <![CDATA[<]]> #{サービス提供年月}
        ORDER BY "serviceTeikyoYM" ASC
        LIMIT(1)
    </sql>

    <sql id="selectShokanJutakuKaishu">
        SELECT
        "ShokanJutakuKaishu"."hiHokenshaNo" AS "hiHokenshaNo",
        "ShokanJutakuKaishu"."serviceTeikyoYM" AS "serviceTeikyoYM",
        "ShokanJutakuKaishu"."seiriNo" AS "seiriNo"
        FROM
        rgdb."DbT3049ShokanJutakuKaishu" "ShokanJutakuKaishu"
        WHERE 
        "ShokanJutakuKaishu"."isDeleted" = FALSE
        AND SUBSTRING("ShokanJutakuKaishu"."yoshikiNo", 1, 3) = '21D'
        AND "ShokanJutakuKaishu"."hiHokenshaNo" = #{被保険者番号}
        AND "ShokanJutakuKaishu"."serviceTeikyoYM" <![CDATA[<]]> #{サービス提供年月}
        GROUP BY "ShokanJutakuKaishu"."hiHokenshaNo",
        "ShokanJutakuKaishu"."serviceTeikyoYM",
        "ShokanJutakuKaishu"."seiriNo"
    </sql>
</mapper>