<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 概要： 住宅改修費支給申請のマッピング用XMLです。 -->
<!-- @reamsid_L DBC-0992-150 xicongwang -->

<!-- どのマッパーインターフェースと対応するかを指定する -->
<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.jutakukaishusikyushinsei.IJutakukaishuSikyuShinseiMapper">
    <resultMap id="resultMap_JutakukaishuSikyuShinsei"
               type="jp.co.ndensan.reams.db.dbc.entity.db.relate.jutakukaishusikyushinsei.JutakukaishuSikyuShinseiEntity"
               autoMapping="true">
        <id property="hiHokenshaNo" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <id property="serviceTeikyoYM" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <id property="seiriNo" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="jizenSeiriNo" column="jizenSeiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="kaishuShinseiKubun" column="kaishuShinseiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shinseiYMD" column="shinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shinsaYMD" column="shinsaYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shikyuHushikyuKetteiKubun" column="shikyuHushikyuKetteiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="ketteiYMD" column="ketteiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shiharaiKingakuTotal" column="shiharaiKingakuTotal" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
    </resultMap>
    <select id="get住宅改修費支給申請情報"
            resultMap="resultMap_JutakukaishuSikyuShinsei"
            parameterType="java.util.Map" fetchSize="500" resultOrdered="true">
        SELECT
        shinsei."kaishuShinseiKubun",
        shinsei."hiHokenshaNo",
        shinsei."serviceTeikyoYM",
        shinsei."seiriNo",
        shinsei."shinseiYMD",
        shinsei."shinsaYMD",
        shinsei."shiharaiKingakuTotal",
        hanteikekka."ketteiYMD",
        hanteikekka."shikyuHushikyuKetteiKubun",
        jizenshinsei."seiriNo" AS "jizenSeiriNo"
        FROM
        rgdb."DbT3034ShokanShinsei" shinsei
        INNER JOIN
        (SELECT
        kihon."hiHokenshaNo",
        kihon."serviceTeikyoYM",
        kihon."seiriNo"
        FROM
        rgdb."DbT3038ShokanKihon" kihon
        INNER JOIN
        rgdb."DbT3053ShokanShukei" shukei
        ON
        shukei."hiHokenshaNo" = #{hiHokenshaNo}
        AND shukei."serviceTeikyoYM" = kihon."serviceTeikyoYM"
        AND shukei."seiriNo" = kihon."seiriNo"
        AND shukei."jigyoshaNo" = kihon."jigyoshaNo"
        AND shukei."yoshikiNo" = kihon."yoshikiNo"
        AND shukei."meisaiNo" = kihon."meisaiNo"
        AND SUBSTRING(shukei."yoshikiNo",1,3) = '21D'
        INNER JOIN
        rgdb."DbT3049ShokanJutakuKaishu" kaishu
        ON
        kaishu."hiHokenshaNo" = #{hiHokenshaNo}
        AND kaishu."serviceTeikyoYM" = kihon."serviceTeikyoYM"
        AND kaishu."seiriNo" = kihon."seiriNo"
        AND kaishu."jigyoshaNo" = kihon."jigyoshaNo"
        AND kaishu."yoshikiNo" = kihon."yoshikiNo"
        AND kaishu."meisaiNo" = kihon."meisaiNo"
        AND SUBSTRING(kaishu."yoshikiNo",1,3) = '21D'
        WHERE
        kihon."hiHokenshaNo" = #{hiHokenshaNo}
        GROUP BY
        kihon."hiHokenshaNo",
        kihon."serviceTeikyoYM",
        kihon."seiriNo"
        ) AS T1
        ON
        T1."hiHokenshaNo" = shinsei."hiHokenshaNo"
        AND T1."serviceTeikyoYM" = shinsei."serviceTeikyoYM"
        AND T1."seiriNo" = shinsei."seiriNo"
        LEFT JOIN
        rgdb."DbT3036ShokanHanteiKekka" hanteikekka
        ON
        hanteikekka."hiHokenshaNo"= shinsei."hiHokenshaNo"
        AND hanteikekka."serviceTeikyoYM"= shinsei."serviceTeikyoYM"
        AND hanteikekka."seiriNo"= shinsei."seiriNo"
        LEFT JOIN
        rgdb."DbT3035ShokanJutakuKaishuJizenShinsei" jizenshinsei
        ON
        jizenshinsei."hiHokenshaNo"= shinsei."hiHokenshaNo"
        AND jizenshinsei."serviceTeikyoYM"= shinsei."serviceTeikyoYM"
        AND jizenshinsei."seiriNo"= shinsei."seiriNo"
        WHERE
        shinsei."hiHokenshaNo"  = #{hiHokenshaNo}
    </select>

    <resultMap id="resultMap_ShokanJutakukaishuSikyuShinsei"
               type="jp.co.ndensan.reams.db.dbc.entity.db.relate.jutakukaishusikyushinsei.JutakukaishuSikyuShinseiEntity"
               autoMapping="true">
        <result property="kaishuShinseiKubun" column="kaishushinseiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="hiHokenshaNo" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="serviceTeikyoYM" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="seiriNo" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shinseiYMD" column="shinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shiharaiKingakuTotal" column="shiharaiKingakuTotal" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
    </resultMap>
    <select id="get住宅改修費事前申請情報"
            resultMap="resultMap_ShokanJutakukaishuSikyuShinsei"
            parameterType="java.util.Map" fetchSize="500" resultOrdered="true">
        SELECT
        jizenshinsei."kaishushinseiKubun",
        jizenshinsei."hiHokenshaNo",
        jizenshinsei."serviceTeikyoYM",
        jizenshinsei."seiriNo",
        jizenshinsei."shinseiYMD",
        jizenshinsei."kyufugakuHiyogakuTotal" AS "shiharaiKingakuTotal"
        FROM
        rgdb."DbT3035ShokanJutakuKaishuJizenShinsei" jizenshinsei
        INNER JOIN
        (SELECT
        kaishu."hiHokenshaNo",
        kaishu."serviceTeikyoYM",
        kaishu."seiriNo"
        FROM
        rgdb."DbT3049ShokanJutakuKaishu" kaishu
        WHERE
        kaishu."hiHokenshaNo" = #{hiHokenshaNo}
        AND SUBSTRING(kaishu."yoshikiNo",1,3) = '21D'
        GROUP BY
        kaishu."hiHokenshaNo",
        kaishu."serviceTeikyoYM",
        kaishu."seiriNo"
        ) AS Jutakukaishu
        ON
        Jutakukaishu."hiHokenshaNo" = jizenshinsei."hiHokenshaNo"
        AND Jutakukaishu."serviceTeikyoYM" = jizenshinsei."serviceTeikyoYM"
        AND Jutakukaishu."seiriNo" = jizenshinsei."seiriNo"
        WHERE
        jizenshinsei."hiHokenshaNo" = #{hiHokenshaNo}
        AND
        NOT EXISTS
        (
           SELECT *
           FROM
             rgdb."DbT3034ShokanShinsei" shinsei
           WHERE
             shinsei."hiHokenshaNo" = jizenshinsei."hiHokenshaNo"
             AND shinsei."jizenServiceTeikyoYM" = jizenshinsei."serviceTeikyoYM"
             AND shinsei."jizenSeiriNo" = jizenshinsei."seiriNo"
        )
    </select>

    <resultMap id="resultMap_JutakukaishuJizenShinsei"
               type="jp.co.ndensan.reams.db.dbc.entity.db.relate.jutakukaishusikyushinsei.JutakukaishuJizenShinseiEntity"
               autoMapping="true">
        <result property="kaishuShinseiKubun" column="kaishushinseiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="hiHokenshaNo" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="serviceTeikyoYM" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="seiriNo" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shinseiYMD" column="shinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="shiharaiKingakuTotal" column="shiharaiKingakuTotal" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
    </resultMap>
    <select id="get事前申請一覧"
            resultMap="resultMap_JutakukaishuJizenShinsei"
            parameterType="java.util.Map" fetchSize="500" resultOrdered="true">
        SELECT
        jizenshinsei."kaishushinseiKubun",
        jizenshinsei."hiHokenshaNo",
        jizenshinsei."serviceTeikyoYM",
        jizenshinsei."seiriNo",
        jizenshinsei."shinseiYMD",
        jizenshinsei."kyufugakuHiyogakuTotal" AS "shiharaiKingakuTotal"
        FROM
        rgdb."DbT3035ShokanJutakuKaishuJizenShinsei" jizenshinsei
        INNER JOIN
        (SELECT
        kaishu."hiHokenshaNo",
        kaishu."serviceTeikyoYM",
        kaishu."seiriNo"
        FROM
        rgdb."DbT3049ShokanJutakuKaishu" kaishu
        WHERE
        kaishu."hiHokenshaNo" = #{hiHokenshaNo}
        AND SUBSTRING(kaishu."yoshikiNo",1,3) = '21D'
        GROUP BY
        kaishu."hiHokenshaNo",
        kaishu."serviceTeikyoYM",
        kaishu."seiriNo"
        ) AS Jutakukaishu
        ON
        Jutakukaishu."hiHokenshaNo" = jizenshinsei."hiHokenshaNo"
        AND Jutakukaishu."serviceTeikyoYM" = jizenshinsei."serviceTeikyoYM"
        AND Jutakukaishu."seiriNo" = jizenshinsei."seiriNo"
        WHERE
        jizenshinsei."hiHokenshaNo" = #{hiHokenshaNo}
    </select>

    <select id="get償還払支給申請"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.jutakukaishusikyushinsei.JutakukaishuSikyuShinseiKey"
            resultType="jp.co.ndensan.reams.db.dbd.entity.db.basic.DbT3034ShokanShinseiEntity"  fetchSize="500" resultOrdered="true">
        SELECT *
        FROM rgdb."DbT3034ShokanShinsei" AS "a"
        LEFT JOIN
        rgdb."DbT3035ShokanJutakuKaishuJizenShinsei" AS "b"
        ON
        b."hiHokenshaNo" = a."hiHokenshaNo"
        AND b."serviceTeikyoYM" = a."serviceTeikyoYM"
        AND b."seiriNo" = a."seiriNo"
        WHERE
        a."hiHokenshaNo" = #{被保険者番号}
        AND a."serviceTeikyoYM" = #{サービス提供年月}
        AND a."seiriNo" = #{整理番号}
        ORDER BY
        a."serviceTeikyoYM" DESC
    </select>
</mapper>