<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--  -->

<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.shokanshinseiichiran.ShokanShinseiIchiranMapper">
                    
    <resultMap id="ShokanShinseiIchiranRelateEntity" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.shokanshinseiichiran.ShokanShinseiIchiranRelateEntity">
        <result property="hiHokenshaNo" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="serviceTeikyoYM" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="seiriNo" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="yoshikiNo" column="yoshikiNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="shinseiYMD" column="shinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="sofuYM" column="sofuYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="ketteiYMD" column="ketteiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="seiriNp" column="seiriNp" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        
    </resultMap>
    <select id="shokanShinseiListSyokai"
    resultMap="ShokanShinseiIchiranRelateEntity"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.shokanshinseiichiran.ShokanShinseiIchiranParameter" fetchSize="500">
    SELECT
       shokanShinsei."hiHokenshaNo" AS "hiHokenshaNo",
       shokanShinsei."serviceTeikyoYM" AS "serviceTeikyoYM",
       shokanShinsei."seiriNo" AS "seiriNo",
       T1."yoshikiNo" AS "yoshikiNo",
       shokanShinsei."shinseiYMD" AS "shinseiYMD",
       shokanShinsei."sofuYM" AS "sofuYM",
       T2."ketteiYMD" AS "ketteiYMD"
    FROM
       rgdb."DbT3034ShokanShinsei" AS shokanShinsei
    INNER JOIN
        (
        SELECT
        shokanKihon."hiHokenshaNo" AS "hiHokenshaNo",
        shokanKihon."serviceTeikyoYM" AS "serviceTeikyoYM",
        shokanKihon."seiriNp" AS "seiriNp",
        shokanKihon."yoshikiNo" AS "yoshikiNo"
        FROM
            rgdb."DbT3038ShokanKihon" AS shokanKihon
        WHERE
            shokanKihon."hiHokenshaNo" = #{被保険者番号} AND
            shokanKihon."serviceTeikyoYM" <![CDATA[>=]]> #{サービス提供年月From} AND
            shokanKihon."serviceTeikyoYM" <![CDATA[<=]]> #{サービス提供年月To}
        GROUP BY
            shokanKihon."hiHokenshaNo",
            shokanKihon."serviceTeikyoYM",
            shokanKihon."seiriNp",
            shokanKihon."yoshikiNo"
        )AS T1
        ON
        T1."hiHokenshaNo" = shokanShinsei."hiHokenshaNo" AND
        T1."serviceTeikyoYM" = shokanShinsei."serviceTeikyoYM" AND
        t1."seiriNp" = shokanShinsei."seiriNo"
        LEFT JOIN
        (
        SELECT
            shokanHanteiKekka."hiHokenshaNo" AS "hiHokenshaNo",
            shokanHanteiKekka."serviceTeikyoYM" AS "serviceTeikyoYM",
            shokanHanteiKekka."seiriNo" AS "seiriNo",
            shokanHanteiKekka."ketteiYMD" AS "ketteiYMD"
        FROM
            rgdb."DbT3036ShokanHanteiKekka" AS shokanHanteiKekka
        WHERE
            shokanHanteiKekka."hiHokenshaNo" = #{被保険者番号} AND
            shokanHanteiKekka."serviceTeikyoYM" <![CDATA[>=]]> #{サービス提供年月From} AND
            shokanHanteiKekka."serviceTeikyoYM" <![CDATA[<=]]> #{サービス提供年月To}
        )AS T2
        ON
        T2."hiHokenshaNo" = shokanShinsei."hiHokenshaNo" AND
        T2."serviceTeikyoYM" = shokanShinsei."serviceTeikyoYM" AND
        T2."seiriNo" = shokanShinsei."seiriNo"
    WHERE
        shokanShinsei."hiHokenshaNo" = #{被保険者番号} AND
        shokanShinsei."serviceTeikyoYM" <![CDATA[>=]]> #{サービス提供年月From} AND
        shokanShinsei."serviceTeikyoYM" <![CDATA[<=]]> #{サービス提供年月To}
        order by
         shokanShinsei."hiHokenshaNo" DESC,
         shokanShinsei."seiriNo" DESC
    </select>
    <select id="shokanShinseiListShinsei"
            resultMap="ShokanShinseiIchiranRelateEntity"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.shokanshinseiichiran.ShokanShinseiIchiranParameter" fetchSize="500">
            
        SELECT
       shokanShinsei."hiHokenshaNo" AS "hiHokenshaNo",
       shokanShinsei."serviceTeikyoYM" AS "serviceTeikyoYM",
       shokanShinsei."seiriNo" AS "seiriNo",
       T1."yoshikiNo" AS "yoshikiNo",
       shokanShinsei."shinseiYMD" AS "shinseiYMD",
       shokanShinsei."sofuYM" AS "sofuYM",
       T2."ketteiYMD" AS "ketteiYMD"
        FROM
        rgdb."DbT3034ShokanShinsei" AS shokanShinsei
        INNER JOIN
        (
        SELECT
        shokanKihon."hiHokenshaNo" AS "hiHokenshaNo",
        shokanKihon."serviceTeikyoYM" AS "serviceTeikyoYM",
        shokanKihon."seiriNp" AS "seiriNp",
        shokanKihon."yoshikiNo" AS "yoshikiNo"
        FROM
            rgdb."DbT3038ShokanKihon" AS shokanKihon 
        WHERE
            shokanKihon."hiHokenshaNo" = #{被保険者番号} AND
            shokanKihon."serviceTeikyoYM" <![CDATA[>=]]> #{サービス提供年月From} AND
            shokanKihon."serviceTeikyoYM" <![CDATA[<=]]> #{サービス提供年月To} AND
            substring('yoshikiNo',1,3) <![CDATA[<>]]> '21C' AND
            substring('yoshikiNo',1,3) <![CDATA[<>]]> '21D'
        GROUP BY
        shokanKihon."hiHokenshaNo",
        shokanKihon."serviceTeikyoYM",
        shokanKihon."seiriNp",
        shokanKihon."yoshikiNo"
        )AS T1
        ON
        T1."hiHokenshaNo" = shokanShinsei."hiHokenshaNo" AND
        T1."serviceTeikyoYM" = shokanShinsei."serviceTeikyoYM" AND
        t1."seiriNp" = shokanShinsei."seiriNo"
        LEFT JOIN
        (
        SELECT
            shokanHanteiKekka."hiHokenshaNo" AS "hiHokenshaNo",
            shokanHanteiKekka."serviceTeikyoYM" AS "serviceTeikyoYM",
            shokanHanteiKekka."seiriNo" AS "seiriNo",
            shokanHanteiKekka."ketteiYMD" AS "ketteiYMD"
        FROM
            rgdb."DbT3036ShokanHanteiKekka" AS shokanHanteiKekka
        WHERE
            shokanHanteiKekka."hiHokenshaNo" = #{被保険者番号} AND
            shokanHanteiKekka."serviceTeikyoYM" <![CDATA[>=]]> #{サービス提供年月From} AND
            shokanHanteiKekka."serviceTeikyoYM" <![CDATA[<=]]> #{サービス提供年月To}
        )AS T2
        ON
        T2."hiHokenshaNo" = shokanShinsei."hiHokenshaNo" AND
        T2."serviceTeikyoYM" = shokanShinsei."serviceTeikyoYM" AND
        T2."seiriNo" = shokanShinsei."seiriNo"
        WHERE
        shokanShinsei."hiHokenshaNo" = #{被保険者番号} AND
        shokanShinsei."serviceTeikyoYM" <![CDATA[>=]]> #{サービス提供年月From} AND
        shokanShinsei."serviceTeikyoYM" <![CDATA[<=]]> #{サービス提供年月To}
        ORDER BY
        shokanShinsei."hiHokenshaNo" DESC,
        shokanShinsei."seiriNo" DESC
    </select>
    <select id="shokanShinseiCount"
            resultType="java.lang.Integer"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.shokanshinseiichiran.ShokanShinseiIchiranParameterCount" fetchSize="500">
        SELECT
        count(0)
        FROM
        rgdb."DbT3034ShokanShinsei" AS ShokanShinsei
        INNER JOIN
        (
        SELECT
        ShokanKihon."hiHokenshaNo" AS "hiHokenshaNo",
        ShokanKihon."serviceTeikyoYM" AS "serviceTeikyoYM",
        ShokanKihon."seiriNp" AS "seiriNp"
        FROM
        rgdb."DbT3038ShokanKihon" AS ShokanKihon
        WHERE
        shokanKihon."hiHokenshaNo" = #{被保険者番号} AND
        shokanKihon."serviceTeikyoYM" = #{サービス年月} AND
        substring('shokanKihon.yoshikiNo',1,3) <![CDATA[<>]]> '21C' AND
        substring('shokanKihon.yoshikiNo',1,3) <![CDATA[<>]]> '21D'
        ORDER BY
        ShokanKihon."hiHokenshaNo",
        ShokanKihon."serviceTeikyoYM",
        ShokanKihon."seiriNp"
        ) T1
        ON
        T1."hiHokenshaNo" = ShokanShinsei."hiHokenshaNo"AND
        T1."serviceTeikyoYM" = ShokanShinsei."serviceTeikyoYM" AND
        T1."seiriNp" = ShokanShinsei."seiriNo"
        WHERE
        ShokanShinsei."hiHokenshaNo" = #{被保険者番号} AND
        ShokanShinsei."serviceTeikyoYM" = #{サービス年月}
    </select>
</mapper>