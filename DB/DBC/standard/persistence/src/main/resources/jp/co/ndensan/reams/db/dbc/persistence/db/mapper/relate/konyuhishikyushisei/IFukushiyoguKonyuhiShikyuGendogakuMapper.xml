<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @reamsid_L DBC-1020-040 zhangrui -->

<mapper namespace="jp.co.ndensan.reams.db.dbc.persistence.db.mapper.relate.konyuhishikyushisei.IFukushiyoguKonyuhiShikyuGendogakuMapper">
    <select id="select支給申請一覧"
            resultMap="Result_ShikyuShinseiList"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.fukushiyogukonyuhishikyushisei.ShokanShikyuShinseiParameter" fetchSize="500" resultOrdered="true">
    SELECT														
        ShokanKihon."hiHokenshaNo" AS "hiHokenshaNo",														
        ShokanKihon."serviceTeikyoYM" AS "serviceTeikyoYM",														
        ShokanKihon."seiriNo" AS "seiriNo",														
        ShokanKihon."jigyoshaNo" AS "jigyoshaNo",														
        ShokanKihon."yoshikiNo" AS "yoshikiNo",														
        ShokanKihon."meisaiNo" AS "meisaiNo",														
        ShokanShinsei."shinseiYMD" AS "shinseiYMD",														
        ShokanHanteiKekka."ketteiYMD" AS "ketteiYMD",														
        ShokanHanteiKekka."shikyuHushikyuKetteiKubun" AS "shikyuHushikyuKetteiKubun",														
        ShokanShinsei."hokenTaishoHiyogaku" AS "hokenTaishoHiyogaku",														
        FukushiYogu."fukushiYoguShohinName" AS "fukushiYoguShohinName"														
    FROM														
        rgdb."DbT3038ShokanKihon" AS ShokanKihon														
        LEFT JOIN														
            rgdb."DbT3036ShokanHanteiKekka" AS ShokanHanteiKekka ON														
            ShokanKihon."hiHokenshaNo" = ShokanHanteiKekka."hiHokenshaNo" AND														
            ShokanKihon."serviceTeikyoYM" = ShokanHanteiKekka."serviceTeikyoYM" AND														
            ShokanKihon."seiriNo" = ShokanHanteiKekka."seiriNo"														
        LEFT JOIN														
            rgdb."DbT3034ShokanShinsei" AS ShokanShinsei ON														
            ShokanKihon."hiHokenshaNo" = ShokanShinsei."hiHokenshaNo" AND														
            ShokanKihon."serviceTeikyoYM" = ShokanShinsei."serviceTeikyoYM" AND														
            ShokanKihon."seiriNo" = ShokanShinsei."seiriNo"														
        LEFT JOIN														
        (														
        SELECT														
            "hiHokenshaNo",														
            "serviceTeikyoYM",														
            "seiriNo",														
            "yoshikiNo",														
            "meisaiNo",														
            "fukushiYoguShohinName"														
        FROM														
            rgdb."DbT3048ShokanFukushiYoguHanbaihi" AS f														
        WHERE														
            (f."jigyoshaNo", f."renban") = (														
          SELECT														
            "jigyoshaNo",														
            "renban"														
          FROM														
            rgdb."DbT3048ShokanFukushiYoguHanbaihi" f2														
          WHERE														
            f2."hiHokenshaNo" = f."hiHokenshaNo" AND														
            f2."serviceTeikyoYM" = f."serviceTeikyoYM" AND														
            f2."seiriNo" = f."seiriNo" AND														
            f2."yoshikiNo" = f."yoshikiNo" AND														
            f2."meisaiNo" = f."meisaiNo"														
          ORDER BY														
            f2."jigyoshaNo",														
            f2."renban" LIMIT 1														
         )														
        ) AS FukushiYogu ON														
        ShokanKihon."hiHokenshaNo" = FukushiYogu."hiHokenshaNo" AND														
        ShokanKihon."serviceTeikyoYM" = FukushiYogu."serviceTeikyoYM" AND														
        ShokanKihon."seiriNo" = FukushiYogu."seiriNo" AND														
        ShokanKihon."yoshikiNo" = FukushiYogu."yoshikiNo" AND														
        ShokanKihon."meisaiNo" = FukushiYogu."meisaiNo"														
    WHERE														
        ShokanKihon."hiHokenshaNo" = #{被保険者番号} AND														
        SUBSTR(ShokanKihon."yoshikiNo", 1, 3) = SUBSTR(FukushiYogu."yoshikiNo", 1, 3) 														
    ORDER BY
        "serviceTeikyoYM" ASC,
        "seiriNo" ASC,
        "jigyoshaNo" ASC
    </select>
        
    <resultMap id="Result_ShikyuShinseiList" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.fukushiyogukonyuhishikyushisei.FukushiyouguKonyuhiShikyuShinsei" autoMapping="true">
        <result property="被保険者番号" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.HihokenshaNoTypeHandler"/>
        <result property="サービス提供年月" column="serviceTeikyoYM" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleYearMonthTypeHandler"/>
        <result property="整理番号" column="seiriNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="事業者番号" column="jigyoshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.JigyoshaNoTypeHandler"/>
        <result property="様式番号" column="yoshikiNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="明細番号" column="meisaiNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="申請年月日" column="shinseiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="支給_不支給決定区分" column="shikyuHushikyuKetteiKubun" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="決定日" column="ketteiYMD" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.FlexibleDateTypeHandler"/>
        <result property="商品名" column="fukushiYoguShohinName" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
        <result property="保険対象費用額" column="hokenTaishoHiyogaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
    </resultMap>
    
    <select id="select要介護認定状態区分コード"
            resultMap="Result_yokaigoJotaiKubunCode"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.fukushiyogukonyuhishikyushisei.ServiceShuruiCodeParameter" fetchSize="500" resultOrdered="true">
        SELECT
        JukyushaDaicho."yokaigoJotaiKubunCode" AS "yokaigoJotaiKubunCode",
        JukyushaDaicho."kyuSochishaFlag" AS "kyuSochishaFlag"
        FROM
        rgdb."DbT4001JukyushaDaicho" AS JukyushaDaicho
        WHERE
        JukyushaDaicho."hihokenshaNo" = #{被保険者番号}
        AND
        SUBSTRING(JukyushaDaicho."ninteiYukoKikanKaishiYMD", 1, 6) <![CDATA[<=]]> #{サービス提供年月}
        AND
        SUBSTRING(JukyushaDaicho."ninteiYukoKikanShuryoYMD", 1, 6) <![CDATA[>=]]> #{サービス提供年月}
        AND
        JukyushaDaicho."logicalDeletedFlag" <![CDATA[<>]]> true
        ORDER BY
        JukyushaDaicho."rirekiNo" DESC,
        JukyushaDaicho."edaban" DESC
        LIMIT 1
    </select>
     <resultMap id="Result_yokaigoJotaiKubunCode" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.fukushiyogukonyuhishikyushisei.YokaigoJotaiTokyuSochishaKubunCode" autoMapping="true">
            <result property="yokaigoJotaiKubunCode" column="yokaigoJotaiKubunCode" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.CodeTypeHandler"/>
            <result property="kyuSochishaFlag" column="kyuSochishaFlag"/>
    </resultMap>
    
    <select id="select措置元市町村データ"
            resultMap="Result_Shichoson"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.fukushiyogukonyuhishikyushisei.ServiceShuruiCodeParameter" fetchSize="500" resultOrdered="true">
        SELECT
        KoseiShichosonMaster."shoKisaiHokenshaNo",
        KoseiShichosonMaster."shichosonMeisho"
        FROM
        rgdb."DbT1001HihokenshaDaicho" AS HihokenshaDaicho
        LEFT JOIN 
        rgdb."DbT5051KoseiShichosonMaster" AS KoseiShichosonMaster
        ON
        HihokenshaDaicho."koikinaiTokureiSochimotoShichosonCode" = KoseiShichosonMaster."shichosonCode"
        AND
        KoseiShichosonMaster."gappeiKyuShichosonKubun" = '0'
        WHERE
        HihokenshaDaicho."hihokenshaNo" = #{被保険者番号}
        AND
        HihokenshaDaicho."idoYMD" <![CDATA[<=]]> #{サービス提供年月}
        AND
        HihokenshaDaicho."logicalDeletedFlag" <![CDATA[<>]]> true
        AND
        KoseiShichosonMaster."isDeleted" <![CDATA[<>]]> true
        ORDER BY
        HihokenshaDaicho."idoYMD" DESC
    </select>
    <resultMap id="Result_Shichoson" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.fukushiyogukonyuhishikyushisei.ShichosonEntity" autoMapping="true">
        <result property="証記載保険者番号" column="hiHokenshaNo" typeHandler="jp.co.ndensan.reams.db.dbx.entity.typehandlers.ShoKisaiHokenshaNoTypeHandler"/>
        <result property="市町村名称" column="jigyoshaNo" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.RStringTypeHandler"/>
    </resultMap>
    
    <select id="select支払結果情報"
            resultMap="Result_ShibaraiKekka"
            parameterType="jp.co.ndensan.reams.db.dbc.definition.mybatisprm.fukushiyogukonyuhishikyushisei.ShibaraiKekkaParameter" fetchSize="500" resultOrdered="true">
        SELECT
        SUM(ShokanShinsei."shiharaiKingakuTotal") AS "shiharaiKingakuTotal",
        SUM(ShokanShinsei."hokenTaishoHiyogaku") AS "hokenTaishoHiyogaku",
        SUM(ShokanShinsei."hokenKyufugaku") AS "hokenKyufugaku",
        SUM(ShokanShinsei."riyoshaFutangaku") AS "riyoshaFutangaku"
        FROM
        rgdb."DbT3034ShokanShinsei" AS ShokanShinsei,
        (
        SELECT
        ShokanKihon."hiHokenshaNo",
        ShokanKihon."serviceTeikyoYM",
        ShokanKihon."seiriNo"
        FROM
        rgdb."DbT3038ShokanKihon" AS ShokanKihon
        WHERE
        ShokanKihon."hiHokenshaNo" = #{被保険者番号}
        AND
            (CASE WHEN
                cast(SUBSTR(ShokanKihon."serviceTeikyoYM", 5, 2) as int) <![CDATA[<=]]> cast('03' as int)
            THEN
                cast(SUBSTR(ShokanKihon."serviceTeikyoYM", 1, 4) as int) - 1
            ELSE
                cast(SUBSTR(ShokanKihon."serviceTeikyoYM", 1, 4) as int)
            END)
            =
            (CASE WHEN
                cast(SUBSTR(#{サービス提供年月}, 5, 2) as int) <![CDATA[<=]]> cast('03' as int)
            THEN
                cast(SUBSTR(#{サービス提供年月}, 1, 4) as int) - 1
            ELSE
                cast(SUBSTR(#{サービス提供年月}, 1, 4) as int)
            END)
        AND
        SUBSTR(ShokanKihon."yoshikiNo", 1, 3) = #{福祉用具販売費}
        ) AS TEMPA
        WHERE
        ShokanShinsei."hiHokenshaNo" = TEMPA."hiHokenshaNo"
        AND ShokanShinsei."serviceTeikyoYM" = TEMPA."serviceTeikyoYM"
        AND ShokanShinsei."seiriNo" = TEMPA."seiriNo"
    </select>
        
    <resultMap id="Result_ShibaraiKekka" type="jp.co.ndensan.reams.db.dbc.entity.db.relate.fukushiyogukonyuhishikyushisei.SokanbaraiShiharaiKekka" autoMapping="true">
        <result property="費用額合計" column="shiharaiKingakuTotal" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="保険対象費用額" column="hokenTaishoHiyogaku" typeHandler="jp.co.ndensan.reams.uz.uza.util.db.typehandlers.DecimalTypeHandler"/>
        <result property="保険給付額" column="hokenKyufugaku"/>
        <result property="利用者負担額" column="riyoshaFutangaku"/>
    </resultMap>
</mapper>